<section class="py-8 max-w-2xl mx-auto fadein">
  <div class="flex items-center gap-4 mb-6">
    <div class="w-14 h-14 bg-gradient-to-br from-indigo-100 to-purple-200 rounded-full flex items-center justify-center">
      <i class="fas fa-comments text-purple-700 text-3xl"></i>
    </div>
    <div>
      <h2 class="text-3xl font-bold mb-1">Chat con tu Psicólogo Virtual</h2>
      <p class="text-gray-600">Recibe orientación profesional simulando una conversación real de psicoterapia.</p>
    </div>
  </div>
  <div class="bg-white rounded-3xl shadow p-6 mb-6">
    <div id="chat-window" class="mb-4 max-h-96 overflow-y-auto">
      <!-- Aquí aparecen los mensajes del chat -->
    </div>
    <form id="chat-form" class="flex gap-2" autocomplete="off">
      <input type="text" id="chat-input" class="border rounded p-2 flex-1" placeholder="Escribe aquí tu mensaje..." required maxlength="180"/>
      <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded shadow">Enviar</button>
    </form>
  </div>
</section>
<script>
  // Técnicas por trastorno, puedes ampliar/modificar
  const techniques = {
    ansiedad: [
      "Respiración profunda y consciente",
      "Reestructuración cognitiva para identificar pensamientos irracionales",
      "Exposición gradual a situaciones temidas",
      "Mindfulness (atención plena)"
    ],
    depresion: [
      "Activación conductual (hacer actividades placenteras)",
      "Diario de gratitud",
      "Reestructuración cognitiva de pensamientos negativos",
      "Técnicas de autocompasión"
    ],
    trauma: [
      "Técnicas de grounding (anclaje al presente)",
      "Visualización de lugar seguro",
      "EMDR (Desensibilización y Reprocesamiento por Movimientos Oculares)",
      "Narración controlada de la experiencia"
    ],
    adicciones: [
      "Identificación de desencadenantes",
      "Planificación de alternativas saludables",
      "Técnicas de control de impulsos",
      "Apoyo en grupos de pares"
    ],
    toc: [
      "Exposición y prevención de respuesta (ERP)",
      "Registro y análisis de obsesiones/compulsiones",
      "Reestructuración cognitiva",
      "Mindfulness para aceptar pensamientos sin reaccionar"
    ],
    bipolaridad: [
      "Monitoreo de estado de ánimo",
      "Rutinas estables de sueño",
      "Psicoeducación sobre síntomas",
      "Técnicas de regulación emocional"
    ]
    // Puedes agregar más áreas
  };

  // Chat state
  let chatHistory = [
    {author: "psicologo", text: "¡Hola! Soy tu psicólogo virtual. ¿Sobre qué tema te gustaría conversar hoy? Ejemplo: ansiedad, depresión, trauma, adicciones, TOC, bipolaridad."}
  ];

  // Render chat
  function renderChat() {
    const chatDiv = document.getElementById('chat-window');
    chatDiv.innerHTML = chatHistory.map(msg =>
      `<div class="mb-2 flex ${msg.author === 'user' ? 'justify-end' : 'justify-start'}">
        <div class="${msg.author === 'user' ? 'bg-indigo-100 text-indigo-800' : 'bg-purple-50 text-purple-800'} rounded-xl p-3 max-w-[80%] shadow">
          ${msg.text}
        </div>
      </div>`
    ).join('');
    chatDiv.scrollTop = chatDiv.scrollHeight;
  }

  // Analiza mensaje y responde
  function getPsychologistReply(userMsg) {
    userMsg = userMsg.toLowerCase();
    let area = "";
    ["ansiedad","depresion","trauma","adicciones","toc","bipolaridad"].forEach(k=>{
      if(userMsg.includes(k)) area = k;
    });

    if(area) {
      let reply = `Gracias por compartir que quieres hablar sobre <b>${area}</b>.<br>`;
      reply += `¿Cómo te has sentido últimamente con respecto a este tema? ¿Podrías describir una situación reciente?`;
      reply += `<br><br><b>Técnicas recomendadas para ${area}:</b><ul>`;
      techniques[area].forEach(t=>reply+=`<li>${t}</li>`);
      reply += `</ul>`;
      return reply;
    }

    // Si ya se mencionó un área antes, sugiere técnicas específicas
    if(chatHistory.some(m=>m.text.toLowerCase().includes("ansiedad"))) area = "ansiedad";
    if(chatHistory.some(m=>m.text.toLowerCase().includes("depresion"))) area = "depresion";
    if(chatHistory.some(m=>m.text.toLowerCase().includes("trauma"))) area = "trauma";
    if(chatHistory.some(m=>m.text.toLowerCase().includes("adicciones"))) area = "adicciones";
    if(chatHistory.some(m=>m.text.toLowerCase().includes("toc"))) area = "toc";
    if(chatHistory.some(m=>m.text.toLowerCase().includes("bipolaridad"))) area = "bipolaridad";

    // Respuestas según área y palabras clave
    if(area) {
      if(userMsg.includes("estresado") || userMsg.includes("ansioso") || userMsg.includes("ansiedad")) {
        return `Entiendo que la ansiedad puede ser muy incómoda. ¿Te gustaría intentar una técnica de ${techniques.ansiedad[0]} ahora? <br><button onclick="location.hash='#/ejercicio/respiracion'" class="bg-indigo-600 text-white px-2 py-1 rounded">Ejercicio guiado</button>`;
      }
      if(userMsg.includes("triste") || userMsg.includes("desanimado") || userMsg.includes("depresion")) {
        return `La tristeza y la depresión son emociones válidas. ¿Te gustaría escribir una autoafirmación? <br><button onclick="location.hash='#/ejercicio/autoafirmacion'" class="bg-yellow-600 text-white px-2 py-1 rounded">Ejercicio guiado</button>`;
      }
      if(userMsg.includes("miedo") || userMsg.includes("trauma")) {
        return `El miedo y el trauma pueden trabajarse con <b>técnicas de grounding</b>. ¿Te gustaría hacer una visualización de lugar seguro? <br><button onclick="location.hash='#/ejercicio/visualizacion'" class="bg-green-600 text-white px-2 py-1 rounded">Ejercicio guiado</button>`;
      }
      if(userMsg.includes("impulso") || userMsg.includes("adiccion")) {
        return `Para las adicciones, identificar desencadenantes es útil. ¿Quieres hacer una lista de alternativas saludables?`;
      }
      if(userMsg.includes("obsesion") || userMsg.includes("compulsion") || userMsg.includes("toc")) {
        return `¿Te gustaría probar la técnica de <b>prevención de respuesta</b>? Es muy eficaz para el TOC.`;
      }
      if(userMsg.includes("bipolaridad") || userMsg.includes("cambio de ánimo")) {
        return `¿Has notado cambios recientes en tu estado de ánimo? Monitorear tus emociones a diario ayuda mucho.`;
      }
      // Respuesta genérica si no hay palabra clave
      return `Cuéntame un poco más sobre lo que estás sintiendo. Juntos podemos buscar técnicas útiles.`;
    }

    // Si no detecta área, responde general
    return `¿Puedes contarme más sobre cómo te has sentido o qué te gustaría trabajar hoy?`;
  }

  // Enviar mensaje
  document.getElementById('chat-form').onsubmit = function(e) {
    e.preventDefault();
    const input = document.getElementById('chat-input');
    const text = input.value.trim();
    if (!text) return;
    chatHistory.push({author:"user",text:text});
    const reply = getPsychologistReply(text);
    chatHistory.push({author:"psicologo", text: reply});
    renderChat();
    input.value = '';
  };

  // Primer render
  renderChat();
</script>
