<section class="py-8 max-w-2xl mx-auto fadein chatbot-container" id="chatbot-bg">
  <!-- Encabezado -->
  <div class="flex items-center gap-4 mb-8">
    <div class="w-16 h-16 bg-gradient-to-br from-blue-100 via-lavender-100 to-green-100 rounded-full flex items-center justify-center shadow-lg">
      <i class="fas fa-robot text-indigo-600 text-4xl"></i>
    </div>
    <div>
      <h2 class="text-4xl font-extrabold mb-1 text-indigo-900 tracking-tight">Psicoterapia AI</h2>
      <p class="text-lg text-blue-900 opacity-80">Tu psic√≥logo virtual con ejercicios, audioterapia y plan de emergencia.</p>
    </div>
    <button id="toggle-dark" class="ml-auto bg-gradient-to-r from-gray-100 to-gray-300 text-gray-800 px-3 py-1 rounded-xl font-semibold shadow ring-1 ring-gray-200 hover:scale-105 transition-all" title="Modo oscuro autom√°tico">
      <i class="fas fa-moon"></i>
    </button>
  </div>

  <!-- Chatbot Window -->
  <div class="bg-gradient-to-br from-white via-lavender-50 to-blue-50 rounded-3xl shadow-lg p-6 mb-8 border border-blue-100 backdrop-blur-sm chatbot-bubbles">
    <div id="chat-window" class="mb-4 max-h-96 overflow-y-auto transition-all" style="scroll-behavior:smooth;">
      <!-- Mensajes aqu√≠ -->
    </div>
    <form id="chat-form" class="flex gap-2" autocomplete="off">
      <input type="text" id="chat-input" class="border rounded-xl p-3 flex-1 bg-blue-50 text-blue-900 focus:ring-2 focus:ring-blue-300 transition-all" placeholder="Escribe aqu√≠ tu mensaje..." required maxlength="180"/>
      <button type="submit" class="bg-gradient-to-r from-indigo-600 via-blue-400 to-green-400 text-white px-5 py-2 rounded-xl font-semibold shadow hover:scale-105 transition-all">Enviar</button>
    </form>
    <div class="flex flex-wrap gap-2 mt-3">
      <button onclick="setMode('breve')" id="btn-breve" class="bg-blue-100 text-indigo-800 px-3 py-1 rounded-xl font-semibold transition-all ring-1 ring-indigo-200">Breve</button>
      <button onclick="setMode('extendida')" id="btn-extendida" class="bg-lavender-100 text-purple-800 px-3 py-1 rounded-xl font-semibold transition-all ring-1 ring-purple-200">Extendida</button>
      <button onclick="saveChatToJournal()" class="bg-green-200 text-green-900 px-3 py-1 rounded-xl font-semibold transition-all ring-1 ring-green-300">Guardar chat en diario</button>
      <button onclick="showPlanEmergenciaModal()" class="bg-pink-100 text-pink-900 px-3 py-1 rounded-xl font-semibold transition-all ring-1 ring-pink-200">Crear/editar plan de emergencia</button>
    </div>
  </div>

  <!-- Ejercicio guiado sugerido -->
  <div id="ejercicio-sugerido"></div>

  <!-- Audioterapia Futurista -->
  <div class="bg-gradient-to-r from-white via-blue-50 to-green-50 rounded-3xl shadow-lg p-6 mb-8 border border-green-100">
    <h3 class="text-2xl font-bold mb-3 text-green-900">Audioterapia</h3>
    <div class="flex flex-col sm:flex-row gap-3">
      <button onclick="playAudio('relajacion')" class="bg-gradient-to-r from-blue-300 via-green-200 to-lavender-200 text-white px-4 py-2 rounded-xl font-semibold shadow hover:scale-105 transition-all">Relajaci√≥n guiada</button>
      <button onclick="playAudio('mindfulness')" class="bg-gradient-to-r from-purple-300 via-indigo-200 to-blue-200 text-white px-4 py-2 rounded-xl font-semibold shadow hover:scale-105 transition-all">Mindfulness r√°pido</button>
      <button onclick="playAudio('autoafirmacion')" class="bg-gradient-to-r from-green-300 via-pink-200 to-blue-200 text-white px-4 py-2 rounded-xl font-semibold shadow hover:scale-105 transition-all">Autoafirmaci√≥n positiva</button>
      <audio id="audio-player" controls style="display:none;margin-top:1rem;width:100%"></audio>
    </div>
  </div>

  <!-- Modal Plan de Emergencia -->
  <div id="plan-emergencia-modal" class="fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-50" style="display:none;">
    <div class="bg-gradient-to-br from-white via-pink-50 to-blue-50 p-8 rounded-2xl shadow-xl w-full max-w-lg border border-pink-100">
      <h3 class="text-2xl font-extrabold mb-4 text-pink-900">Plan de Emergencia Personal</h3>
      <form id="plan-emergencia-form" class="flex flex-col gap-3">
        <label>
          <span class="font-medium">1. ¬øQu√© se√±ales indican que estoy en crisis?</span>
          <input type="text" name="senales" class="border rounded-xl p-2 w-full bg-blue-50" maxlength="100" required>
        </label>
        <label>
          <span class="font-medium">2. ¬øQu√© puedo hacer para calmarme?</span>
          <input type="text" name="acciones" class="border rounded-xl p-2 w-full bg-green-50" maxlength="100" required>
        </label>
        <label>
          <span class="font-medium">3. ¬øA qu√© persona puedo contactar?</span>
          <input type="text" name="contacto" class="border rounded-xl p-2 w-full bg-lavender-50" maxlength="80" required>
        </label>
        <label>
          <span class="font-medium">4. Recursos o tel√©fonos √∫tiles</span>
          <input type="text" name="recursos" class="border rounded-xl p-2 w-full bg-pink-50" maxlength="100">
        </label>
        <button type="submit" class="bg-gradient-to-r from-pink-400 to-purple-400 text-white px-4 py-2 rounded-xl font-semibold shadow hover:scale-105 transition-all">Guardar plan</button>
        <button type="button" onclick="closePlanEmergenciaModal()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-xl font-semibold shadow">Cancelar</button>
        <button type="button" onclick="exportPlanPDF()" class="bg-gradient-to-r from-indigo-400 to-green-300 text-white px-4 py-2 rounded-xl font-semibold shadow mt-2">Exportar a PDF</button>
      </form>
    </div>
  </div>
  <div id="plan-emergencia-vista" class="bg-gradient-to-r from-pink-50 via-blue-50 to-green-50 rounded-2xl shadow p-6 mb-8 border border-pink-100" style="display:none;">
    <h3 class="text-xl font-bold mb-3 text-pink-900">Mi plan de emergencia</h3>
    <div id="plan-emergencia-content"></div>
    <button onclick="editPlanEmergencia()" class="bg-gradient-to-r from-pink-400 to-purple-300 text-white px-3 py-1 rounded-xl font-semibold shadow mt-2">Editar plan</button>
    <button onclick="exportPlanPDF()" class="bg-gradient-to-r from-indigo-400 to-green-300 text-white px-3 py-1 rounded-xl font-semibold shadow mt-2">Exportar a PDF</button>
  </div>
</section>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
  // Estado emocional para fondo interactivo
  let emotionalBg = 'default'; // ansiedad, depresion, trauma, etc

  // Modo de respuesta
  let replyMode = 'breve';
  function setMode(mode) {
    replyMode = mode;
    document.getElementById('btn-breve').classList.toggle('ring-4', mode==='breve');
    document.getElementById('btn-extendida').classList.toggle('ring-4', mode==='extendida');
    renderChat();
  }

  // Audioterapia audios (puedes cambiar las URLs por las tuyas)
  const audioClips = {
    relajacion: "https://cdn.pixabay.com/audio/2022/07/26/audio_124b5d7b91.mp3",
    mindfulness: "https://cdn.pixabay.com/audio/2023/02/23/audio_128fa7519b.mp3",
    autoafirmacion: "https://cdn.pixabay.com/audio/2022/03/15/audio_115b5a070e.mp3"
  };
  function playAudio(type) {
    const player = document.getElementById('audio-player');
    player.src = audioClips[type];
    player.style.display = 'block';
    player.play();
  }

  // Crisis y t√©cnicas
  const crisisTechniques = {
    ansiedad: {
      breve: "üå± Prueba la respiraci√≥n consciente. Inhala lento por la nariz, exhala lento por la boca. Repite 5 veces.",
      extendida: `üßò‚Äç‚ôÇÔ∏è La respiraci√≥n diafragm√°tica ayuda a calmar el sistema nervioso.<br>Si√©ntate c√≥modo, pon una mano en tu abdomen.<br>Inhala 4 segundos sintiendo que se expande, ret√©n 2 segundos, exhala por la boca en 6 segundos. Repite varias veces.<br>Tambi√©n puedes probar la t√©cnica 5-4-3-2-1: nombra 5 cosas que ves, 4 que puedes tocar, 3 que escuchas, 2 que hueles, 1 que saboreas.`,
      ejercicio: `<button onclick="ejercicioAnsiedad()" class="bg-gradient-to-r from-indigo-400 to-green-300 text-white px-3 py-1 rounded-xl font-semibold shadow">Ejercicio guiado</button>`
    },
    depresion: {
      breve: "üå∏ Haz la t√©cnica de 3 cosas buenas: escribe tres cosas positivas de hoy.",
      extendida: `üí° La activaci√≥n conductual ayuda a salir de la inactividad.<br>Haz una acci√≥n peque√±a: d√∫chate, camina, llama a alguien.<br>Luego, escribe tres cosas buenas de hoy.<br>Practica reestructuraci√≥n cognitiva: detecta un pensamiento negativo y busca una interpretaci√≥n alternativa.<br>Usa autoafirmaciones: ‚ÄúTengo valor‚Äù, ‚ÄúEste momento no define mi vida‚Äù.`,
      ejercicio: `<button onclick="ejercicioDepresion()" class="bg-gradient-to-r from-yellow-300 to-pink-300 text-white px-3 py-1 rounded-xl font-semibold shadow">Ejercicio guiado</button>`
    },
    trauma: {
      breve: "ü™¥ Grounding: toca un objeto, siente tus pies, nombra colores a tu alrededor.",
      extendida: `üå≥ Las t√©cnicas de grounding ayudan a volver al presente.<br>Prueba: siente la textura de un objeto, nota la temperatura de tus manos, nombra los colores que ves.<br>Visualiza un lugar seguro y respira lento.<br>Si tienes flashbacks, repite: ‚ÄúEstoy seguro aqu√≠ y ahora‚Äù.`,
      ejercicio: `<button onclick="ejercicioTrauma()" class="bg-gradient-to-r from-green-400 to-blue-300 text-white px-3 py-1 rounded-xl font-semibold shadow">Ejercicio guiado</button>`
    },
    adicciones: {
      breve: "üíß Distr√°ete: sal de la habitaci√≥n, llama a alguien, escucha m√∫sica.",
      extendida: `üîó Cuando sientas impulso, usa la t√©cnica de tiempo de espera: espera 10 minutos antes de actuar.<br>Identifica el desencadenante.<br>Haz una lista de alternativas saludables: caminar, tomar agua, hablar con alguien.<br>Si es urgente, contacta un profesional o grupo de apoyo.`,
      ejercicio: `<button onclick="ejercicioAdicciones()" class="bg-gradient-to-r from-pink-400 to-green-300 text-white px-3 py-1 rounded-xl font-semibold shadow">Ejercicio guiado</button>`
    },
    toc: {
      breve: "üåÄ Retrasa la compulsi√≥n 1 minuto. Repite: ‚ÄúEs solo un pensamiento‚Äù.",
      extendida: `üß© La Exposici√≥n y Prevenci√≥n de Respuesta (ERP) es √∫til:<br>Exp√≥nte al pensamiento sin hacer la compulsi√≥n por 1 minuto, luego 2, y as√≠ sucesivamente.<br>Apunta tus obsesiones y la ansiedad asociada.<br>Practica mindfulness para aceptar pensamientos sin reaccionar.`,
      ejercicio: `<button onclick="ejercicioTOC()" class="bg-gradient-to-r from-teal-400 to-blue-400 text-white px-3 py-1 rounded-xl font-semibold shadow">Ejercicio guiado</button>`
    },
    bipolaridad: {
      breve: "‚ö° Registra tu estado de √°nimo y mant√©n rutinas.",
      extendida: `üî¨ Monitorea tu √°nimo cada d√≠a.<br>Mant√©n rutinas de sue√±o y comida.<br>Si notas cambios intensos, contacta a tu profesional.<br>La psicoeducaci√≥n y la regulaci√≥n emocional ayudan a estabilizar.<br>Haz actividades tranquilas y evita est√≠mulos extremos.`,
      ejercicio: `<button onclick="ejercicioBipolaridad()" class="bg-gradient-to-r from-purple-400 to-green-300 text-white px-3 py-1 rounded-xl font-semibold shadow">Ejercicio guiado</button>`
    }
  };

  // Palabras clave asociadas a crisis
  const crisisKeywords = {
    ansiedad: ["ansiedad", "p√°nico", "ataque", "miedo", "estresado"],
    depresion: ["depresi√≥n", "triste", "desanimado", "llorar", "desesperanza", "sin ganas"],
    trauma: ["trauma", "recuerdo", "flashback", "disociar", "miedo intenso", "temblor", "abuso"],
    adicciones: ["adicci√≥n", "consumir", "impulso", "abstinencia", "quiero drogarme", "no aguanto"],
    toc: ["toc", "obsesi√≥n", "compulsi√≥n", "comprobar", "pensar sin parar"],
    bipolaridad: ["bipolaridad", "cambio de √°nimo", "euforia", "no puedo dormir", "tristeza intensa"]
  };

  // Chat state
  let chatHistory = [
    {author: "psicologo", emotion:'default', text: "<span style='color:#7C3AED;font-weight:700;'>¬°Hola! Soy tu psic√≥logo virtual.<br>¬øSobre qu√© tema te gustar√≠a conversar hoy?<br><b>Ejemplo:</b> ansiedad, depresi√≥n, trauma, adicciones, TOC, bipolaridad.</span>"}
  ];

  function detectCrisis(msg) {
    msg = msg.toLowerCase();
    for (let crisis in crisisKeywords) {
      if (crisisKeywords[crisis].some(k => msg.includes(k))) {
        emotionalBg = crisis; // Para fondo
        return crisis;
      }
    }
    emotionalBg = 'default';
    return null;
  }

  // Animaci√≥n de burbujas y fondo interactivo
  function renderChat() {
    const chatDiv = document.getElementById('chat-window');
    chatDiv.innerHTML = chatHistory.map((msg,i) =>
      `<div class="bubble-anim mb-3 flex ${msg.author === 'user' ? 'justify-end' : 'justify-start'}">
        <div class="${msg.author === 'user' ? 'bubble-user' : 'bubble-bot'} rounded-2xl p-4 max-w-[80%] shadow-lg font-semibold tracking-wide" style="${msg.author === 'user' ? 'margin-left:auto;' : ''}">
          ${msg.text}
        </div>
      </div>`
    ).join('');
    chatDiv.scrollTop = chatDiv.scrollHeight;
    updateBgByEmotion();
  }

  // Cambia el fondo seg√∫n estado emocional detectado
  function updateBgByEmotion() {
    const bg = document.getElementById('chatbot-bg');
    switch(emotionalBg){
      case 'ansiedad':
        bg.style.background = 'radial-gradient(ellipse at top,#A7C7E7 60%,#C2E9D3 100%)';
        break;
      case 'depresion':
        bg.style.background = 'linear-gradient(135deg,#f7d6e0 60%,#b9aedc 100%)';
        break;
      case 'trauma':
        bg.style.background = 'radial-gradient(ellipse at bottom,#C2E9D3 60%,#ecebff 100%)';
        break;
      case 'adicciones':
        bg.style.background = 'linear-gradient(135deg,#AEE6E6 60%,#F7D6E0 100%)';
        break;
      case 'toc':
        bg.style.background = 'linear-gradient(135deg,#AEE6E6 60%,#ecebff 100%)';
        break;
      case 'bipolaridad':
        bg.style.background = 'linear-gradient(135deg,#b9aedc 60%,#AEE6E6 100%)';
        break;
      default:
        bg.style.background = 'linear-gradient(135deg,#f4f6fa 60%,#A7C7E7 100%)';
    }
  }

  // Genera respuesta seg√∫n crisis detectada y modo
  function getReply(userMsg) {
    let crisis = detectCrisis(userMsg);
    if (crisis) {
      let txt = replyMode === 'breve' ? crisisTechniques[crisis].breve : crisisTechniques[crisis].extendida;
      txt += `<br>${crisisTechniques[crisis].ejercicio}`;
      txt += `<br><i style='color:#6366F1'>¬øQuieres ver otra t√©cnica o ejercicio? Escribe "m√°s".</i>`;
      return txt;
    }
    if (userMsg.toLowerCase().includes("m√°s")) {
      let lastCrisis = null;
      for (let i = chatHistory.length - 1; i >= 0; i--) {
        let c = detectCrisis(chatHistory[i].text);
        if (c) { lastCrisis = c; break; }
      }
      if (lastCrisis) {
        let txt = replyMode === 'breve' ? crisisTechniques[lastCrisis].extendida : crisisTechniques[lastCrisis].breve;
        txt += `<br>${crisisTechniques[lastCrisis].ejercicio}`;
        return txt;
      }
    }
    return "<span style='color:#7C3AED'>¬øPuedes contarme m√°s sobre c√≥mo te has sentido o qu√© quieres trabajar hoy?<br>Puedo ayudarte con <b>ansiedad, depresi√≥n, trauma, adicciones, TOC, bipolaridad</b>.</span>";
  }

  // Ejercicios guiados por crisis (igual que antes)
  function ejercicioAnsiedad() { /* ...igual que antes... */ document.getElementById('ejercicio-sugerido').innerHTML = `
    <div class="bg-gradient-to-br from-blue-100 via-lavender-100 to-green-50 p-6 rounded-2xl mb-4 border border-blue-200 shadow-xl animate-fadein">
      <h4 class="text-2xl font-bold mb-3 text-indigo-700">Ejercicio de Respiraci√≥n (Ansiedad)</h4>
      <ol class="list-decimal pl-6 mb-2 text-lg text-blue-900">
        <li>Si√©ntate c√≥modo, pon una mano en el abdomen.</li>
        <li>Inhala lento por la nariz 4 segundos.</li>
        <li>Ret√©n el aire 2 segundos.</li>
        <li>Exhala lento por la boca 6 segundos.</li>
        <li>Repite 5 veces.</li>
      </ol>
      <button onclick="document.getElementById('ejercicio-sugerido').innerHTML=''" class="bg-gradient-to-r from-indigo-400 to-green-300 text-white px-4 py-2 rounded-xl font-semibold shadow mt-2">Cerrar</button>
    </div>
  `;}
  function ejercicioDepresion() { /* ...igual que antes... */ document.getElementById('ejercicio-sugerido').innerHTML = `
    <div class="bg-gradient-to-br from-pink-100 via-yellow-100 to-white p-6 rounded-2xl mb-4 border border-pink-200 shadow-xl animate-fadein">
      <h4 class="text-2xl font-bold mb-3 text-pink-700">Ejercicio de Activaci√≥n Conductual (Depresi√≥n)</h4>
      <ol class="list-decimal pl-6 mb-2 text-lg text-pink-900">
        <li>Elige una acci√≥n peque√±a: ducharte, caminar, llamar a alguien.</li>
        <li>Hazla aunque no tengas ganas.</li>
        <li>Luego, escribe tres cosas buenas que pasaron hoy.</li>
      </ol>
      <button onclick="document.getElementById('ejercicio-sugerido').innerHTML=''" class="bg-gradient-to-r from-yellow-300 to-pink-300 text-white px-4 py-2 rounded-xl font-semibold shadow mt-2">Cerrar</button>
    </div>
  `;}
  function ejercicioTrauma() { /* igual que antes */ document.getElementById('ejercicio-sugerido').innerHTML = `
    <div class="bg-gradient-to-br from-green-100 via-blue-100 to-white p-6 rounded-2xl mb-4 border border-green-200 shadow-xl animate-fadein">
      <h4 class="text-2xl font-bold mb-3 text-green-700">Ejercicio de Grounding (Trauma)</h4>
      <ol class="list-decimal pl-6 mb-2 text-lg text-green-900">
        <li>Toca un objeto y describe su textura, temperatura y color.</li>
        <li>Siente tus pies en el suelo, flexi√≥nalos lentamente.</li>
        <li>Nombra 3 colores, 3 sonidos y 3 olores que te rodean.</li>
        <li>Repite: ‚ÄúEstoy seguro aqu√≠ y ahora‚Äù.</li>
      </ol>
      <button onclick="document.getElementById('ejercicio-sugerido').innerHTML=''" class="bg-gradient-to-r from-green-400 to-blue-300 text-white px-4 py-2 rounded-xl font-semibold shadow mt-2">Cerrar</button>
    </div>
  `;}
  function ejercicioAdicciones() { /* igual que antes */ document.getElementById('ejercicio-sugerido').innerHTML = `
    <div class="bg-gradient-to-br from-pink-100 via-green-100 to-white p-6 rounded-2xl mb-4 border border-pink-200 shadow-xl animate-fadein">
      <h4 class="text-2xl font-bold mb-3 text-pink-700">Ejercicio de Distracci√≥n (Adicciones)</h4>
      <ol class="list-decimal pl-6 mb-2 text-lg text-pink-900">
        <li>Sal de la habitaci√≥n o cambia de ambiente.</li>
        <li>Llama o escribe a alguien de confianza.</li>
        <li>Pon m√∫sica y baila o canta.</li>
        <li>Espera 10 minutos antes de actuar sobre el impulso.</li>
      </ol>
      <button onclick="document.getElementById('ejercicio-sugerido').innerHTML=''" class="bg-gradient-to-r from-pink-400 to-green-300 text-white px-4 py-2 rounded-xl font-semibold shadow mt-2">Cerrar</button>
    </div>
  `;}
  function ejercicioTOC() { /* igual que antes */ document.getElementById('ejercicio-sugerido').innerHTML = `
    <div class="bg-gradient-to-br from-teal-100 via-blue-100 to-white p-6 rounded-2xl mb-4 border border-teal-200 shadow-xl animate-fadein">
      <h4 class="text-2xl font-bold mb-3 text-teal-700">Ejercicio de ERP (TOC)</h4>
      <ol class="list-decimal pl-6 mb-2 text-lg text-teal-900">
        <li>Identifica el pensamiento obsesivo.</li>
        <li>Evita realizar la compulsi√≥n por 1 minuto (luego 2, luego 5).</li>
        <li>Apunta c√≥mo te sientes antes, durante y despu√©s.</li>
        <li>Repite: ‚ÄúEs solo un pensamiento, pasar√°‚Äù.</li>
      </ol>
      <button onclick="document.getElementById('ejercicio-sugerido').innerHTML=''" class="bg-gradient-to-r from-teal-400 to-blue-400 text-white px-4 py-2 rounded-xl font-semibold shadow mt-2">Cerrar</button>
    </div>
  `;}
  function ejercicioBipolaridad() { /* igual que antes */ document.getElementById('ejercicio-sugerido').innerHTML = `
    <div class="bg-gradient-to-br from-purple-100 via-green-100 to-white p-6 rounded-2xl mb-4 border border-purple-200 shadow-xl animate-fadein">
      <h4 class="text-2xl font-bold mb-3 text-purple-700">Ejercicio de Monitoreo (Bipolaridad)</h4>
      <ol class="list-decimal pl-6 mb-2 text-lg text-purple-900">
        <li>Escribe c√≥mo te has sentido hoy: √°nimo, energ√≠a, sue√±o, apetito.</li>
        <li>Haz una lista de actividades que mantengan tu rutina.</li>
        <li>Si notas cambios intensos, contacta a tu profesional.</li>
      </ol>
      <button onclick="document.getElementById('ejercicio-sugerido').innerHTML=''" class="bg-gradient-to-r from-purple-400 to-green-300 text-white px-4 py-2 rounded-xl font-semibold shadow mt-2">Cerrar</button>
    </div>
  `;}

  // Guardar chat en diario
  function saveChatToJournal() {
    const plainChat = chatHistory.map(msg => (msg.author === 'user' ? "Yo: " : "Psic√≥logo: ") + msg.text.replace(/<br>/g,"\n").replace(/<[^>]+>/g,'')).join('\n---\n');
    localStorage.setItem('diarioDraft', plainChat);
    location.hash = "#/journal";
  }

  // Plan de emergencia
  function showPlanEmergenciaModal() {
    document.getElementById('plan-emergencia-modal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
    const plan = JSON.parse(localStorage.getItem('planEmergencia') || '{}');
    if (plan && Object.keys(plan).length > 0) {
      document.querySelector("#plan-emergencia-form [name=senales]").value = plan.senales || '';
      document.querySelector("#plan-emergencia-form [name=acciones]").value = plan.acciones || '';
      document.querySelector("#plan-emergencia-form [name=contacto]").value = plan.contacto || '';
      document.querySelector("#plan-emergencia-form [name=recursos]").value = plan.recursos || '';
    }
  }
  function closePlanEmergenciaModal() {
    document.getElementById('plan-emergencia-modal').style.display = 'none';
    document.body.style.overflow = '';
  }
  document.getElementById('plan-emergencia-form').onsubmit = function(e) {
    e.preventDefault();
    const plan = {
      senales: this.senales.value,
      acciones: this.acciones.value,
      contacto: this.contacto.value,
      recursos: this.recursos.value
    };
    localStorage.setItem('planEmergencia', JSON.stringify(plan));
    closePlanEmergenciaModal();
    showPlanEmergencia();
  };
  function showPlanEmergencia() {
    const plan = JSON.parse(localStorage.getItem('planEmergencia') || '{}');
    if (!plan || !plan.senales) {
      document.getElementById('plan-emergencia-vista').style.display = 'none';
      return;
    }
    document.getElementById('plan-emergencia-vista').style.display = 'block';
    document.getElementById('plan-emergencia-content').innerHTML = `
      <div class="mb-2"><span class="font-semibold text-pink-700">Se√±ales de crisis:</span> ${plan.senales}</div>
      <div class="mb-2"><span class="font-semibold text-green-700">Acciones para calmarme:</span> ${plan.acciones}</div>
      <div class="mb-2"><span class="font-semibold text-blue-700">Contacto de apoyo:</span> ${plan.contacto}</div>
      <div class="mb-2"><span class="font-semibold text-purple-700">Recursos √∫tiles:</span> ${plan.recursos}</div>
    `;
  }
  function editPlanEmergencia() {
    showPlanEmergenciaModal();
  }

  // Exportar plan de emergencia a PDF
  function exportPlanPDF() {
    const plan = JSON.parse(localStorage.getItem('planEmergencia') || '{}');
    if (!plan || !plan.senales) return alert("Completa el plan de emergencia primero.");
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.text("Plan de Emergencia Personal", 20, 20);
    doc.setFontSize(12);
    doc.setFont("helvetica", "normal");
    doc.text(`Se√±ales de crisis: ${plan.senales}`, 20, 40);
    doc.text(`Acciones para calmarme: ${plan.acciones}`, 20, 55);
    doc.text(`Contacto de apoyo: ${plan.contacto}`, 20, 70);
    doc.text(`Recursos √∫tiles: ${plan.recursos}`, 20, 85);
    doc.save("plan-emergencia.pdf");
  }

  // Enviar mensaje
  document.getElementById('chat-form').onsubmit = function(e) {
    e.preventDefault();
    const input = document.getElementById('chat-input');
    const text = input.value.trim();
    if (!text) return;
    chatHistory.push({author:"user",emotion:emotionalBg,text:text});
    const reply = getReply(text);
    chatHistory.push({author:"psicologo",emotion:emotionalBg,text:reply});
    renderChat();
    input.value = '';
  };

  // Modo oscuro autom√°tico
  let darkMode = false;
  document.getElementById('toggle-dark').onclick = function(){
    darkMode = !darkMode;
    document.documentElement.classList.toggle('darkmode',darkMode);
    localStorage.setItem('psico-dark',darkMode?'1':'0');
  };
  // Detecta el modo preferido
  if(localStorage.getItem('psico-dark')==='1' || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)){
    document.documentElement.classList.add('darkmode');
    darkMode = true;
  }

  // Render inicial y plan emergencia
  renderChat();
  showPlanEmergencia();

  // Animaci√≥n de burbujas al aparecer
  setTimeout(()=>{
    document.querySelectorAll('.bubble-anim').forEach((el,i)=>{
      el.style.animationDelay = (i*0.12)+'s';
      el.classList.add('bubble-animated');
    });
  },200);

</script>
<style>
  .lavender-100 { background: #ecebff; }
  .animate-fadein { animation: fadein .7s; }
  @keyframes fadein { from{opacity:0;transform:translateY(20px);} to{opacity:1;transform:translateY(0);} }
  .bubble-anim { opacity:0; transform:translateY(20px);}
  .bubble-animated { opacity:1; transform:translateY(0); animation: bubblein .7s both;}
  @keyframes bubblein { from{opacity:0;transform:scale(0.9) translateY(20px);} to{opacity:1;transform:scale(1) translateY(0);} }
  .bubble-user { background: linear-gradient(135deg,#A7C7E7 60%,#C2E9D3 100%);}
  .bubble-bot  { background: linear-gradient(135deg,#ecebff 60%,#b9aedc 100%);}
  /* Dark mode */
  html.darkmode, html.darkmode body { background: #191c25 !important; color: #e0e4ea;}
  html.darkmode .chatbot-container { background: linear-gradient(135deg,#25283b 60%,#233c54 100%) !important; }
  html.darkmode .chatbot-bubbles { background: linear-gradient(135deg,#20242c 60%,#25283b 100%) !important; border-color:#2a3953;}
  html.darkmode .bubble-user { background: linear-gradient(135deg,#293d6a 80%,#377a6d 100%) !important; color:#e0e4ea !important;}
  html.darkmode .bubble-bot { background: linear-gradient(135deg,#3b3256 60%,#233c54 100%) !important; color:#e0e4ea !important;}
  html.darkmode input, html.darkmode textarea { background: #23283a !important; color:#e0e4ea !important; border-color:#2a3953;}
  html.darkmode .bg-blue-100, html.darkmode .bg-lavender-100, html.darkmode .bg-pink-100, html.darkmode .bg-green-100 { filter:brightness(0.7);}
  html.darkmode .bg-white { background: #222 !important;}
  html.darkmode .bg-gradient-to-r, html.darkmode .bg-gradient-to-br { filter:brightness(0.8);}
  html.darkmode .ring-indigo-200, html.darkmode .ring-purple-200, html.darkmode .ring-green-300, html.darkmode .ring-pink-200 { box-shadow:0 0 0 2px #444;}
  html.darkmode .border-blue-100, html.darkmode .border-green-100, html.darkmode .border-pink-100, html.darkmode .border-teal-200 { border-color:#2a3953 !important;}
</style>
