<section class="py-8 max-w-2xl mx-auto fadein">
  <!-- Encabezado -->
  <div class="flex items-center gap-4 mb-6">
    <div class="w-14 h-14 bg-gradient-to-br from-indigo-100 to-purple-200 rounded-full flex items-center justify-center">
      <i class="fas fa-user-md text-purple-700 text-3xl"></i>
    </div>
    <div>
      <h2 class="text-3xl font-bold mb-1">Psicoterapia</h2>
      <p class="text-gray-600">Ejercicios guiados y tests personalizados según tu estado emocional.</p>
    </div>
  </div>

  <!-- Registro de emociones -->
  <div class="bg-white rounded-3xl shadow p-6 mb-6">
    <h3 class="text-xl font-semibold mb-3">Registro de emociones</h3>
    <form id="emocion-form" class="flex flex-col gap-2">
      <label class="font-medium">¿Cómo te sientes ahora?</label>
      <select id="emocion" class="border rounded p-2 w-full" required>
        <option value="">Selecciona...</option>
        <option value="Feliz">Feliz</option>
        <option value="Triste">Triste</option>
        <option value="Ansioso/a">Ansioso/a</option>
        <option value="Motivado/a">Motivado/a</option>
        <option value="En calma">En calma</option>
        <option value="Cansado/a">Cansado/a</option>
        <option value="Otro">Otro</option>
      </select>
      <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded shadow hover:bg-indigo-800 transition">Registrar</button>
    </form>
    <div id="emocion-msg" class="mt-2 text-green-700 font-semibold"></div>
    <div id="emocion-history" class="mt-4"></div>
  </div>

  <!-- Sugerencia dinámica y ejercicios/tests personalizados -->
  <div id="ejercicio-sugerido"></div>
  <div id="ejercicios-expandidos" class="bg-white rounded-3xl shadow p-6 mb-6" style="display:none;">
    <!-- Respiración guiada (Ansiedad) -->
    <div id="ej-respiracion" style="display:none;">
      <h3 class="text-xl font-semibold mb-3">Respiración consciente</h3>
      <ol class="list-decimal pl-6 mb-3">
        <li>Siéntate cómodo y cierra los ojos.</li>
        <li>Inhala lento contando hasta 4.</li>
        <li>Retén el aire 2 segundos.</li>
        <li>Exhala contando hasta 6.</li>
        <li>Repite 5 veces.</li>
      </ol>
      <button onclick="cerrarEjercicio()" class="mt-2 bg-indigo-100 text-indigo-700 px-4 py-2 rounded">Cerrar</button>
    </div>
    <!-- Test de ansiedad breve -->
    <div id="test-ansiedad" style="display:none;">
      <h3 class="text-xl font-semibold mb-3">Test breve de ansiedad</h3>
      <form id="ansiedad-test-form" class="flex flex-col gap-2">
        <label>¿Has sentido palpitaciones o sudoración sin motivo?</label>
        <select name="p1" class="border rounded p-2 w-full" required>
          <option value="">Selecciona...</option>
          <option value="si">Sí</option>
          <option value="no">No</option>
        </select>
        <label>¿Te cuesta controlar tus preocupaciones?</label>
        <select name="p2" class="border rounded p-2 w-full" required>
          <option value="">Selecciona...</option>
          <option value="si">Sí</option>
          <option value="no">No</option>
        </select>
        <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded mt-2">Ver resultado</button>
      </form>
      <div id="ansiedad-test-res" class="mt-2 text-indigo-700 font-semibold"></div>
      <button onclick="cerrarEjercicio()" class="mt-4 bg-indigo-100 text-indigo-700 px-4 py-2 rounded">Cerrar</button>
    </div>
    <!-- Autoafirmación y test de autoestima (Triste/Feliz) -->
    <div id="ej-afirmacion" style="display:none;">
      <h3 class="text-xl font-semibold mb-3">Autoafirmación guiada</h3>
      <p>Completa: Hoy reconozco que soy capaz de <b><span id="afirmacion-completa"></span></b></p>
      <form id="afirmacion-form" class="flex flex-col gap-2 mt-3">
        <input type="text" id="afirmacion" class="border rounded p-2 w-full" maxlength="80" required placeholder="Escribe tu afirmación...">
        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">Guardar afirmación</button>
      </form>
      <div id="afirmacion-msg" class="mt-2 text-green-700 font-semibold"></div>
      <button onclick="cerrarEjercicio()" class="mt-4 bg-green-100 text-green-700 px-4 py-2 rounded">Cerrar</button>
    </div>
    <div id="test-autoestima" style="display:none;">
      <h3 class="text-xl font-semibold mb-3">Test de autoestima</h3>
      <form id="autoestima-test-form" class="flex flex-col gap-2">
        <label>¿Te valoras a ti mismo/a?</label>
        <select name="p1" class="border rounded p-2 w-full" required>
          <option value="">Selecciona...</option>
          <option value="si">Sí</option>
          <option value="no">No</option>
        </select>
        <label>¿Reconoces tus logros diarios?</label>
        <select name="p2" class="border rounded p-2 w-full" required>
          <option value="">Selecciona...</option>
          <option value="si">Sí</option>
          <option value="no">No</option>
        </select>
        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded mt-2">Ver resultado</button>
      </form>
      <div id="autoestima-test-res" class="mt-2 text-green-700 font-semibold"></div>
      <button onclick="cerrarEjercicio()" class="mt-4 bg-green-100 text-green-700 px-4 py-2 rounded">Cerrar</button>
    </div>
    <!-- Meditación guiada (En calma/Cansado) -->
    <div id="ej-meditacion" style="display:none;">
      <h3 class="text-xl font-semibold mb-3">Meditación breve para recargar energía</h3>
      <ol class="list-decimal pl-6 mb-3">
        <li>Colócate cómodo/a y cierra los ojos.</li>
        <li>Respira profundo varias veces.</li>
        <li>Imagina una luz que te recarga.</li>
        <li>Permanece así 3 minutos y vuelve lentamente.</li>
      </ol>
      <button onclick="cerrarEjercicio()" class="mt-2 bg-purple-100 text-purple-700 px-4 py-2 rounded">Cerrar</button>
    </div>
    <!-- Test de motivación -->
    <div id="test-motivacion" style="display:none;">
      <h3 class="text-xl font-semibold mb-3">Test de motivación</h3>
      <form id="motivacion-test-form" class="flex flex-col gap-2">
        <label>¿Tienes ganas de comenzar nuevos proyectos?</label>
        <select name="p1" class="border rounded p-2 w-full" required>
          <option value="">Selecciona...</option>
          <option value="si">Sí</option>
          <option value="no">No</option>
        </select>
        <label>¿Te sientes capaz de lograr tus metas?</label>
        <select name="p2" class="border rounded p-2 w-full" required>
          <option value="">Selecciona...</option>
          <option value="si">Sí</option>
          <option value="no">No</option>
        </select>
        <button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded mt-2">Ver resultado</button>
      </form>
      <div id="motivacion-test-res" class="mt-2 text-purple-700 font-semibold"></div>
      <button onclick="cerrarEjercicio()" class="mt-4 bg-purple-100 text-purple-700 px-4 py-2 rounded">Cerrar</button>
    </div>
  </div>

  <!-- Historial, metas, y vinculación con diario igual que antes -->
  <!-- ...puedes mantener el resto del archivo anterior para afirmaciones, metas, recordatorio de sesión, frases motivadoras... -->
</section>
<script>
// Sugerencia y ejercicio/test según emoción
function sugerirEjercicio(emocion) {
  let sugerencia = '', btn = '';
  let ejercicios = {
    "Ansioso/a": () => {
      sugerencia = "¿Quieres realizar una respiración consciente para reducir la ansiedad?";
      btn = `<button onclick="mostrarEjercicio('respiracion')" class="ml-2 bg-indigo-600 text-white px-3 py-1 rounded">Respiración</button>
      <button onclick="mostrarEjercicio('test-ansiedad')" class="ml-2 bg-indigo-600 text-white px-3 py-1 rounded">Test Ansiedad</button>`;
    },
    "Triste": () => {
      sugerencia = "Prueba el ejercicio de autoafirmación o realiza el test de autoestima.";
      btn = `<button onclick="mostrarEjercicio('ej-afirmacion')" class="ml-2 bg-green-600 text-white px-3 py-1 rounded">Autoafirmación</button>
      <button onclick="mostrarEjercicio('test-autoestima')" class="ml-2 bg-green-600 text-white px-3 py-1 rounded">Test Autoestima</button>`;
    },
    "Feliz": () => {
      sugerencia = "¿Te gustaría guardar una autoafirmación positiva?";
      btn = `<button onclick="mostrarEjercicio('ej-afirmacion')" class="ml-2 bg-green-600 text-white px-3 py-1 rounded">Autoafirmación</button>`;
    },
    "Motivado/a": () => {
      sugerencia = "¡Haz el test de motivación o registra una meta!";
      btn = `<button onclick="mostrarEjercicio('test-motivacion')" class="ml-2 bg-purple-600 text-white px-3 py-1 rounded">Test Motivación</button>`;
    },
    "En calma": () => {
      sugerencia = "¿Te gustaría hacer una meditación breve para mantener tu bienestar?";
      btn = `<button onclick="mostrarEjercicio('ej-meditacion')" class="ml-2 bg-indigo-600 text-white px-3 py-1 rounded">Meditación</button>`;
    },
    "Cansado/a": () => {
      sugerencia = "Recarga energía con una meditación guiada.";
      btn = `<button onclick="mostrarEjercicio('ej-meditacion')" class="ml-2 bg-purple-600 text-white px-3 py-1 rounded">Meditación</button>`;
    }
  };
  if (ejercicios[emocion]) ejercicios[emocion]();
  document.getElementById('ejercicio-sugerido').innerHTML = sugerencia ?
    `<div class="bg-indigo-50 rounded-xl p-4 mb-4 text-indigo-700 font-semibold flex items-center">${sugerencia}${btn}</div>` : '';
}

// Mostrar ejercicios guiados y tests
function mostrarEjercicio(tipo) {
  document.getElementById('ejercicios-expandidos').style.display = 'block';
  ['ej-respiracion','test-ansiedad','ej-afirmacion','test-autoestima','ej-meditacion','test-motivacion'].forEach(id=>document.getElementById(id).style.display='none');
  if (document.getElementById(tipo)) document.getElementById(tipo).style.display = 'block';
}
function cerrarEjercicio() {
  document.getElementById('ejercicios-expandidos').style.display = 'none';
  ['ej-respiracion','test-ansiedad','ej-afirmacion','test-autoestima','ej-meditacion','test-motivacion'].forEach(id=>document.getElementById(id).style.display='none');
}

// Test Ansiedad
document.getElementById('ansiedad-test-form')?.addEventListener('submit', function(e) {
  e.preventDefault();
  const p1 = this.p1.value, p2 = this.p2.value;
  let res = '';
  if (p1 === "si" || p2 === "si") res = "Tus respuestas sugieren ansiedad significativa. Prueba técnicas de relajación y consulta ayuda profesional si persiste.";
  else res = "No presentas síntomas relevantes de ansiedad.";
  document.getElementById('ansiedad-test-res').textContent = res;
});

// Test Autoestima
document.getElementById('autoestima-test-form')?.addEventListener('submit', function(e) {
  e.preventDefault();
  const p1 = this.p1.value, p2 = this.p2.value;
  let res = '';
  if (p1 === "si" && p2 === "si") res = "¡Excelente! Tu autoestima está fortalecida.";
  else if (p1 === "no" || p2 === "no") res = "Trabaja en reconocer tu valor. El ejercicio de autoafirmación te ayudará.";
  else res = "Completa el test para ver el resultado.";
  document.getElementById('autoestima-test-res').textContent = res;
});

// Test Motivación
document.getElementById('motivacion-test-form')?.addEventListener('submit', function(e) {
  e.preventDefault();
  const p1 = this.p1.value, p2 = this.p2.value;
  let res = '';
  if (p1 === "si" && p2 === "si") res = "¡Genial! Estás motivado/a para lograr tus metas.";
  else if (p1 === "no" || p2 === "no") res = "Refuerza tu motivación con metas pequeñas y celebra cada avance.";
  else res = "Completa el test para ver el resultado.";
  document.getElementById('motivacion-test-res').textContent = res;
});

// Autoafirmación guiada
document.getElementById('afirmacion-form')?.addEventListener('submit', function(e) {
  e.preventDefault();
  const txt = document.getElementById('afirmacion').value.trim();
  document.getElementById('afirmacion-completa').textContent = txt;
  document.getElementById('afirmacion-msg').textContent = "¡Afirmación guardada!";
  document.getElementById('afirmacion').value = '';
});

document.getElementById('emocion-form').onsubmit = function(e) {
  e.preventDefault();
  const emo = document.getElementById('emocion').value;
  if (!emo) return;
  let arr = JSON.parse(localStorage.getItem('psicoterapiaEmociones') || '[]');
  const now = new Date();
  arr.unshift({text: emo, date: now.toLocaleString()});
  localStorage.setItem('psicoterapiaEmociones', JSON.stringify(arr));
  document.getElementById('emocion').value = '';
  document.getElementById('emocion-msg').textContent = "¡Registrada!";
  showEmocionHistory();
  sugerirEjercicio(emo);
};

function showEmocionHistory() {
  const arr = JSON.parse(localStorage.getItem('psicoterapiaEmociones') || '[]');
  const div = document.getElementById('emocion-history');
  if (!arr.length) { div.innerHTML = ""; return; }
  div.innerHTML = `<h4 class="font-semibold mb-2">Tus emociones recientes:</h4>` +
    arr.slice(0,5).map(a => `<div class="border border-blue-100 rounded-xl p-2 mb-1 text-gray-700 flex justify-between items-center">
      ${a.text} <span class="text-xs text-gray-400">${a.date}</span>
      <button onclick="enviarAlDiario('${a.text}')" class="ml-3 px-2 py-1 text-xs bg-indigo-100 rounded hover:bg-indigo-200">Registrar en Diario</button>
    </div>`).join('');
  if (arr.length) sugerirEjercicio(arr[0].text);
}
document.addEventListener('DOMContentLoaded', () => {
  showEmocionHistory();
});
</script>
