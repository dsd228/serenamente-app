<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SerenBot Avanzado</title>
    <style>
        :root {
            --primary: #4e7ae6;
            --secondary: #7c4dff;
            --background: #f8f9fa;
            --surface: #ffffff;
            --on-surface: #212121;
            --on-primary: #ffffff;
            --success: #4caf50;
            --warning: #ff9800;
            --error: #f44336;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--background);
            color: var(--on-surface);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .chat-container {
            width: 100%;
            max-width: 800px;
            height: 90vh;
            background-color: var(--surface);
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--on-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .chat-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.5;
            position: relative;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            align-self: flex-end;
            background-color: var(--primary);
            color: var(--on-primary);
            border-bottom-right-radius: 4px;
        }
        
        .bot-message {
            align-self: flex-start;
            background-color: #eef2f8;
            color: var(--on-surface);
            border-bottom-left-radius: 4px;
        }
        
        .chat-input {
            padding: 16px;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            gap: 12px;
        }
        
        .chat-input input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 24px;
            outline: none;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .chat-input input:focus {
            border-color: var(--primary);
        }
        
        .chat-input button {
            padding: 12px 20px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .chat-input button:hover {
            background-color: #3b5fc0;
        }
        
        .quick-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 0 16px 16px;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
        }
        
        .suggestion-chip {
            padding: 8px 16px;
            background-color: #eef2f8;
            border-radius: 16px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .suggestion-chip:hover {
            background-color: #dfe6f3;
        }
        
        .typing-indicator {
            align-self: flex-start;
            background-color: #eef2f8;
            padding: 12px 16px;
            border-radius: 18px;
            display: flex;
            gap: 4px;
            margin-bottom: 8px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: #9e9e9e;
            border-radius: 50%;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }
        
        .message-time {
            font-size: 0.7rem;
            margin-top: 4px;
            opacity: 0.7;
        }

        .notification-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--surface);
            color: var(--on-surface);
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s;
            z-index: 1000;
        }

        .notification-toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        @media (max-width: 600px) {
            .chat-container {
                height: 95vh;
                border-radius: 12px;
            }
            
            .message {
                max-width: 90%;
            }
            
            .chat-header h1 {
                font-size: 1.3rem;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h1>SerenBot</h1>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message bot-message">
                ¡Hola! Soy SerenBot, tu asistente virtual en Serenamente. Estoy aquí para ayudarte con tu bienestar emocional. ¿Cómo te sientes hoy?
                <div class="message-time">Ahora</div>
            </div>
        </div>
        <div class="quick-suggestions" id="quickSuggestions">
            <div class="suggestion-chip">Técnicas para ansiedad</div>
            <div class="suggestion-chip">Cómo dormir mejor</div>
            <div class="suggestion-chip">Ejercicio de respiración</div>
            <div class="suggestion-chip">Registrar mis emociones</div>
        </div>
        <div class="chat-input">
            <input type="text" id="userInput" placeholder="Escribe tu mensaje aquí..." autocomplete="off" aria-label="Escribe tu mensaje">
            <button id="sendButton" aria-label="Enviar mensaje">Enviar</button>
        </div>
    </div>

    <div class="notification-toast" id="notificationToast"></div>

    <script>
        // Clase de utilidades para localStorage
        class StorageManager {
            static save(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    return true;
                } catch (e) {
                    console.error('Error guardando en localStorage:', e);
                    return false;
                }
            }
            
            static load(key) {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch (e) {
                    console.error('Error cargando desde localStorage:', e);
                    return null;
                }
            }
            
            static clear(key) {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (e) {
                    console.error('Error limpiando localStorage:', e);
                    return false;
                }
            }
        }

        // Gestor de notificaciones
        class NotificationManager {
            constructor() {
                this.toast = document.getElementById('notificationToast');
                this.notificationPermission = false;
                
                // Solicitar permiso para notificaciones
                if ('Notification' in window) {
                    Notification.requestPermission().then(permission => {
                        this.notificationPermission = permission === 'granted';
                    });
                }
            }
            
            showNotification(title, options = {}) {
                // Notificación del navegador
                if (this.notificationPermission) {
                    const notification = new Notification(title, {
                        icon: '/favicon.ico',
                        badge: '/favicon.ico',
                        ...options
                    });
                    
                    notification.onclick = () => {
                        window.focus();
                        notification.close();
                    };
                    
                    return notification;
                }
                
                // Toast como fallback
                this.showToast(title);
                return null;
            }
            
            showToast(message, duration = 3000) {
                this.toast.textContent = message;
                this.toast.classList.add('show');
                
                setTimeout(() => {
                    this.toast.classList.remove('show');
                }, duration);
            }
        }

        // Gestor de errores
        class ErrorHandler {
            static handle(error, context = '') {
                console.error(`Error en ${context}:`, error);
                
                // En un entorno real, enviaríamos este error a un servicio de tracking
                // Por ahora solo lo registramos en consola
                
                return `Lo siento, ha ocurrido un error procesando tu solicitud. Por favor, inténtalo de nuevo.`;
            }
        }

        // SerenBot mejorado con algoritmos avanzados
        class EnhancedSerenBot {
            constructor() {
                this.isOpen = true;
                this.messages = [];
                this.currentContext = 'general';
                this.waitingForInput = false;
                this.userName = null;
                this.userMood = null;
                this.lastInteraction = null;
                this.conversationHistory = [];
                this.userPreferences = {};
                this.emotionalState = {
                    mood: null,
                    intensity: 1,
                    triggers: [],
                    patterns: []
                };
                
                // Inicializar managers
                this.storageManager = StorageManager;
                this.notificationManager = new NotificationManager();
                
                // Cargar datos guardados
                this.loadUserData();
                
                // Configurar recordatorios
                this.setupReminders();
                
                // Modelo de clasificación de intenciones mejorado
                this.intentModel = {
                    vocabulary: new Set(),
                    intents: {},
                    train: function(examples) {
                        examples.forEach((example, intent) => {
                            if (!this.intents[intent]) this.intents[intent] = { count: 0, words: {} };
                            
                            const words = example.toLowerCase().split(/\s+/);
                            words.forEach(word => {
                                this.vocabulary.add(word);
                                this.intents[intent].words[word] = (this.intents[intent].words[word] || 0) + 1;
                            });
                            
                            this.intents[intent].count++;
                        });
                    },
                    predict: function(text) {
                        try {
                            const words = text.toLowerCase().split(/\s+/);
                            let bestIntent = null;
                            let bestScore = 0;
                            
                            for (const intent in this.intents) {
                                let score = 0;
                                words.forEach(word => {
                                    if (this.intents[intent].words[word]) {
                                        score += this.intents[intent].words[word];
                                    }
                                });
                                
                                // Normalizar por longitud del texto e importancia de la intención
                                score = score / words.length / this.intents[intent].count;
                                
                                if (score > bestScore) {
                                    bestScore = score;
                                    bestIntent = intent;
                                }
                            }
                            
                            return bestScore > 0.3 ? bestIntent : 'unknown';
                        } catch (error) {
                            ErrorHandler.handle(error, 'predict intent');
                            return 'unknown';
                        }
                    }
                };
                
                // Entrenar el modelo con ejemplos
                this.trainIntentModel();
                
                // Conocimiento mejorado con más profundidad técnica
                this.knowledgeBase = {
                    saludos: {
                        triggers: ['hola', 'hey', 'buenas', 'buenos días', 'buenas tardes', 'buenas noches', 'hi', 'hello', 'saludos'],
                        responses: [
                            (user) => `¡Hola${user.name ? ' ' + user.name : ''}! Soy SerenBot, tu asistente virtual en Serenamente. ¿Cómo te sientes hoy?`,
                            (user) => `¡Hola! Me alegra verte por aquí${user.name ? ' ' + user.name : ''}. ¿En qué puedo ayudarte hoy?`,
                            (user) => `¡Hola${user.name ? ' ' + user.name : ''}! Espero que estés teniendo un buen día. ¿Hay algo en lo que pueda asistirte?`
                        ],
                        followUp: '¿Te gustaría que te cuente más sobre lo que puedo hacer por ti?',
                        priority: 1
                    },
                    ayuda: {
                        triggers: ['ayuda', 'help', 'qué puedes hacer', 'que puedes hacer', 'funciones', 'comandos', 'asistencia'],
                        responses: [
                            (user) => `Puedo ayudarte en muchas áreas de tu bienestar emocional:

🧠 **Apoyo Emocional**: Técnicas para manejar ansiedad, estrés y emociones difíciles
🌙 **Sueño y Relajación**: Ejercicios para dormir mejor y reducir el insomnio
📊 **Seguimiento**: Ayuda para registrar y entender tus patrones emocionales
🔍 **Navegación**: Guiarte por las diferentes secciones de Serenamente
💡 **Educación**: Explicarte conceptos de salud mental y técnicas terapéuticas

¿Hay algo específico con lo que necesites ayuda?`
                        ],
                        followUp: '¿Te interesa alguna de estas áreas en particular?',
                        priority: 1
                    },
                    tecnicas: {
                        triggers: ['técnicas', 'tecnicas', 'ejercicios', 'métodos', 'metodos', 'herramientas', 'qué hacer', 'que hacer'],
                        responses: [
                            (user) => `Serenamente ofrece técnicas profesionales basadas en evidencia científica:

1. 🧠 **Técnicas Cognitivas**: 
   - Reestructuración cognitiva para pensamientos negativos
   - Detección de distorsiones cognitivas
   - Diario de pensamientos

2. 🫁 **Regulación Fisiológica**:
   - Respiración 4-7-8 para ansiedad inmediata
   - Relajación muscular progresiva de Jacobson
   - Técnicas de grounding (5-4-3-2-1)

3. 🧘 **Mindfulness y Atención Plena**:
   - Meditaciones guiadas por tiempo
   - Body scan para conexión corporal
   - Mindfulness en actividades cotidianas

4. 💝 **Autocompasión y Autoaceptación**:
   - Ejercicios basados en el trabajo de Kristin Neff
   - Cartas de autocompasión
   - Meditaciones de bondad amorosa

¿Te gustaría que profundice en alguna técnica en particular?`
                        ],
                        followUp: '¿Qué tipo de técnica te interesa más: cognitivas, de respiración, mindfulness o autocompasión?',
                        priority: 2
                    },
                    emociones: {
                        triggers: ['triste', 'ansioso', 'estresado', 'enojado', 'preocupado', 'asustado', 'nervioso', 'desbordado', 'agobiado', 'frustrado'],
                        responses: [
                            (mood) => {
                                const empathy = {
                                    triste: `Lamento escuchar que te sientes triste. La tristeza es una emoción natural que nos indica que algo nos importa. ¿Te gustaría probar una técnica para procesar esta emoción?`,
                                    ansioso: `Entiendo que te sientas ansioso. La ansiedad puede ser abrumadora, pero hay técnicas específicas que pueden ayudarte a regularla. ¿Quieres que te guíe con alguna?`,
                                    estresado: `El estrés puede ser difícil de manejar. Afortunadamente, hay ejercicios de respiración y relajación que pueden ayudarte a reducir la sensación de estrés. ¿Te interesa probar uno?`,
                                    enojado: `El enojo es una emoción válida que nos indica que algo nos importa. Hay formas saludables de expresarlo y canalizarlo. ¿Te gustaría explorar algunas técnicas?`,
                                    general: `Aprecio que compartas cómo te sientes. Las emociones difíciles son parte de la experiencia humana. ¿Te gustaría probar alguna técnica para manejar lo que estás experimentando?`
                                };
                                
                                return empathy[mood] || empathy.general;
                            }
                        ],
                        followUp: '¿Quieres que te guíe con alguna técnica específica para manejar esta emoción?',
                        priority: 3
                    },
                    respiracion: {
                        triggers: ['respiración', 'respiracion', 'respirar', 'ansiedad', 'pánico', 'panico', 'calmarme', 'relajarme', 'hiperventilar', 'ataque'],
                        responses: [
                            (user) => `Te recomiendo la **técnica de respiración 4-7-8**, desarrollada por el Dr. Andrew Weil:

🌬️ **Instrucciones**:
1. Siéntate con la espalda recta o túmbate cómodamente
2. Coloca la punta de la lengua contra el paladar, detrás de los dientes frontales
3. **Exhala** completamente por la boca
4. **Inhala** por la nariz durante 4 segundos
5. **Aguanta** la respiración durante 7 segundos
6. **Exhala** completamente por la boca durante 8 segundos
7. Repite este ciclo **4 veces**

¿Te gustaría que te guíe paso a paso con esta técnica o prefieres otra opción?`
                        ],
                        followUp: '¿Quieres que inicie una sesión guiada de respiración ahora?',
                        priority: 2
                    },
                    sueno: {
                        triggers: ['dormir', 'insomnio', 'desvelado', 'sueño', 'sueno', 'no puedo dormir', 'despertar', 'noche'],
                        responses: [
                            (user) => `El insomnio puede ser difícil de manejar. Te sugiero varias aproximaciones:

🌙 **Higiene del sueño**:
- Establece un horario regular para dormir
- Crea un ritual relajante antes de acostarte
- Evita pantallas 1-2 horas antes de dormir
- Mantén tu habitación fresca, oscura y silenciosa

🛌 **Técnicas para conciliar el sueño**:
- Respiración 4-7-8 acostado en la cama
- Relajación muscular progresiva
- Visualización de escenas tranquilas

💡 **Si te despiertas en la noche**:
- Levántate si no logras dormirte en 20 minutos
- Haz algo relajante con luz tenue
- Vuelve a la cama solo cuando tengas sueño

¿Te gustaría que profundice en alguna de estas estrategias?`
                        ],
                        followUp: '¿Qué aspecto del sueño te preocupa más: conciliar el sueño, mantenerlo o despertarte muy temprano?',
                        priority: 2
                    },
                    diario: {
                        triggers: ['diario', 'escribir', 'registrar', 'pensamientos', 'emociones', 'sentimientos', 'expresar'],
                        responses: [
                            (user) => `El diario emocional es una herramienta poderosa con múltiples beneficios:

📝 **Beneficios del diario**:
- Ayuda a procesar y comprender emociones
- Identifica patrones de pensamiento
- Reduce la rumiación y el estrés
- Promueve la autoconciencia y el crecimiento

🔍 **Enfoques efectivos**:
1. **Diario de pensamientos**: Registra situación, emoción y pensamiento automático
2. **Diario de gratitud**: Anota 3 cosas por las que estés agradecido
3. **Escritura expresiva**: Escribe sobre experiencias emocionales intensas
4. **Diario de soluciones**: Enfócate en posibles soluciones más que en problemas

¿Te gustaría que te guíe con algún tipo específico de diario?`
                        ],
                        followUp: '¿Qué tipo de diario te interesaría probar: de pensamientos, de gratitud o expresivo?',
                        priority: 2
                    },
                    progreso: {
                        triggers: ['progreso', 'avance', 'estadísticas', 'estadisticas', 'seguimiento', 'mejora', 'evolución', 'evolucion', 'resultados'],
                        responses: [
                            (user) => `En Serenamente puedes hacer seguimiento de tu bienestar de varias formas:

📊 **Métricas de seguimiento**:
- Estado de ánimo diario (gráficos de evolución)
- Frecuencia de uso de técnicas
- Patrones de sueño y energía
- Niveles de estrés y ansiedad

📈 **Beneficios del seguimiento**:
- Identifica factores que afectan tu bienestar
- Detecta patrones y tendencias
- Celebra progresos y mejoras
- Ajusta estrategias según lo que funcione para ti

¿Te gustaría aprender a registrar tu estado de ánimo o ver tutoriales sobre cómo interpretar tus estadísticas?`
                        ],
                        followUp: '¿Qué te interesa más: registrar tu estado de ánimo actual o revisar tu progreso histórico?',
                        priority: 2
                    },
                    crisis: {
                        triggers: ['crisis', 'suicidio', 'emergencia', 'mal', 'muy mal', 'ayuda urgente', 'no puedo más', 'sin esperanza', 'desesperado'],
                        responses: [
                            (user) => `🆘 **Si estás experimentando una crisis, es importante que busques ayuda inmediata:**

📞 **Líneas de crisis disponibles 24/7**:
- Argentina: 135 (Desde CABA) o 0800-345-1435 (Todo el país)
- México: 800 911 2000 (Línea de la Vida)
- España: 024 (Prevención del suicidio)
- Colombia: 106 (Cruz Roja)
- Chile: 600 360 7777 (Salud Responde)
- Estados Unidos: 988 (Suicide and Crisis Lifeline)
- Internacional: https://www.iasp.info/resources/Crisis_Centres/

🏥 **Acude a emergencias** o contacta con tu profesional de salud mental.

Mientras tanto, puedo guiarte con técnicas de grounding para ayudarte en este momento. ¿Te gustaría probar una?`
                        ],
                        followUp: '¿Necesitas que te guíe con una técnica de emergencia mientras buscas ayuda profesional?',
                        priority: 0
                    },
                    despedida: {
                        triggers: ['adiós', 'chao', 'nos vemos', 'hasta luego', 'bye', 'gracias', 'thank you', 'me voy', 'hasta pronto'],
                        responses: [
                            (user) => `¡Ha sido un gusto ayudarte! Recuerda que estoy aquí para ti cuando me necesites.`,
                            (user) => `¡Hasta pronto! Cuídate y no dudes en volver si necesitas más apoyo.`,
                            (user) => `¡Nos vemos! Espero que las técnicas te sean útiles. Vuelve pronto.`
                        ],
                        followUp: null,
                        priority: 1
                    }
                };

                // Respuestas por defecto con más variedad y contexto
                this.defaultResponses = [
                    'Interesante pregunta. ¿Podrías contarme un poco más sobre lo que necesitas?',
                    'No estoy seguro de entender completamente. ¿Podrías reformularlo o darme más detalles?',
                    'Esa es una buena pregunta. ¿Está relacionada con alguna técnica específica o con el uso de la aplicación?',
                    'Puedo ayudarte mejor si me das más contexto. ¿Qué exactamente te gustaría saber o hacer?',
                    'Me interesa entender mejor tu consulta. ¿Podrías explicarme con otras palabras?'
                ];

                // Sugerencias contextuales mejoradas
                this.quickSuggestions = [
                    'Técnicas para ansiedad',
                    'Cómo dormir mejor',
                    'Ejercicio de respiración',
                    'Registrar mis emociones',
                    'Ver mi progreso',
                    'Cómo usar el diario'
                ];
            }
            
            // Cargar datos del usuario desde localStorage
            loadUserData() {
                const userData = this.storageManager.load('serenbot_user_data');
                if (userData) {
                    this.userName = userData.userName;
                    this.userMood = userData.userMood;
                    this.conversationHistory = userData.conversationHistory || [];
                    this.userPreferences = userData.userPreferences || {};
                    this.emotionalState = userData.emotionalState || {
                        mood: null,
                        intensity: 1,
                        triggers: [],
                        patterns: []
                    };
                    
                    console.log('Datos de usuario cargados correctamente');
                }
            }
            
            // Guardar datos del usuario en localStorage
            saveUserData() {
                const userData = {
                    userName: this.userName,
                    userMood: this.userMood,
                    conversationHistory: this.conversationHistory.slice(-30), // Guardar solo los últimos 30 mensajes
                    userPreferences: this.userPreferences,
                    emotionalState: this.emotionalState,
                    lastSave: new Date().toISOString()
                };
                
                const success = this.storageManager.save('serenbot_user_data', userData);
                if (success) {
                    console.log('Datos de usuario guardados correctamente');
                } else {
                    console.error('Error guardando datos de usuario');
                }
            }
            
            // Configurar recordatorios basados en preferencias
            setupReminders() {
                // Limpiar recordatorios anteriores
                if (this.reminderIntervals) {
                    this.reminderIntervals.forEach(interval => clearInterval(interval));
                }
                
                this.reminderIntervals = [];
                
                // Recordatorio para registro del estado de ánimo (si está activo en preferencias)
                if (this.userPreferences.moodReminders) {
                    const moodInterval = setInterval(() => {
                        const now = new Date();
                        // Solo enviar recordatorio entre las 8 AM y las 8 PM
                        if (now.getHours() >= 8 && now.getHours() < 20) {
                            const lastMoodRecord = this.userPreferences.lastMoodRecord;
                            const shouldRemind = !lastMoodRecord || 
                                              (new Date() - new Date(lastMoodRecord)) > 12 * 60 * 60 * 1000; // 12 horas
                            
                            if (shouldRemind) {
                                this.notificationManager.showNotification(
                                    'Serenamente', 
                                    {
                                        body: '¿Cómo te sientes hoy? Es un buen momento para registrar tu estado de ánimo.',
                                        icon: '/favicon.ico'
                                    }
                                );
                            }
                        }
                    }, 60 * 60 * 1000); // Revisar cada hora
                    
                    this.reminderIntervals.push(moodInterval);
                }
                
                // Recordatorio para prácticas de mindfulness (si está activo en preferencias)
                if (this.userPreferences.mindfulnessReminders) {
                    const mindfulnessInterval = setInterval(() => {
                        const now = new Date();
                        // Horarios sugeridos: 9 AM, 1 PM, 6 PM
                        const reminderTimes = [9, 13, 18];
                        if (reminderTimes.includes(now.getHours()) && now.getMinutes() === 0) {
                            this.notificationManager.showNotification(
                                'Serenamente', 
                                {
                                    body: 'Momento de mindfulness. ¿Te gustaría hacer un breve ejercicio de respiración?',
                                    icon: '/favicon.ico'
                                }
                            );
                        }
                    }, 60 * 1000); // Revisar cada minuto
                    
                    this.reminderIntervals.push(mindfulnessInterval);
                }
            }
            
            trainIntentModel() {
                try {
                    // Ejemplos de entrenamiento para el modelo de clasificación de intenciones
                    const trainingExamples = new Map();
                    
                    trainingExamples.set('saludos', ['hola', 'hola cómo estás', 'buenos días', 'buenas tardes', 'hey']);
                    trainingExamples.set('ayuda', ['necesito ayuda', 'qué puedes hacer', 'ayúdame', 'no sé usar la app']);
                    trainingExamples.set('tecnicas', ['técnicas de relajación', 'ejercicios para calmarme', 'cómo manejar la ansiedad']);
                    trainingExamples.set('sueno', ['no puedo dormir', 'tengo insomnio', 'cómo dormir mejor']);
                    trainingExamples.set('emociones', ['me siento triste', 'estoy ansioso', 'cómo manejar el enojo']);
                    trainingExamples.set('crisis', ['me siento muy mal', 'necesito ayuda urgente', 'estoy en crisis']);
                    
                    this.intentModel.train(trainingExamples);
                } catch (error) {
                    ErrorHandler.handle(error, 'training intent model');
                }
            }
            
            async processMessage(message) {
                try {
                    // Simular tiempo de procesamiento para una experiencia más natural
                    this.showTypingIndicator();
                    await this.delay(800 + Math.random() * 700);
                    
                    const normalizedMessage = message.toLowerCase().trim();
                    this.addToConversationHistory('user', message);
                    
                    // Análisis de sentimiento mejorado
                    const sentiment = this.analyzeSentiment(normalizedMessage);
                    this.updateEmotionalState(sentiment, normalizedMessage);
                    
                    // Detectar y almacenar el nombre del usuario
                    if (!this.userName && this.isNameIntroduction(normalizedMessage)) {
                        this.userName = this.extractName(normalizedMessage);
                        const response = `¡Mucho gusto, ${this.userName}! Es un placer conocerte. ¿En qué puedo ayudarte hoy?`;
                        this.addToConversationHistory('bot', response);
                        this.hideTypingIndicator();
                        
                        // Guardar datos después de obtener el nombre
                        this.saveUserData();
                        return response;
                    }
                    
                    // Clasificar la intención usando el modelo
                    const intent = this.intentModel.predict(normalizedMessage);
                    
                    // Detectar estado de ánimo
                    const detectedMood = this.detectMood(normalizedMessage);
                    if (detectedMood && !this.waitingForInput) {
                        this.userMood = detectedMood;
                        this.userPreferences.lastMoodRecord = new Date().toISOString();
                        this.lastInteraction = 'mood_detection';
                        const response = this.knowledgeBase.emociones.responses[0](detectedMood);
                        this.waitingForInput = true;
                        this.addToConversationHistory('bot', response);
                        this.hideTypingIndicator();
                        
                        // Guardar datos después de detectar el estado de ánimo
                        this.saveUserData();
                        return response;
                    }
                    
                    // Manejar respuestas de seguimiento
                    if (this.waitingForInput) {
                        const response = this.handleFollowUp(normalizedMessage);
                        this.addToConversationHistory('bot', response);
                        this.hideTypingIndicator();
                        
                        // Guardar datos después de seguimiento
                        this.saveUserData();
                        return response;
                    }
                    
                    // Buscar en la base de conocimiento basado en la intención clasificada
                    if (this.knowledgeBase[intent]) {
                        this.currentContext = intent;
                        
                        let response;
                        if (intent === 'emociones' && this.userMood) {
                            response = this.knowledgeBase[intent].responses[0](this.userMood);
                        } else {
                            const responses = this.knowledgeBase[intent].responses;
                            response = typeof responses[0] === 'function' ? 
                                      responses[0]({name: this.userName, mood: this.userMood}) : 
                                      responses[Math.floor(Math.random() * responses.length)];
                        }
                        
                        // Agregar pregunta de seguimiento si existe
                        if (this.knowledgeBase[intent].followUp && !this.waitingForInput) {
                            this.waitingForInput = true;
                            response = response + '\n\n' + this.knowledgeBase[intent].followUp;
                        }
                        
                        this.addToConversationHistory('bot', response);
                        this.hideTypingIndicator();
                        
                        // Guardar datos después de procesar la intención
                        this.saveUserData();
                        return response;
                    }
                    
                    // Si no encuentra coincidencia, respuesta por defecto mejorada
                    const defaultResponse = this.defaultResponses[Math.floor(Math.random() * this.defaultResponses.length)];
                    const enhancedResponse = defaultResponse + '\n\nPuedes preguntarme sobre:\n• Técnicas de relajación\n• Cómo manejar emociones difíciles\n• Estrategias para dormir mejor\n• Uso del diario emocional\n• Seguimiento de tu progreso';
                    
                    this.addToConversationHistory('bot', enhancedResponse);
                    this.hideTypingIndicator();
                    
                    // Guardar datos después de respuesta por defecto
                    this.saveUserData();
                    return enhancedResponse;
                } catch (error) {
                    this.hideTypingIndicator();
                    return ErrorHandler.handle(error, 'processing message');
                }
            }
            
            analyzeSentiment(message) {
                try {
                    // Algoritmo mejorado de análisis de sentimiento
                    const positiveWords = ['bien', 'feliz', 'contento', 'genial', 'maravilloso', 'agradecido', 'optimista', 'alegre', 'emocionado'];
                    const negativeWords = ['mal', 'triste', 'ansioso', 'estresado', 'enojado', 'preocupado', 'asustado', 'nervioso', 'desbordado', 'agobiado', 'frustrado'];
                    const intenseWords = ['muy', 'mucho', 'extremadamente', 'realmente', 'totalmente', 'completamente'];
                    
                    const words = message.toLowerCase().split(/\s+/);
                    let score = 0;
                    let intensity = 1;
                    
                    words.forEach(word => {
                        if (positiveWords.includes(word)) score += 1;
                        if (negativeWords.includes(word)) score -= 1;
                        if (intenseWords.includes(word)) intensity += 0.5;
                    });
                    
                    return { score, intensity };
                } catch (error) {
                    ErrorHandler.handle(error, 'analyzing sentiment');
                    return { score: 0, intensity: 1 };
                }
            }
            
            updateEmotionalState(sentiment, message) {
                try {
                    // Actualizar el estado emocional basado en el análisis de sentimiento
                    if (sentiment.score > 0) {
                        this.emotionalState.mood = 'positive';
                    } else if (sentiment.score < 0) {
                        this.emotionalState.mood = 'negative';
                    } else {
                        this.emotionalState.mood = 'neutral';
                    }
                    
                    this.emotionalState.intensity = sentiment.intensity;
                    
                    // Extraer posibles desencadenantes emocionales
                    const triggerWords = ['porque', 'debido a', 'cuando', 'después de', 'por'];
                    const words = message.split(/\s+/);
                    
                    for (let i = 0; i < words.length; i++) {
                        if (triggerWords.includes(words[i]) && i < words.length - 1) {
                            this.emotionalState.triggers.push(words.slice(i + 1, i + 4).join(' '));
                        }
                    }
                    
                    // Limitar el historial de desencadenantes
                    if (this.emotionalState.triggers.length > 10) {
                        this.emotionalState.triggers = this.emotionalState.triggers.slice(-10);
                    }
                } catch (error) {
                    ErrorHandler.handle(error, 'updating emotional state');
                }
            }
            
            addToConversationHistory(role, message) {
                try {
                    this.conversationHistory.push({
                        role,
                        message,
                        timestamp: new Date(),
                        mood: this.emotionalState.mood,
                        intensity: this.emotionalState.intensity
                    });
                    
                    // Limitar el historial para no consumir demasiada memoria
                    if (this.conversationHistory.length > 50) {
                        this.conversationHistory = this.conversationHistory.slice(-50);
                    }
                } catch (error) {
                    ErrorHandler.handle(error, 'adding to conversation history');
                }
            }
            
            showTypingIndicator() {
                try {
                    const chatMessages = document.getElementById('chatMessages');
                    const typingIndicator = document.createElement('div');
                    typingIndicator.className = 'typing-indicator';
                    typingIndicator.id = 'typingIndicator';
                    typingIndicator.setAttribute('aria-label', 'El bot está escribiendo');
                    typingIndicator.innerHTML = `
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    `;
                    chatMessages.appendChild(typingIndicator);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } catch (error) {
                    ErrorHandler.handle(error, 'showing typing indicator');
                }
            }
            
            hideTypingIndicator() {
                try {
                    const typingIndicator = document.getElementById('typingIndicator');
                    if (typingIndicator) {
                        typingIndicator.remove();
                    }
                } catch (error) {
                    ErrorHandler.handle(error, 'hiding typing indicator');
                }
            }
            
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            
            isNameIntroduction(message) {
                try {
                    const namePatterns = [
                        /me llamo (\w+)/i,
                        /soy (\w+)/i,
                        /mi nombre es (\w+)/i,
                        /puedes llamarme (\w+)/i
                    ];
                    
                    return namePatterns.some(pattern => pattern.test(message));
                } catch (error) {
                    ErrorHandler.handle(error, 'checking name introduction');
                    return false;
                }
            }

            extractName(message) {
                try {
                    const patterns = [
                        /me llamo (\w+)/i,
                        /soy (\w+)/i,
                        /mi nombre es (\w+)/i,
                        /puedes llamarme (\w+)/i
                    ];
                    
                    for (const pattern of patterns) {
                        const match = message.match(pattern);
                        if (match) return match[1];
                    }
                    
                    return null;
                } catch (error) {
                    ErrorHandler.handle(error, 'extracting name');
                    return null;
                }
            }

            detectMood(message) {
                try {
                    const moodKeywords = {
                        triste: ['triste', 'deprimido', 'desanimado', 'desesperanzado', 'melancólico', 'apenado'],
                        ansioso: ['ansioso', 'nervioso', 'preocupado', 'agitado', 'intranquilo', 'atemorizado'],
                        estresado: ['estresado', 'agobiado', 'abrumado', 'presionado', 'tenso', 'frustrado'],
                        enojado: ['enojado', 'enfadado', 'furioso', 'molesto', 'irritado', 'airado'],
                        feliz: ['feliz', 'contento', 'alegre', 'optimista', 'entusiasmado', 'emocionado']
                    };
                    
                    for (const [mood, keywords] of Object.entries(moodKeywords)) {
                        if (keywords.some(keyword => message.includes(keyword))) {
                            return mood;
                        }
                    }
                    
                    return null;
                } catch (error) {
                    ErrorHandler.handle(error, 'detecting mood');
                    return null;
                }
            }

            handleFollowUp(message) {
                try {
                    this.waitingForInput = false;
                    
                    switch (this.currentContext) {
                        case 'emociones':
                            if (message.includes('sí') || message.includes('si') || message.includes('por favor')) {
                                return this.knowledgeBase.tecnicas.responses[0]({name: this.userName, mood: this.userMood});
                            }
                            break;
                            
                        case 'respiracion':
                            if (message.includes('sí') || message.includes('si') || message.includes('guiar')) {
                                return this.guidedBreathingExercise();
                            }
                            break;
                            
                        case 'sueno':
                            if (message.includes('conciliar')) {
                                return `Para conciliar el sueño, te recomiendo la **técnica 4-7-8** en la cama:
                                
1. Acuéstate boca arriba en una posición cómoda
2. Realiza 4-5 ciclos de respiración 4-7-8
3. Concéntrate solo en tu respiración
4. Si vienen pensamientos, acéptalos y vuelve a tu respiración

¿Te gustaría que te guíe con esta técnica ahora mismo?`;
                            } else if (message.includes('mantener')) {
                                return `Para mantener el sueño:
                                
- Establece una rutina consistente de sueño
- Evita alcohol y cafeína después de las 2 PM
- Crea un ambiente óptimo para dormir (fresco, oscuro y silencioso)
- Si te despiertas, evita mirar el reloj

¿Te gustaría más consejos sobre higiene del sueño?`;
                            }
                            break;
                            
                        default:
                            return 'Gracias por la información. ¿Hay algo más en lo que pueda ayudarte?';
                    }
                    
                    return 'Entiendo. ¿Hay algo más en lo que pueda ayudarte?';
                } catch (error) {
                    ErrorHandler.handle(error, 'handling follow-up');
                    return 'Gracias por la información. ¿Hay algo más en lo que pueda ayudarte?';
                }
            }

            guidedBreathingExercise() {
                return `Vamos a hacer juntos la técnica de respiración 4-7-8:

Paso 1: Siéntate cómodamente con la espalda recta o túmbate.
Paso 2: Coloca la punta de la lengua contra el paladar, detrás de los dientes frontales.
Paso 3: Exhala completamente por la boca, haciendo un sonido de susurro.
Paso 4: Cierra la boca e inhala silenciosamente por la nariz contando mentalmente hasta 4.
Paso 5: Aguanta la respiración contando mentalmente hasta 7.
Paso 6: Exhala completamente por la boca, haciendo un sonido de susurro, contando mentalmente hasta 8.
Paso 7: Este es un ciclo. Ahora inhala nuevamente y repite el ciclo 3 veces más.

¿Cómo te sientes después de completar el ejercicio?`;
            }
            
            // Método para generar sugerencias contextuales basadas en la conversación
            generateContextualSuggestions() {
                try {
                    if (this.conversationHistory.length < 2) {
                        return this.quickSuggestions;
                    }
                    
                    const lastMessage = this.conversationHistory[this.conversationHistory.length - 1].message.toLowerCase();
                    
                    if (lastMessage.includes('ans') || lastMessage.includes('preocup') || lastMessage.includes('nerv')) {
                        return ['Técnica de respiración 4-7-8', 'Ejercicio de grounding', 'Meditación guiada', 'Diario de preocupaciones'];
                    }
                    
                    if (lastMessage.includes('triste') || lastMessage.includes('depri') || lastMessage.includes('desanim')) {
                        return ['Autocompasión guiada', 'Diario de gratitud', 'Actividad placentera', 'Conectar con apoyo'];
                    }
                    
                    if (lastMessage.includes('sueño') || lastMessage.includes('dormir') || lastMessage.includes('insomnio')) {
                        return ['Rutina de sueño', 'Relajación muscular', 'Meditación para dormir', 'Higiene del sueño'];
                    }
                    
                    return this.quickSuggestions;
                } catch (error) {
                    ErrorHandler.handle(error, 'generating contextual suggestions');
                    return this.quickSuggestions;
                }
            }
        }

        // Inicializar y conectar con la interfaz
        document.addEventListener('DOMContentLoaded', function() {
            const chatMessages = document.getElementById('chatMessages');
            const userInput = document.getElementById('userInput');
            const sendButton = document.getElementById('sendButton');
            const quickSuggestions = document.getElementById('quickSuggestions');
            
            const serenBot = new EnhancedSerenBot();
            
            // Cargar historial de conversación previo si existe
            const savedHistory = StorageManager.load('serenbot_conversation_history');
            if (savedHistory && savedHistory.length > 0) {
                // Mantener solo el mensaje inicial del bot y agregar el historial guardado
                chatMessages.innerHTML = '';
                savedHistory.forEach(msg => {
                    addMessageToChat(msg.message, msg.role === 'user');
                });
            }
            
            // Función para añadir mensaje al chat
            function addMessageToChat(message, isUser = false) {
                const messageElement = document.createElement('div');
                messageElement.className = isUser ? 'message user-message' : 'message bot-message';
                
                const messageText = document.createElement('div');
                messageText.textContent = message;
                
                const messageTime = document.createElement('div');
                messageTime.className = 'message-time';
                messageTime.textContent = 'Ahora';
                
                messageElement.appendChild(messageText);
                messageElement.appendChild(messageTime);
                
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Guardar el historial de la conversación actual
                saveConversationHistory();
            }
            
            // Guardar historial de conversación
            function saveConversationHistory() {
                const messages = Array.from(chatMessages.querySelectorAll('.message')).map(msg => {
                    return {
                        role: msg.classList.contains('user-message') ? 'user' : 'bot',
                        message: msg.querySelector('div:first-child').textContent,
                        timestamp: new Date()
                    };
                });
                
                StorageManager.save('serenbot_conversation_history', messages);
            }
            
            // Función para enviar mensaje
            async function sendMessage() {
                const message = userInput.value.trim();
                if (message) {
                    addMessageToChat(message, true);
                    userInput.value = '';
                    
                    const response = await serenBot.processMessage(message);
                    addMessageToChat(response, false);
                    
                    // Actualizar sugerencias
                    updateQuickSuggestions();
                }
            }
            
            // Función para actualizar sugerencias rápidas
            function updateQuickSuggestions() {
                const suggestions = serenBot.generateContextualSuggestions();
                quickSuggestions.innerHTML = '';
                
                suggestions.forEach(suggestion => {
                    const chip = document.createElement('div');
                    chip.className = 'suggestion-chip';
                    chip.textContent = suggestion;
                    chip.setAttribute('role', 'button');
                    chip.setAttribute('aria-label', `Sugerencia: ${suggestion}`);
                    chip.addEventListener('click', () => {
                        userInput.value = suggestion;
                        sendMessage();
                    });
                    quickSuggestions.appendChild(chip);
                });
            }
            
            // Event listeners
            sendButton.addEventListener('click', sendMessage);
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Inicializar sugerencias
            updateQuickSuggestions();
            
            // Configurar evento para guardar datos antes de cerrar la página
            window.addEventListener('beforeunload', () => {
                serenBot.saveUserData();
                saveConversationHistory();
            });
        });
    </script>
</body>
</html>
