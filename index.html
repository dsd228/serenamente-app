<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Serenamente - Apoyo Emocional Integral</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* (puedes pegar aquí tus estilos existentes...) */
    /* ...botón y ventana de chatbot como en ejemplos anteriores... */
  </style>
</head>
<body>
  <!-- Botón flotante del chatbot -->
  <button class="chatbot-button" id="openChatbotBtn" aria-label="Abrir Chatbot" style="position: fixed; bottom: 30px; right: 30px; z-index: 1001;">
    <i class="fa-solid fa-comments"></i>
  </button>
  <!-- Ventana del chatbot -->
  <div id="chatbotWindow" class="chatbot-window hidden" style="position: fixed; bottom: 90px; right: 30px; width: 330px; max-width: 90vw; background: white; border-radius: 18px; box-shadow: 0 10px 24px rgba(67, 97, 238, 0.18); z-index: 1002; display: flex; flex-direction: column; overflow: hidden; border: 2px solid #4361ee;">
    <div style="background: linear-gradient(135deg, #4361ee, #3a0ca3); color: white; padding: 18px; font-weight: 600; display: flex; align-items: center; justify-content: space-between;">
      <span><i class="fa-solid fa-robot"></i> Chatbot Serenamente</span>
      <button id="closeChatbotBtn" aria-label="Cerrar Chatbot" style="background:none;border:none;color:white;font-size:1.3rem;cursor:pointer;"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div id="chatbotMessages" style="flex:1; padding:16px; background: #f8fafc; overflow-y:auto; font-size: 1rem;">
      <div style="margin-bottom: 12px; color: #64748b;">¡Hola! Soy tu asistente virtual, especializado en bienestar emocional. ¿Cómo puedo apoyarte hoy?</div>
    </div>
    <form id="chatbotForm" style="display:flex;gap:8px;padding:12px;background:#f1f5f9;border-top:1px solid #e2e8f0;">
      <input id="chatbotInput" type="text" autocomplete="off" placeholder="Escribe tu mensaje..." style="flex:1;padding:10px;border-radius:8px;border:1px solid #ddd;">
      <button type="submit" style="background:#4361ee;color:white;border:none;border-radius:8px;padding:0 14px;cursor:pointer;font-size:1.1rem;"><i class="fa-solid fa-paper-plane"></i></button>
    </form>
  </div>
  <script>
    const openBtn = document.getElementById('openChatbotBtn');
    const closeBtn = document.getElementById('closeChatbotBtn');
    const chatbotWindow = document.getElementById('chatbotWindow');
    const chatbotForm = document.getElementById('chatbotForm');
    const chatbotInput = document.getElementById('chatbotInput');
    const chatbotMessages = document.getElementById('chatbotMessages');

    openBtn.addEventListener('click', () => {
      chatbotWindow.classList.remove('hidden');
      chatbotInput.focus();
    });
    closeBtn.addEventListener('click', () => {
      chatbotWindow.classList.add('hidden');
    });

    chatbotForm.addEventListener('submit', async function(e){
      e.preventDefault();
      const msg = chatbotInput.value.trim();
      if(!msg) return;
      appendMessage(msg, 'user');
      chatbotInput.value = '';
      appendMessage("Escribiendo...", 'bot', true);

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ message: msg })
        });
        const data = await res.json();
        removeWriting();
        appendMessage(data.reply, 'bot');
      } catch {
        removeWriting();
        appendMessage('Lo siento, hubo un error al conectar con el asistente.', 'bot');
      }
    });

    function appendMessage(text, sender, writing){
      const msgDiv = document.createElement('div');
      msgDiv.style.margin = '8px 0';
      msgDiv.style.maxWidth = '80%';
      msgDiv.style.padding = '9px 13px';
      msgDiv.style.borderRadius = '12px';
      msgDiv.style.wordBreak = 'break-word';
      msgDiv.style.fontSize = '1rem';
      msgDiv.className = writing ? 'writing-msg' : '';
      if(sender === 'user'){
        msgDiv.style.background = '#4361ee';
        msgDiv.style.color = 'white';
        msgDiv.style.marginLeft = 'auto';
        msgDiv.style.textAlign = 'right';
      } else {
        msgDiv.style.background = '#e0e7ef';
        msgDiv.style.color = '#475569';
        msgDiv.style.marginRight = 'auto';
        msgDiv.style.textAlign = 'left';
      }
      msgDiv.textContent = text;
      chatbotMessages.appendChild(msgDiv);
      chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    }
    function removeWriting(){
      const writing = chatbotMessages.querySelector('.writing-msg');
      if(writing) writing.remove();
    }
  </script>
</body>
</html>
