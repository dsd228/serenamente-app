<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SerenBot Avanzado</title>
    <style>
        :root {
            --primary: #4e7ae6;
            --secondary: #7c4dff;
            --background: #f8f9fa;
            --surface: #ffffff;
            --on-surface: #212121;
            --on-primary: #ffffff;
            --success: #4caf50;
            --warning: #ff9800;
            --error: #f44336;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--background);
            color: var(--on-surface);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .chat-container {
            width: 100%;
            max-width: 800px;
            height: 90vh;
            background-color: var(--surface);
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--on-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .chat-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.5;
            position: relative;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            align-self: flex-end;
            background-color: var(--primary);
            color: var(--on-primary);
            border-bottom-right-radius: 4px;
        }
        
        .bot-message {
            align-self: flex-start;
            background-color: #eef2f8;
            color: var(--on-surface);
            border-bottom-left-radius: 4px;
        }
        
        .chat-input {
            padding: 16px;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            gap: 12px;
        }
        
        .chat-input input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 24px;
            outline: none;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .chat-input input:focus {
            border-color: var(--primary);
        }
        
        .chat-input button {
            padding: 12px 20px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .chat-input button:hover {
            background-color: #3b5fc0;
        }
        
        .quick-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 0 16px 16px;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
        }
        
        .suggestion-chip {
            padding: 8px 16px;
            background-color: #eef2f8;
            border-radius: 16px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .suggestion-chip:hover {
            background-color: #dfe6f3;
        }
        
        .typing-indicator {
            align-self: flex-start;
            background-color: #eef2f8;
            padding: 12px 16px;
            border-radius: 18px;
            display: flex;
            gap: 4px;
            margin-bottom: 8px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: #9e9e9e;
            border-radius: 50%;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }
        
        .message-time {
            font-size: 0.7rem;
            margin-top: 4px;
            opacity: 0.7;
        }

        .notification-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--surface);
            color: var(--on-surface);
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s;
            z-index: 1000;
        }

        .notification-toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        @media (max-width: 600px) {
            .chat-container {
                height: 95vh;
                border-radius: 12px;
            }
            
            .message {
                max-width: 90%;
            }
            
            .chat-header h1 {
                font-size: 1.3rem;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h1>SerenBot</h1>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message bot-message">
                ¬°Hola! Soy SerenBot, tu asistente virtual en Serenamente. Estoy aqu√≠ para ayudarte con tu bienestar emocional. ¬øC√≥mo te sientes hoy?
                <div class="message-time">Ahora</div>
            </div>
        </div>
        <div class="quick-suggestions" id="quickSuggestions">
            <div class="suggestion-chip">T√©cnicas para ansiedad</div>
            <div class="suggestion-chip">C√≥mo dormir mejor</div>
            <div class="suggestion-chip">Ejercicio de respiraci√≥n</div>
            <div class="suggestion-chip">Registrar mis emociones</div>
        </div>
        <div class="chat-input">
            <input type="text" id="userInput" placeholder="Escribe tu mensaje aqu√≠..." autocomplete="off" aria-label="Escribe tu mensaje">
            <button id="sendButton" aria-label="Enviar mensaje">Enviar</button>
        </div>
    </div>

    <div class="notification-toast" id="notificationToast"></div>

    <script>
        // Clase de utilidades para localStorage
        class StorageManager {
            static save(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    return true;
                } catch (e) {
                    console.error('Error guardando en localStorage:', e);
                    return false;
                }
            }
            
            static load(key) {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch (e) {
                    console.error('Error cargando desde localStorage:', e);
                    return null;
                }
            }
            
            static clear(key) {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (e) {
                    console.error('Error limpiando localStorage:', e);
                    return false;
                }
            }
        }

        // Gestor de notificaciones
        class NotificationManager {
            constructor() {
                this.toast = document.getElementById('notificationToast');
                this.notificationPermission = false;
                
                // Solicitar permiso para notificaciones
                if ('Notification' in window) {
                    Notification.requestPermission().then(permission => {
                        this.notificationPermission = permission === 'granted';
                    });
                }
            }
            
            showNotification(title, options = {}) {
                // Notificaci√≥n del navegador
                if (this.notificationPermission) {
                    const notification = new Notification(title, {
                        icon: '/favicon.ico',
                        badge: '/favicon.ico',
                        ...options
                    });
                    
                    notification.onclick = () => {
                        window.focus();
                        notification.close();
                    };
                    
                    return notification;
                }
                
                // Toast como fallback
                this.showToast(title);
                return null;
            }
            
            showToast(message, duration = 3000) {
                this.toast.textContent = message;
                this.toast.classList.add('show');
                
                setTimeout(() => {
                    this.toast.classList.remove('show');
                }, duration);
            }
        }

        // Gestor de errores
        class ErrorHandler {
            static handle(error, context = '') {
                console.error(`Error en ${context}:`, error);
                
                // En un entorno real, enviar√≠amos este error a un servicio de tracking
                // Por ahora solo lo registramos en consola
                
                return `Lo siento, ha ocurrido un error procesando tu solicitud. Por favor, int√©ntalo de nuevo.`;
            }
        }

        // SerenBot mejorado con algoritmos avanzados
        class EnhancedSerenBot {
            constructor() {
                this.isOpen = true;
                this.messages = [];
                this.currentContext = 'general';
                this.waitingForInput = false;
                this.userName = null;
                this.userMood = null;
                this.lastInteraction = null;
                this.conversationHistory = [];
                this.userPreferences = {};
                this.emotionalState = {
                    mood: null,
                    intensity: 1,
                    triggers: [],
                    patterns: []
                };
                
                // Inicializar managers
                this.storageManager = StorageManager;
                this.notificationManager = new NotificationManager();
                
                // Cargar datos guardados
                this.loadUserData();
                
                // Configurar recordatorios
                this.setupReminders();
                
                // Modelo de clasificaci√≥n de intenciones mejorado
                this.intentModel = {
                    vocabulary: new Set(),
                    intents: {},
                    train: function(examples) {
                        examples.forEach((example, intent) => {
                            if (!this.intents[intent]) this.intents[intent] = { count: 0, words: {} };
                            
                            const words = example.toLowerCase().split(/\s+/);
                            words.forEach(word => {
                                this.vocabulary.add(word);
                                this.intents[intent].words[word] = (this.intents[intent].words[word] || 0) + 1;
                            });
                            
                            this.intents[intent].count++;
                        });
                    },
                    predict: function(text) {
                        try {
                            const words = text.toLowerCase().split(/\s+/);
                            let bestIntent = null;
                            let bestScore = 0;
                            
                            for (const intent in this.intents) {
                                let score = 0;
                                words.forEach(word => {
                                    if (this.intents[intent].words[word]) {
                                        score += this.intents[intent].words[word];
                                    }
                                });
                                
                                // Normalizar por longitud del texto e importancia de la intenci√≥n
                                score = score / words.length / this.intents[intent].count;
                                
                                if (score > bestScore) {
                                    bestScore = score;
                                    bestIntent = intent;
                                }
                            }
                            
                            return bestScore > 0.3 ? bestIntent : 'unknown';
                        } catch (error) {
                            ErrorHandler.handle(error, 'predict intent');
                            return 'unknown';
                        }
                    }
                };
                
                // Entrenar el modelo con ejemplos
                this.trainIntentModel();
                
                // Conocimiento mejorado con m√°s profundidad t√©cnica
                this.knowledgeBase = {
                    saludos: {
                        triggers: ['hola', 'hey', 'buenas', 'buenos d√≠as', 'buenas tardes', 'buenas noches', 'hi', 'hello', 'saludos'],
                        responses: [
                            (user) => `¬°Hola${user.name ? ' ' + user.name : ''}! Soy SerenBot, tu asistente virtual en Serenamente. ¬øC√≥mo te sientes hoy?`,
                            (user) => `¬°Hola! Me alegra verte por aqu√≠${user.name ? ' ' + user.name : ''}. ¬øEn qu√© puedo ayudarte hoy?`,
                            (user) => `¬°Hola${user.name ? ' ' + user.name : ''}! Espero que est√©s teniendo un buen d√≠a. ¬øHay algo en lo que pueda asistirte?`
                        ],
                        followUp: '¬øTe gustar√≠a que te cuente m√°s sobre lo que puedo hacer por ti?',
                        priority: 1
                    },
                    ayuda: {
                        triggers: ['ayuda', 'help', 'qu√© puedes hacer', 'que puedes hacer', 'funciones', 'comandos', 'asistencia'],
                        responses: [
                            (user) => `Puedo ayudarte en muchas √°reas de tu bienestar emocional:

üß† **Apoyo Emocional**: T√©cnicas para manejar ansiedad, estr√©s y emociones dif√≠ciles
üåô **Sue√±o y Relajaci√≥n**: Ejercicios para dormir mejor y reducir el insomnio
üìä **Seguimiento**: Ayuda para registrar y entender tus patrones emocionales
üîç **Navegaci√≥n**: Guiarte por las diferentes secciones de Serenamente
üí° **Educaci√≥n**: Explicarte conceptos de salud mental y t√©cnicas terap√©uticas

¬øHay algo espec√≠fico con lo que necesites ayuda?`
                        ],
                        followUp: '¬øTe interesa alguna de estas √°reas en particular?',
                        priority: 1
                    },
                    tecnicas: {
                        triggers: ['t√©cnicas', 'tecnicas', 'ejercicios', 'm√©todos', 'metodos', 'herramientas', 'qu√© hacer', 'que hacer'],
                        responses: [
                            (user) => `Serenamente ofrece t√©cnicas profesionales basadas en evidencia cient√≠fica:

1. üß† **T√©cnicas Cognitivas**: 
   - Reestructuraci√≥n cognitiva para pensamientos negativos
   - Detecci√≥n de distorsiones cognitivas
   - Diario de pensamientos

2. ü´Å **Regulaci√≥n Fisiol√≥gica**:
   - Respiraci√≥n 4-7-8 para ansiedad inmediata
   - Relajaci√≥n muscular progresiva de Jacobson
   - T√©cnicas de grounding (5-4-3-2-1)

3. üßò **Mindfulness y Atenci√≥n Plena**:
   - Meditaciones guiadas por tiempo
   - Body scan para conexi√≥n corporal
   - Mindfulness en actividades cotidianas

4. üíù **Autocompasi√≥n y Autoaceptaci√≥n**:
   - Ejercicios basados en el trabajo de Kristin Neff
   - Cartas de autocompasi√≥n
   - Meditaciones de bondad amorosa

¬øTe gustar√≠a que profundice en alguna t√©cnica en particular?`
                        ],
                        followUp: '¬øQu√© tipo de t√©cnica te interesa m√°s: cognitivas, de respiraci√≥n, mindfulness o autocompasi√≥n?',
                        priority: 2
                    },
                    emociones: {
                        triggers: ['triste', 'ansioso', 'estresado', 'enojado', 'preocupado', 'asustado', 'nervioso', 'desbordado', 'agobiado', 'frustrado'],
                        responses: [
                            (mood) => {
                                const empathy = {
                                    triste: `Lamento escuchar que te sientes triste. La tristeza es una emoci√≥n natural que nos indica que algo nos importa. ¬øTe gustar√≠a probar una t√©cnica para procesar esta emoci√≥n?`,
                                    ansioso: `Entiendo que te sientas ansioso. La ansiedad puede ser abrumadora, pero hay t√©cnicas espec√≠ficas que pueden ayudarte a regularla. ¬øQuieres que te gu√≠e con alguna?`,
                                    estresado: `El estr√©s puede ser dif√≠cil de manejar. Afortunadamente, hay ejercicios de respiraci√≥n y relajaci√≥n que pueden ayudarte a reducir la sensaci√≥n de estr√©s. ¬øTe interesa probar uno?`,
                                    enojado: `El enojo es una emoci√≥n v√°lida que nos indica que algo nos importa. Hay formas saludables de expresarlo y canalizarlo. ¬øTe gustar√≠a explorar algunas t√©cnicas?`,
                                    general: `Aprecio que compartas c√≥mo te sientes. Las emociones dif√≠ciles son parte de la experiencia humana. ¬øTe gustar√≠a probar alguna t√©cnica para manejar lo que est√°s experimentando?`
                                };
                                
                                return empathy[mood] || empathy.general;
                            }
                        ],
                        followUp: '¬øQuieres que te gu√≠e con alguna t√©cnica espec√≠fica para manejar esta emoci√≥n?',
                        priority: 3
                    },
                    respiracion: {
                        triggers: ['respiraci√≥n', 'respiracion', 'respirar', 'ansiedad', 'p√°nico', 'panico', 'calmarme', 'relajarme', 'hiperventilar', 'ataque'],
                        responses: [
                            (user) => `Te recomiendo la **t√©cnica de respiraci√≥n 4-7-8**, desarrollada por el Dr. Andrew Weil:

üå¨Ô∏è **Instrucciones**:
1. Si√©ntate con la espalda recta o t√∫mbate c√≥modamente
2. Coloca la punta de la lengua contra el paladar, detr√°s de los dientes frontales
3. **Exhala** completamente por la boca
4. **Inhala** por la nariz durante 4 segundos
5. **Aguanta** la respiraci√≥n durante 7 segundos
6. **Exhala** completamente por la boca durante 8 segundos
7. Repite este ciclo **4 veces**

¬øTe gustar√≠a que te gu√≠e paso a paso con esta t√©cnica o prefieres otra opci√≥n?`
                        ],
                        followUp: '¬øQuieres que inicie una sesi√≥n guiada de respiraci√≥n ahora?',
                        priority: 2
                    },
                    sueno: {
                        triggers: ['dormir', 'insomnio', 'desvelado', 'sue√±o', 'sueno', 'no puedo dormir', 'despertar', 'noche'],
                        responses: [
                            (user) => `El insomnio puede ser dif√≠cil de manejar. Te sugiero varias aproximaciones:

üåô **Higiene del sue√±o**:
- Establece un horario regular para dormir
- Crea un ritual relajante antes de acostarte
- Evita pantallas 1-2 horas antes de dormir
- Mant√©n tu habitaci√≥n fresca, oscura y silenciosa

üõå **T√©cnicas para conciliar el sue√±o**:
- Respiraci√≥n 4-7-8 acostado en la cama
- Relajaci√≥n muscular progresiva
- Visualizaci√≥n de escenas tranquilas

üí° **Si te despiertas en la noche**:
- Lev√°ntate si no logras dormirte en 20 minutos
- Haz algo relajante con luz tenue
- Vuelve a la cama solo cuando tengas sue√±o

¬øTe gustar√≠a que profundice en alguna de estas estrategias?`
                        ],
                        followUp: '¬øQu√© aspecto del sue√±o te preocupa m√°s: conciliar el sue√±o, mantenerlo o despertarte muy temprano?',
                        priority: 2
                    },
                    diario: {
                        triggers: ['diario', 'escribir', 'registrar', 'pensamientos', 'emociones', 'sentimientos', 'expresar'],
                        responses: [
                            (user) => `El diario emocional es una herramienta poderosa con m√∫ltiples beneficios:

üìù **Beneficios del diario**:
- Ayuda a procesar y comprender emociones
- Identifica patrones de pensamiento
- Reduce la rumiaci√≥n y el estr√©s
- Promueve la autoconciencia y el crecimiento

üîç **Enfoques efectivos**:
1. **Diario de pensamientos**: Registra situaci√≥n, emoci√≥n y pensamiento autom√°tico
2. **Diario de gratitud**: Anota 3 cosas por las que est√©s agradecido
3. **Escritura expresiva**: Escribe sobre experiencias emocionales intensas
4. **Diario de soluciones**: Enf√≥cate en posibles soluciones m√°s que en problemas

¬øTe gustar√≠a que te gu√≠e con alg√∫n tipo espec√≠fico de diario?`
                        ],
                        followUp: '¬øQu√© tipo de diario te interesar√≠a probar: de pensamientos, de gratitud o expresivo?',
                        priority: 2
                    },
                    progreso: {
                        triggers: ['progreso', 'avance', 'estad√≠sticas', 'estadisticas', 'seguimiento', 'mejora', 'evoluci√≥n', 'evolucion', 'resultados'],
                        responses: [
                            (user) => `En Serenamente puedes hacer seguimiento de tu bienestar de varias formas:

üìä **M√©tricas de seguimiento**:
- Estado de √°nimo diario (gr√°ficos de evoluci√≥n)
- Frecuencia de uso de t√©cnicas
- Patrones de sue√±o y energ√≠a
- Niveles de estr√©s y ansiedad

üìà **Beneficios del seguimiento**:
- Identifica factores que afectan tu bienestar
- Detecta patrones y tendencias
- Celebra progresos y mejoras
- Ajusta estrategias seg√∫n lo que funcione para ti

¬øTe gustar√≠a aprender a registrar tu estado de √°nimo o ver tutoriales sobre c√≥mo interpretar tus estad√≠sticas?`
                        ],
                        followUp: '¬øQu√© te interesa m√°s: registrar tu estado de √°nimo actual o revisar tu progreso hist√≥rico?',
                        priority: 2
                    },
                    crisis: {
                        triggers: ['crisis', 'suicidio', 'emergencia', 'mal', 'muy mal', 'ayuda urgente', 'no puedo m√°s', 'sin esperanza', 'desesperado'],
                        responses: [
                            (user) => `üÜò **Si est√°s experimentando una crisis, es importante que busques ayuda inmediata:**

üìû **L√≠neas de crisis disponibles 24/7**:
- Argentina: 135 (Desde CABA) o 0800-345-1435 (Todo el pa√≠s)
- M√©xico: 800 911 2000 (L√≠nea de la Vida)
- Espa√±a: 024 (Prevenci√≥n del suicidio)
- Colombia: 106 (Cruz Roja)
- Chile: 600 360 7777 (Salud Responde)
- Estados Unidos: 988 (Suicide and Crisis Lifeline)
- Internacional: https://www.iasp.info/resources/Crisis_Centres/

üè• **Acude a emergencias** o contacta con tu profesional de salud mental.

Mientras tanto, puedo guiarte con t√©cnicas de grounding para ayudarte en este momento. ¬øTe gustar√≠a probar una?`
                        ],
                        followUp: '¬øNecesitas que te gu√≠e con una t√©cnica de emergencia mientras buscas ayuda profesional?',
                        priority: 0
                    },
                    despedida: {
                        triggers: ['adi√≥s', 'chao', 'nos vemos', 'hasta luego', 'bye', 'gracias', 'thank you', 'me voy', 'hasta pronto'],
                        responses: [
                            (user) => `¬°Ha sido un gusto ayudarte! Recuerda que estoy aqu√≠ para ti cuando me necesites.`,
                            (user) => `¬°Hasta pronto! Cu√≠date y no dudes en volver si necesitas m√°s apoyo.`,
                            (user) => `¬°Nos vemos! Espero que las t√©cnicas te sean √∫tiles. Vuelve pronto.`
                        ],
                        followUp: null,
                        priority: 1
                    }
                };

                // Respuestas por defecto con m√°s variedad y contexto
                this.defaultResponses = [
                    'Interesante pregunta. ¬øPodr√≠as contarme un poco m√°s sobre lo que necesitas?',
                    'No estoy seguro de entender completamente. ¬øPodr√≠as reformularlo o darme m√°s detalles?',
                    'Esa es una buena pregunta. ¬øEst√° relacionada con alguna t√©cnica espec√≠fica o con el uso de la aplicaci√≥n?',
                    'Puedo ayudarte mejor si me das m√°s contexto. ¬øQu√© exactamente te gustar√≠a saber o hacer?',
                    'Me interesa entender mejor tu consulta. ¬øPodr√≠as explicarme con otras palabras?'
                ];

                // Sugerencias contextuales mejoradas
                this.quickSuggestions = [
                    'T√©cnicas para ansiedad',
                    'C√≥mo dormir mejor',
                    'Ejercicio de respiraci√≥n',
                    'Registrar mis emociones',
                    'Ver mi progreso',
                    'C√≥mo usar el diario'
                ];
            }
            
            // Cargar datos del usuario desde localStorage
            loadUserData() {
                const userData = this.storageManager.load('serenbot_user_data');
                if (userData) {
                    this.userName = userData.userName;
                    this.userMood = userData.userMood;
                    this.conversationHistory = userData.conversationHistory || [];
                    this.userPreferences = userData.userPreferences || {};
                    this.emotionalState = userData.emotionalState || {
                        mood: null,
                        intensity: 1,
                        triggers: [],
                        patterns: []
                    };
                    
                    console.log('Datos de usuario cargados correctamente');
                }
            }
            
            // Guardar datos del usuario en localStorage
            saveUserData() {
                const userData = {
                    userName: this.userName,
                    userMood: this.userMood,
                    conversationHistory: this.conversationHistory.slice(-30), // Guardar solo los √∫ltimos 30 mensajes
                    userPreferences: this.userPreferences,
                    emotionalState: this.emotionalState,
                    lastSave: new Date().toISOString()
                };
                
                const success = this.storageManager.save('serenbot_user_data', userData);
                if (success) {
                    console.log('Datos de usuario guardados correctamente');
                } else {
                    console.error('Error guardando datos de usuario');
                }
            }
            
            // Configurar recordatorios basados en preferencias
            setupReminders() {
                // Limpiar recordatorios anteriores
                if (this.reminderIntervals) {
                    this.reminderIntervals.forEach(interval => clearInterval(interval));
                }
                
                this.reminderIntervals = [];
                
                // Recordatorio para registro del estado de √°nimo (si est√° activo en preferencias)
                if (this.userPreferences.moodReminders) {
                    const moodInterval = setInterval(() => {
                        const now = new Date();
                        // Solo enviar recordatorio entre las 8 AM y las 8 PM
                        if (now.getHours() >= 8 && now.getHours() < 20) {
                            const lastMoodRecord = this.userPreferences.lastMoodRecord;
                            const shouldRemind = !lastMoodRecord || 
                                              (new Date() - new Date(lastMoodRecord)) > 12 * 60 * 60 * 1000; // 12 horas
                            
                            if (shouldRemind) {
                                this.notificationManager.showNotification(
                                    'Serenamente', 
                                    {
                                        body: '¬øC√≥mo te sientes hoy? Es un buen momento para registrar tu estado de √°nimo.',
                                        icon: '/favicon.ico'
                                    }
                                );
                            }
                        }
                    }, 60 * 60 * 1000); // Revisar cada hora
                    
                    this.reminderIntervals.push(moodInterval);
                }
                
                // Recordatorio para pr√°cticas de mindfulness (si est√° activo en preferencias)
                if (this.userPreferences.mindfulnessReminders) {
                    const mindfulnessInterval = setInterval(() => {
                        const now = new Date();
                        // Horarios sugeridos: 9 AM, 1 PM, 6 PM
                        const reminderTimes = [9, 13, 18];
                        if (reminderTimes.includes(now.getHours()) && now.getMinutes() === 0) {
                            this.notificationManager.showNotification(
                                'Serenamente', 
                                {
                                    body: 'Momento de mindfulness. ¬øTe gustar√≠a hacer un breve ejercicio de respiraci√≥n?',
                                    icon: '/favicon.ico'
                                }
                            );
                        }
                    }, 60 * 1000); // Revisar cada minuto
                    
                    this.reminderIntervals.push(mindfulnessInterval);
                }
            }
            
            trainIntentModel() {
                try {
                    // Ejemplos de entrenamiento para el modelo de clasificaci√≥n de intenciones
                    const trainingExamples = new Map();
                    
                    trainingExamples.set('saludos', ['hola', 'hola c√≥mo est√°s', 'buenos d√≠as', 'buenas tardes', 'hey']);
                    trainingExamples.set('ayuda', ['necesito ayuda', 'qu√© puedes hacer', 'ay√∫dame', 'no s√© usar la app']);
                    trainingExamples.set('tecnicas', ['t√©cnicas de relajaci√≥n', 'ejercicios para calmarme', 'c√≥mo manejar la ansiedad']);
                    trainingExamples.set('sueno', ['no puedo dormir', 'tengo insomnio', 'c√≥mo dormir mejor']);
                    trainingExamples.set('emociones', ['me siento triste', 'estoy ansioso', 'c√≥mo manejar el enojo']);
                    trainingExamples.set('crisis', ['me siento muy mal', 'necesito ayuda urgente', 'estoy en crisis']);
                    
                    this.intentModel.train(trainingExamples);
                } catch (error) {
                    ErrorHandler.handle(error, 'training intent model');
                }
            }
            
            async processMessage(message) {
                try {
                    // Simular tiempo de procesamiento para una experiencia m√°s natural
                    this.showTypingIndicator();
                    await this.delay(800 + Math.random() * 700);
                    
                    const normalizedMessage = message.toLowerCase().trim();
                    this.addToConversationHistory('user', message);
                    
                    // An√°lisis de sentimiento mejorado
                    const sentiment = this.analyzeSentiment(normalizedMessage);
                    this.updateEmotionalState(sentiment, normalizedMessage);
                    
                    // Detectar y almacenar el nombre del usuario
                    if (!this.userName && this.isNameIntroduction(normalizedMessage)) {
                        this.userName = this.extractName(normalizedMessage);
                        const response = `¬°Mucho gusto, ${this.userName}! Es un placer conocerte. ¬øEn qu√© puedo ayudarte hoy?`;
                        this.addToConversationHistory('bot', response);
                        this.hideTypingIndicator();
                        
                        // Guardar datos despu√©s de obtener el nombre
                        this.saveUserData();
                        return response;
                    }
                    
                    // Clasificar la intenci√≥n usando el modelo
                    const intent = this.intentModel.predict(normalizedMessage);
                    
                    // Detectar estado de √°nimo
                    const detectedMood = this.detectMood(normalizedMessage);
                    if (detectedMood && !this.waitingForInput) {
                        this.userMood = detectedMood;
                        this.userPreferences.lastMoodRecord = new Date().toISOString();
                        this.lastInteraction = 'mood_detection';
                        const response = this.knowledgeBase.emociones.responses[0](detectedMood);
                        this.waitingForInput = true;
                        this.addToConversationHistory('bot', response);
                        this.hideTypingIndicator();
                        
                        // Guardar datos despu√©s de detectar el estado de √°nimo
                        this.saveUserData();
                        return response;
                    }
                    
                    // Manejar respuestas de seguimiento
                    if (this.waitingForInput) {
                        const response = this.handleFollowUp(normalizedMessage);
                        this.addToConversationHistory('bot', response);
                        this.hideTypingIndicator();
                        
                        // Guardar datos despu√©s de seguimiento
                        this.saveUserData();
                        return response;
                    }
                    
                    // Buscar en la base de conocimiento basado en la intenci√≥n clasificada
                    if (this.knowledgeBase[intent]) {
                        this.currentContext = intent;
                        
                        let response;
                        if (intent === 'emociones' && this.userMood) {
                            response = this.knowledgeBase[intent].responses[0](this.userMood);
                        } else {
                            const responses = this.knowledgeBase[intent].responses;
                            response = typeof responses[0] === 'function' ? 
                                      responses[0]({name: this.userName, mood: this.userMood}) : 
                                      responses[Math.floor(Math.random() * responses.length)];
                        }
                        
                        // Agregar pregunta de seguimiento si existe
                        if (this.knowledgeBase[intent].followUp && !this.waitingForInput) {
                            this.waitingForInput = true;
                            response = response + '\n\n' + this.knowledgeBase[intent].followUp;
                        }
                        
                        this.addToConversationHistory('bot', response);
                        this.hideTypingIndicator();
                        
                        // Guardar datos despu√©s de procesar la intenci√≥n
                        this.saveUserData();
                        return response;
                    }
                    
                    // Si no encuentra coincidencia, respuesta por defecto mejorada
                    const defaultResponse = this.defaultResponses[Math.floor(Math.random() * this.defaultResponses.length)];
                    const enhancedResponse = defaultResponse + '\n\nPuedes preguntarme sobre:\n‚Ä¢ T√©cnicas de relajaci√≥n\n‚Ä¢ C√≥mo manejar emociones dif√≠ciles\n‚Ä¢ Estrategias para dormir mejor\n‚Ä¢ Uso del diario emocional\n‚Ä¢ Seguimiento de tu progreso';
                    
                    this.addToConversationHistory('bot', enhancedResponse);
                    this.hideTypingIndicator();
                    
                    // Guardar datos despu√©s de respuesta por defecto
                    this.saveUserData();
                    return enhancedResponse;
                } catch (error) {
                    this.hideTypingIndicator();
                    return ErrorHandler.handle(error, 'processing message');
                }
            }
            
            analyzeSentiment(message) {
                try {
                    // Algoritmo mejorado de an√°lisis de sentimiento
                    const positiveWords = ['bien', 'feliz', 'contento', 'genial', 'maravilloso', 'agradecido', 'optimista', 'alegre', 'emocionado'];
                    const negativeWords = ['mal', 'triste', 'ansioso', 'estresado', 'enojado', 'preocupado', 'asustado', 'nervioso', 'desbordado', 'agobiado', 'frustrado'];
                    const intenseWords = ['muy', 'mucho', 'extremadamente', 'realmente', 'totalmente', 'completamente'];
                    
                    const words = message.toLowerCase().split(/\s+/);
                    let score = 0;
                    let intensity = 1;
                    
                    words.forEach(word => {
                        if (positiveWords.includes(word)) score += 1;
                        if (negativeWords.includes(word)) score -= 1;
                        if (intenseWords.includes(word)) intensity += 0.5;
                    });
                    
                    return { score, intensity };
                } catch (error) {
                    ErrorHandler.handle(error, 'analyzing sentiment');
                    return { score: 0, intensity: 1 };
                }
            }
            
            updateEmotionalState(sentiment, message) {
                try {
                    // Actualizar el estado emocional basado en el an√°lisis de sentimiento
                    if (sentiment.score > 0) {
                        this.emotionalState.mood = 'positive';
                    } else if (sentiment.score < 0) {
                        this.emotionalState.mood = 'negative';
                    } else {
                        this.emotionalState.mood = 'neutral';
                    }
                    
                    this.emotionalState.intensity = sentiment.intensity;
                    
                    // Extraer posibles desencadenantes emocionales
                    const triggerWords = ['porque', 'debido a', 'cuando', 'despu√©s de', 'por'];
                    const words = message.split(/\s+/);
                    
                    for (let i = 0; i < words.length; i++) {
                        if (triggerWords.includes(words[i]) && i < words.length - 1) {
                            this.emotionalState.triggers.push(words.slice(i + 1, i + 4).join(' '));
                        }
                    }
                    
                    // Limitar el historial de desencadenantes
                    if (this.emotionalState.triggers.length > 10) {
                        this.emotionalState.triggers = this.emotionalState.triggers.slice(-10);
                    }
                } catch (error) {
                    ErrorHandler.handle(error, 'updating emotional state');
                }
            }
            
            addToConversationHistory(role, message) {
                try {
                    this.conversationHistory.push({
                        role,
                        message,
                        timestamp: new Date(),
                        mood: this.emotionalState.mood,
                        intensity: this.emotionalState.intensity
                    });
                    
                    // Limitar el historial para no consumir demasiada memoria
                    if (this.conversationHistory.length > 50) {
                        this.conversationHistory = this.conversationHistory.slice(-50);
                    }
                } catch (error) {
                    ErrorHandler.handle(error, 'adding to conversation history');
                }
            }
            
            showTypingIndicator() {
                try {
                    const chatMessages = document.getElementById('chatMessages');
                    const typingIndicator = document.createElement('div');
                    typingIndicator.className = 'typing-indicator';
                    typingIndicator.id = 'typingIndicator';
                    typingIndicator.setAttribute('aria-label', 'El bot est√° escribiendo');
                    typingIndicator.innerHTML = `
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    `;
                    chatMessages.appendChild(typingIndicator);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } catch (error) {
                    ErrorHandler.handle(error, 'showing typing indicator');
                }
            }
            
            hideTypingIndicator() {
                try {
                    const typingIndicator = document.getElementById('typingIndicator');
                    if (typingIndicator) {
                        typingIndicator.remove();
                    }
                } catch (error) {
                    ErrorHandler.handle(error, 'hiding typing indicator');
                }
            }
            
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            
            isNameIntroduction(message) {
                try {
                    const namePatterns = [
                        /me llamo (\w+)/i,
                        /soy (\w+)/i,
                        /mi nombre es (\w+)/i,
                        /puedes llamarme (\w+)/i
                    ];
                    
                    return namePatterns.some(pattern => pattern.test(message));
                } catch (error) {
                    ErrorHandler.handle(error, 'checking name introduction');
                    return false;
                }
            }

            extractName(message) {
                try {
                    const patterns = [
                        /me llamo (\w+)/i,
                        /soy (\w+)/i,
                        /mi nombre es (\w+)/i,
                        /puedes llamarme (\w+)/i
                    ];
                    
                    for (const pattern of patterns) {
                        const match = message.match(pattern);
                        if (match) return match[1];
                    }
                    
                    return null;
                } catch (error) {
                    ErrorHandler.handle(error, 'extracting name');
                    return null;
                }
            }

            detectMood(message) {
                try {
                    const moodKeywords = {
                        triste: ['triste', 'deprimido', 'desanimado', 'desesperanzado', 'melanc√≥lico', 'apenado'],
                        ansioso: ['ansioso', 'nervioso', 'preocupado', 'agitado', 'intranquilo', 'atemorizado'],
                        estresado: ['estresado', 'agobiado', 'abrumado', 'presionado', 'tenso', 'frustrado'],
                        enojado: ['enojado', 'enfadado', 'furioso', 'molesto', 'irritado', 'airado'],
                        feliz: ['feliz', 'contento', 'alegre', 'optimista', 'entusiasmado', 'emocionado']
                    };
                    
                    for (const [mood, keywords] of Object.entries(moodKeywords)) {
                        if (keywords.some(keyword => message.includes(keyword))) {
                            return mood;
                        }
                    }
                    
                    return null;
                } catch (error) {
                    ErrorHandler.handle(error, 'detecting mood');
                    return null;
                }
            }

            handleFollowUp(message) {
                try {
                    this.waitingForInput = false;
                    
                    switch (this.currentContext) {
                        case 'emociones':
                            if (message.includes('s√≠') || message.includes('si') || message.includes('por favor')) {
                                return this.knowledgeBase.tecnicas.responses[0]({name: this.userName, mood: this.userMood});
                            }
                            break;
                            
                        case 'respiracion':
                            if (message.includes('s√≠') || message.includes('si') || message.includes('guiar')) {
                                return this.guidedBreathingExercise();
                            }
                            break;
                            
                        case 'sueno':
                            if (message.includes('conciliar')) {
                                return `Para conciliar el sue√±o, te recomiendo la **t√©cnica 4-7-8** en la cama:
                                
1. Acu√©state boca arriba en una posici√≥n c√≥moda
2. Realiza 4-5 ciclos de respiraci√≥n 4-7-8
3. Conc√©ntrate solo en tu respiraci√≥n
4. Si vienen pensamientos, ac√©ptalos y vuelve a tu respiraci√≥n

¬øTe gustar√≠a que te gu√≠e con esta t√©cnica ahora mismo?`;
                            } else if (message.includes('mantener')) {
                                return `Para mantener el sue√±o:
                                
- Establece una rutina consistente de sue√±o
- Evita alcohol y cafe√≠na despu√©s de las 2 PM
- Crea un ambiente √≥ptimo para dormir (fresco, oscuro y silencioso)
- Si te despiertas, evita mirar el reloj

¬øTe gustar√≠a m√°s consejos sobre higiene del sue√±o?`;
                            }
                            break;
                            
                        default:
                            return 'Gracias por la informaci√≥n. ¬øHay algo m√°s en lo que pueda ayudarte?';
                    }
                    
                    return 'Entiendo. ¬øHay algo m√°s en lo que pueda ayudarte?';
                } catch (error) {
                    ErrorHandler.handle(error, 'handling follow-up');
                    return 'Gracias por la informaci√≥n. ¬øHay algo m√°s en lo que pueda ayudarte?';
                }
            }

            guidedBreathingExercise() {
                return `Vamos a hacer juntos la t√©cnica de respiraci√≥n 4-7-8:

Paso 1: Si√©ntate c√≥modamente con la espalda recta o t√∫mbate.
Paso 2: Coloca la punta de la lengua contra el paladar, detr√°s de los dientes frontales.
Paso 3: Exhala completamente por la boca, haciendo un sonido de susurro.
Paso 4: Cierra la boca e inhala silenciosamente por la nariz contando mentalmente hasta 4.
Paso 5: Aguanta la respiraci√≥n contando mentalmente hasta 7.
Paso 6: Exhala completamente por la boca, haciendo un sonido de susurro, contando mentalmente hasta 8.
Paso 7: Este es un ciclo. Ahora inhala nuevamente y repite el ciclo 3 veces m√°s.

¬øC√≥mo te sientes despu√©s de completar el ejercicio?`;
            }
            
            // M√©todo para generar sugerencias contextuales basadas en la conversaci√≥n
            generateContextualSuggestions() {
                try {
                    if (this.conversationHistory.length < 2) {
                        return this.quickSuggestions;
                    }
                    
                    const lastMessage = this.conversationHistory[this.conversationHistory.length - 1].message.toLowerCase();
                    
                    if (lastMessage.includes('ans') || lastMessage.includes('preocup') || lastMessage.includes('nerv')) {
                        return ['T√©cnica de respiraci√≥n 4-7-8', 'Ejercicio de grounding', 'Meditaci√≥n guiada', 'Diario de preocupaciones'];
                    }
                    
                    if (lastMessage.includes('triste') || lastMessage.includes('depri') || lastMessage.includes('desanim')) {
                        return ['Autocompasi√≥n guiada', 'Diario de gratitud', 'Actividad placentera', 'Conectar con apoyo'];
                    }
                    
                    if (lastMessage.includes('sue√±o') || lastMessage.includes('dormir') || lastMessage.includes('insomnio')) {
                        return ['Rutina de sue√±o', 'Relajaci√≥n muscular', 'Meditaci√≥n para dormir', 'Higiene del sue√±o'];
                    }
                    
                    return this.quickSuggestions;
                } catch (error) {
                    ErrorHandler.handle(error, 'generating contextual suggestions');
                    return this.quickSuggestions;
                }
            }
        }

        // Inicializar y conectar con la interfaz
        document.addEventListener('DOMContentLoaded', function() {
            const chatMessages = document.getElementById('chatMessages');
            const userInput = document.getElementById('userInput');
            const sendButton = document.getElementById('sendButton');
            const quickSuggestions = document.getElementById('quickSuggestions');
            
            const serenBot = new EnhancedSerenBot();
            
            // Cargar historial de conversaci√≥n previo si existe
            const savedHistory = StorageManager.load('serenbot_conversation_history');
            if (savedHistory && savedHistory.length > 0) {
                // Mantener solo el mensaje inicial del bot y agregar el historial guardado
                chatMessages.innerHTML = '';
                savedHistory.forEach(msg => {
                    addMessageToChat(msg.message, msg.role === 'user');
                });
            }
            
            // Funci√≥n para a√±adir mensaje al chat
            function addMessageToChat(message, isUser = false) {
                const messageElement = document.createElement('div');
                messageElement.className = isUser ? 'message user-message' : 'message bot-message';
                
                const messageText = document.createElement('div');
                messageText.textContent = message;
                
                const messageTime = document.createElement('div');
                messageTime.className = 'message-time';
                messageTime.textContent = 'Ahora';
                
                messageElement.appendChild(messageText);
                messageElement.appendChild(messageTime);
                
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Guardar el historial de la conversaci√≥n actual
                saveConversationHistory();
            }
            
            // Guardar historial de conversaci√≥n
            function saveConversationHistory() {
                const messages = Array.from(chatMessages.querySelectorAll('.message')).map(msg => {
                    return {
                        role: msg.classList.contains('user-message') ? 'user' : 'bot',
                        message: msg.querySelector('div:first-child').textContent,
                        timestamp: new Date()
                    };
                });
                
                StorageManager.save('serenbot_conversation_history', messages);
            }
            
            // Funci√≥n para enviar mensaje
            async function sendMessage() {
                const message = userInput.value.trim();
                if (message) {
                    addMessageToChat(message, true);
                    userInput.value = '';
                    
                    const response = await serenBot.processMessage(message);
                    addMessageToChat(response, false);
                    
                    // Actualizar sugerencias
                    updateQuickSuggestions();
                }
            }
            
            // Funci√≥n para actualizar sugerencias r√°pidas
            function updateQuickSuggestions() {
                const suggestions = serenBot.generateContextualSuggestions();
                quickSuggestions.innerHTML = '';
                
                suggestions.forEach(suggestion => {
                    const chip = document.createElement('div');
                    chip.className = 'suggestion-chip';
                    chip.textContent = suggestion;
                    chip.setAttribute('role', 'button');
                    chip.setAttribute('aria-label', `Sugerencia: ${suggestion}`);
                    chip.addEventListener('click', () => {
                        userInput.value = suggestion;
                        sendMessage();
                    });
                    quickSuggestions.appendChild(chip);
                });
            }
            
            // Event listeners
            sendButton.addEventListener('click', sendMessage);
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Inicializar sugerencias
            updateQuickSuggestions();
            
            // Configurar evento para guardar datos antes de cerrar la p√°gina
            window.addEventListener('beforeunload', () => {
                serenBot.saveUserData();
                saveConversationHistory();
            });
        });
    </script>
</body>
</html>
