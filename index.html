<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SerenBot - Asistente Terap√©utico Avanzado</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4e54c8;
            --primary-light: #8f94fb;
            --secondary: #ff6b6b;
            --accent: #4ecdc4;
            --dark: #1a1a2e;
            --light: #f8f9fa;
            --gray: #6c757d;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --border-radius: 12px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        header {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            animation: fadeIn 1s ease;
        }

        header h1 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        header p {
            color: var(--gray);
            font-size: 1.1rem;
            max-width: 800px;
            margin: 0 auto;
        }

        .main-content {
            display: flex;
            gap: 20px;
            flex-direction: column;
        }

        @media (min-width: 992px) {
            .main-content {
                flex-direction: row;
            }
        }

        .chat-container {
            flex: 2;
            background: rgba(255, 255, 255, 0.92);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            backdrop-filter: blur(10px);
            animation: slideInLeft 0.5s ease;
        }

        .chat-header {
            padding: 15px 20px;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }

        .chat-header h2 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mood-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }

        .mood-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--success);
        }

        .mood-dot.negative {
            background: var(--danger);
        }

        .mood-dot.neutral {
            background: var(--warning);
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: 500px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect fill="rgba(248, 249, 250, 0.2)" x="0" y="0" width="100" height="100"/><path fill="rgba(78, 84, 200, 0.1)" d="M0 0L100 100"/></svg>');
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            line-height: 1.5;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .user-message {
            align-self: flex-end;
            background: var(--primary-light);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .bot-message {
            align-self: flex-start;
            background: #e9ecef;
            color: var(--dark);
            border-bottom-left-radius: 4px;
        }

        .system-message {
            align-self: center;
            background: var(--accent);
            color: white;
            text-align: center;
            font-style: italic;
        }

        .crisis-message {
            background: var(--danger);
            color: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 5px;
            text-align: right;
        }

        .message-actions {
            display: flex;
            gap: 10px;
            margin-top: 8px;
            justify-content: flex-end;
        }

        .message-action {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            border-radius: 12px;
            padding: 3px 8px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .message-action:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .chat-input {
            padding: 15px;
            background: white;
            display: flex;
            gap: 10px;
            border-top: 1px solid #dee2e6;
            position: relative;
        }

        .chat-input input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ced4da;
            border-radius: 30px;
            outline: none;
            font-size: 1rem;
            transition: var(--transition);
        }

        .chat-input input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(78, 84, 200, 0.2);
        }

        .chat-input button {
            padding: 12px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .chat-input button:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
        }

        .quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .quick-reply {
            background: rgba(78, 84, 200, 0.1);
            border: 1px solid rgba(78, 84, 200, 0.2);
            border-radius: 16px;
            padding: 6px 12px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .quick-reply:hover {
            background: rgba(78, 84, 200, 0.2);
        }

        .sidebar {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            animation: slideInRight 0.5s ease;
        }

        .user-panel {
            background: rgba(255, 255, 255, 0.92);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .user-panel h3 {
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .user-mood {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }

        .mood-btn {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            transition: var(--transition);
        }

        .mood-btn:hover, .mood-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .progress-container {
            margin-top: 15px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .progress-bar {
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--success);
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .tools-panel {
            background: rgba(255, 255, 255, 0.92);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .tools-panel h3 {
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tool-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            margin-bottom: 10px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .tool-btn:hover {
            background: var(--primary-light);
            color: white;
            transform: translateX(5px);
        }

        .stats-panel {
            background: rgba(255, 255, 255, 0.92);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .stats-panel h3 {
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: var(--transition);
        }

        .stat-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--gray);
        }

        footer {
            text-align: center;
            padding: 20px;
            color: white;
            font-size: 0.9rem;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--gray);
            font-style: italic;
            margin-top: 10px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--gray);
            border-radius: 50%;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        /* Estilos para t√©cnicas terap√©uticas */
        .technique-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-top: 10px;
            border-left: 4px solid var(--accent);
        }

        .technique-title {
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .thought-record {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .thought-record h4 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .thought-record table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        .thought-record th, .thought-record td {
            border: 1px solid #dee2e6;
            padding: 8px;
            text-align: left;
            font-size: 0.9rem;
        }

        .thought-record th {
            background-color: var(--primary-light);
            color: white;
        }

        .breathing-exercise {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
            color: white;
            border-radius: var(--border-radius);
            margin: 10px 0;
        }

        .breathing-circle {
            width: 120px;
            height: 120px;
            border: 3px solid white;
            border-radius: 50%;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            animation: breathe 8s infinite ease-in-out;
        }

        @keyframes breathe {
            0%, 100% { transform: scale(0.8); opacity: 0.7; }
            50% { transform: scale(1.2); opacity: 1; }
        }

        .exercise-controls {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .exercise-btn {
            padding: 8px 15px;
            background: white;
            color: var(--primary);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }

        .exercise-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        /* Modal para recursos de emergencia */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }

        .emergency-resources {
            margin: 15px 0;
        }

        .resource-item {
            padding: 10px;
            border-left: 3px solid var(--danger);
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 0 5px 5px 0;
        }

        .resource-title {
            font-weight: bold;
            color: var(--danger);
        }

        /* Mejoras de accesibilidad */
        .high-contrast {
            --primary: #000000;
            --primary-light: #333333;
            --secondary: #ffffff;
            --light: #000000;
            --dark: #ffffff;
        }

        .text-to-speech {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
            color: var(--gray);
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .message {
                max-width: 90%;
            }
            
            header h1 {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-robot"></i> SerenBot <span style="font-size: 1rem; background: var(--accent); color: white; padding: 3px 10px; border-radius: 20px;">Premium</span></h1>
            <p>Tu asistente terap√©utico avanzado con inteligencia artificial e intervenciones psicol√≥gicas personalizadas</p>
        </header>

        <div class="main-content">
            <div class="chat-container">
                <div class="chat-header">
                    <h2><i class="fas fa-comments"></i> Chat con SerenBot</h2>
                    <div class="session-info">
                        Sesi√≥n: <span id="session-time">00:00</span>
                        <div class="mood-indicator">
                            <span>Estado: </span>
                            <div class="mood-dot" id="mood-indicator"></div>
                            <span id="mood-text">Neutral</span>
                        </div>
                    </div>
                </div>
                <div class="chat-messages" id="chat-messages">
                    <div class="message system-message">
                        <p>¬°Hola! Soy SerenBot, tu asistente de apoyo emocional. Estoy aqu√≠ para escucharte y ayudarte con t√©cnicas basadas en psicoterapia. ¬øEn qu√© puedo ayudarte hoy?</p>
                        <div class="message-time" id="current-time"></div>
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="user-input" placeholder="Escribe tu mensaje aqu√≠...">
                    <button id="send-btn"><i class="fas fa-paper-plane"></i> Enviar</button>
                    <div class="quick-replies" id="quick-replies">
                        <div class="quick-reply" data-message="Me siento ansioso">üò∞ Ansiedad</div>
                        <div class="quick-reply" data-message="Me siento triste">üòî Tristeza</div>
                        <div class="quick-reply" data-message="Necesito t√©cnicas de relajaci√≥n">üßò Relajaci√≥n</div>
                        <div class="quick-reply" data-message="Quiero hacer un ejercicio">üí™ Ejercicio</div>
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <div class="user-panel">
                    <h3><i class="fas fa-user-graduate"></i> Tu Perfil Terap√©utico</h3>
                    <div class="user-info">
                        <div class="progress-container">
                            <div class="progress-info">
                                <span>Progreso general</span>
                                <span id="user-progress">75%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 75%"></div>
                            </div>
                        </div>
                        <p>Nivel: <strong id="user-level">Explorador</strong></p>
                        <p>Pr√≥ximo objetivo: <span id="next-goal">Completar 5 ejercicios de respiraci√≥n</span></p>
                        <div class="user-mood">
                            <p>¬øC√≥mo te sientes ahora?</p>
                            <button class="mood-btn" data-mood="excelente">üòä Excelente</button>
                            <button class="mood-btn" data-mood="bien">üòå Bien</button>
                            <button class="mood-btn" data-mood="regular">üòê Regular</button>
                            <button class="mood-btn" data-mood="mal">üòî Mal</button>
                        </div>
                    </div>
                </div>

                <div class="tools-panel">
                    <h3><i class="fas fa-tools"></i> Herramientas Terap√©uticas</h3>
                    <div class="tool-btn" id="breathing-tool">
                        <i class="fas fa-wind"></i>
                        <span>Ejercicio de respiraci√≥n</span>
                    </div>
                    <div class="tool-btn" id="mindfulness-tool">
                        <i class="fas fa-spa"></i>
                        <span>Meditaci√≥n guiada</span>
                    </div>
                    <div class="tool-btn" id="journal-tool">
                        <i class="fas fa-book"></i>
                        <span>Diario emocional</span>
                    </div>
                    <div class="tool-btn" id="thought-record-tool">
                        <i class="fas fa-brain"></i>
                        <span>Registro de pensamientos</span>
                    </div>
                    <div class="tool-btn" id="goals-tool">
                        <i class="fas fa-bullseye"></i>
                        <span>Establecer metas</span>
                    </div>
                    <div class="tool-btn" id="emergency-tool">
                        <i class="fas fa-life-ring"></i>
                        <span>Recursos de emergencia</span>
                    </div>
                </div>

                <div class="stats-panel">
                    <h3><i class="fas fa-chart-line"></i> Tus Estad√≠sticas</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value">14</div>
                            <div class="stat-label">D√≠as consecutivos</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">87%</div>
                            <div class="stat-label">Estado de √°nimo</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">12</div>
                            <div class="stat-label">Sesiones este mes</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">5</div>
                            <div class="stat-label">Logros</div>
                        </div>
                    </div>
                    <div class="text-to-speech">
                        <i class="fas fa-volume-up"></i>
                        <span>Text-to-Speech </span>
                        <label class="switch">
                            <input type="checkbox" id="tts-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>SerenBot - Asistente Terap√©utico Avanzado | <i class="fas fa-shield-alt"></i> Tus datos est√°n protegidos y encriptados</p>
            <p><small>Nota: SerenBot no sustituye la atenci√≥n profesional. En caso de crisis, contacta a un especialista.</small></p>
        </footer>
    </div>

    <!-- Modal de recursos de emergencia -->
    <div class="modal" id="emergency-modal">
        <div class="modal-content">
            <span class="close-modal" id="close-modal">&times;</span>
            <h3><i class="fas fa-life-ring"></i> Recursos de Emergencia</h3>
            <div class="emergency-resources">
                <div class="resource-item">
                    <div class="resource-title">L√≠nea de Prevenci√≥n del Suicidio</div>
                    <div>Tel√©fono: 988 (Estados Unidos)</div>
                    <div>Disponible 24/7</div>
                </div>
                <div class="resource-item">
                    <div class="resource-title">Crisis Text Line</div>
                    <div>Texto: HOME al 741741</div>
                    <div>Disponible 24/7</div>
                </div>
                <div class="resource-item">
                    <div class="resource-title">L√≠nea de Ayuda para Crisis</div>
                    <div>Tel√©fono: 1-800-273-8255</div>
                    <div>Disponible 24/7</div>
                </div>
                <div class="resource-item">
                    <div class="resource-title">Ayuda Internacional</div>
                    <div>Visita <a href="https://www.iasp.info/resources/Crisis_Centres/" target="_blank">IASP</a> para centros de crisis globales</div>
                </div>
            </div>
            <p>Si est√°s experimentando una crisis, por favor contacta a un profesional de la salud mental o a los servicios de emergencia.</p>
        </div>
    </div>

    <script>
        // Clase SerenBot mejorada con t√©cnicas de psicoterapia avanzadas
        class SerenBot {
            constructor(config = {}) {
                this.config = {
                    maxHistorySize: config.maxHistorySize || 100,
                    sessionTimeout: config.sessionTimeout || 3600000,
                    language: config.language || 'es',
                    enableEncryption: config.enableEncryption || true,
                    cacheSize: config.cacheSize || 50,
                    debugMode: config.debugMode || false,
                    ...config
                };

                this.messageHistory = [];
                this.userPreferences = {};
                this.sessionData = {};
                this.cache = new Map();
                this.isInitialized = false;
                this.currentLanguage = this.config.language;
                this.emotionAnalysis = new EmotionAnalysis();
                this.userProfile = new UserProfile();
                this.activeTechniques = new Map();
                this.therapeuticApproaches = new TherapeuticApproaches();
                
                this.init();
            }

            async init() {
                try {
                    console.log('Inicializando SerenBot Premium...');
                    await this.loadLanguageConfig();
                    await this.loadPersistedData();
                    this.setupErrorHandlers();
                    this.cleanupMemory();
                    
                    this.isInitialized = true;
                    console.log('SerenBot Premium inicializado correctamente');
                    
                } catch (error) {
                    this.handleError('Error durante la inicializaci√≥n', error);
                }
            }

            async loadLanguageConfig() {
                try {
                    this.i18n = {
                        es: {
                            welcome: '¬°Hola! Soy SerenBot, tu asistente de apoyo emocional. ¬øEn qu√© puedo ayudarte hoy?',
                            error: 'Lo siento, ha ocurrido un error. ¬øPodr√≠as intentar reformular tu mensaje?',
                            notUnderstood: 'No estoy seguro de entender tu mensaje. ¬øPodr√≠as ser m√°s espec√≠fico?',
                            sessionExpired: 'Tu sesi√≥n ha expirado por seguridad. Comencemos de nuevo.',
                            dataCleared: 'Los datos han sido limpiados por tu privacidad.',
                            crisis: 'Detect√© que podr√≠as estar pasando por un momento dif√≠cil. ¬øTe gustar√≠a que te ayude con algunas t√©cnicas de apoyo?',
                            emergency: 'Si est√°s en crisis, por favor contacta inmediatamente a los recursos de emergencia.',
                            breathingExercise: 'Te gu√≠o en un ejercicio de respiraci√≥n: Inhala por 4 segundos, mant√©n por 4, exhala por 6. ¬øLo intentamos juntos?',
                            mindfulness: 'El mindfulness puede ayudarte a centrarte en el presente. ¬øTe gustar√≠a practicar un ejercicio de atenci√≥n plena?',
                            validation: 'Entiendo que eso puede ser muy dif√≠cil para ti. Es normal sentirse as√≠ en situaciones como esta.',
                            reflection: 'Parece que te sientes [emoci√≥n], como si [situaci√≥n].',
                            socraticQuestion: '¬øQu√© crees que te har√≠a sentir mejor en este momento?',
                            thoughtChallenge: '¬øQu√© evidencia tienes de que ese pensamiento es cierto? ¬øHay otra forma de verlo?',
                            act: 'En lugar de luchar contra tus pensamientos, ¬øqu√© tal si los observamos como algo pasajero?',
                            dbt: '¬øC√≥mo podemos encontrar un equilibrio entre aceptar tus sentimientos y buscar formas de manejarlos?',
                            journalSuggestion: 'Podr√≠as intentar escribir tus sentimientos en un diario para aclarar tus pensamientos.',
                            goalSetting: 'Establecer metas peque√±as y alcanzables puede ayudarte a sentir m√°s control. ¬øTe gustar√≠a establecer alguna meta para esta semana?',
                            positiveReframing: 'Esta situaci√≥n es dif√≠cil, pero tambi√©n puede ser una oportunidad para [aspecto positivo].'
                        },
                        en: {
                            welcome: 'Hello! I\'m SerenBot, your emotional support assistant. How can I help you today?',
                            error: 'Sorry, an error occurred. Could you try rephrasing your message?',
                            notUnderstood: 'I\'m not sure I understand your message. Could you be more specific?',
                            sessionExpired: 'Your session has expired for security reasons. Let\'s start over.',
                            dataCleared: 'Data has been cleared for your privacy.',
                            crisis: 'I detected you might be going through a difficult time. Would you like me to help you with some support techniques?',
                            emergency: 'If you\'re in crisis, please contact emergency resources immediately.',
                            breathingExercise: 'Let me guide you through a breathing exercise: Inhale for 4 seconds, hold for 4, exhale for 6. Shall we try together?',
                            mindfulness: 'Mindfulness can help you focus on the present. Would you like to practice a mindfulness exercise?',
                            validation: 'I understand that can be very difficult for you. It\'s normal to feel that way in situations like this.',
                            reflection: 'It seems like you feel [emotion], as if [situation].',
                            socraticQuestion: 'What do you think would make you feel better right now?',
                            thoughtChallenge: 'What evidence do you have that this thought is true? Is there another way to look at it?',
                            act: 'Instead of fighting your thoughts, how about we observe them as something temporary?',
                            dbt: 'How can we find a balance between accepting your feelings and looking for ways to manage them?',
                            journalSuggestion: 'You could try writing your feelings in a journal to clarify your thoughts.',
                            goalSetting: 'Setting small, achievable goals can help you feel more in control. Would you like to set some goals for this week?',
                            positiveReframing: 'This situation is difficult, but it can also be an opportunity for [positive aspect].'
                        }
                    };
                    
                    console.log(`Configuraci√≥n de idioma cargada: ${this.currentLanguage}`);
                } catch (error) {
                    this.handleError('Error cargando configuraci√≥n de idioma', error);
                }
            }

            // ... (resto de m√©todos de la clase SerenBot)

            async generateResponse(message, options = {}, emotionAnalysis = {}) {
                const lowerMessage = message.toLowerCase();
                
                // Detecci√≥n de crisis mejorada
                const crisisKeywords = ['suicidio', 'morir', 'acabar', 'crisis', 'no puedo m√°s', 'help', 'ayuda urgente', 'suicide', 'kill myself', 'end it all', 'sin esperanza', 'sin sentido', 'no quiero vivir', 'despedida'];
                if (crisisKeywords.some(keyword => lowerMessage.includes(keyword)) || emotionAnalysis.emergencyScore > 0.1) {
                    return {
                        content: this.getMessage('emergency') + " " + this.getEmergencyResources(),
                        metadata: { 
                            isCrisis: true, 
                            priority: 'high',
                            ariaLabel: 'Mensaje de emergencia - Informaci√≥n de contacto para crisis',
                            requiresFollowUp: true
                        }
                    };
                }

                // Detecci√≥n de estado emocional mejorada
                const emotionalKeywords = ['triste', 'ansioso', 'preocupado', 'deprimido', 'estresado', 'nervioso', 'asustado', 'enfadado', 'enojado', 'molesto', 'frustrado'];
                if (emotionalKeywords.some(keyword => lowerMessage.includes(keyword)) || emotionAnalysis.negativeScore > 0.4) {
                    // Validaci√≥n emocional
                    let emotion = 'as√≠';
                    if (emotionAnalysis.dominantEmotion === 'negative') emotion = 'mal';
                    if (emotionAnalysis.dominantEmotion === 'crisis') emotion = 'en crisis';
                    
                    const validationResponse = this.getMessage('validation');
                    const reflectionResponse = this.getMessage('reflection')
                        .replace('[emoci√≥n]', emotion)
                        .replace('[situaci√≥n]', 'la situaci√≥n es abrumadora');
                    
                    // Seleccionar t√©cnica terap√©utica basada en el an√°lisis
                    const technique = this.therapeuticApproaches.selectTechnique(emotionAnalysis, this.userProfile);
                    
                    return {
                        content: `${validationResponse} ${reflectionResponse} ${technique.response}`,
                        metadata: { 
                            isEmotionalSupport: true,
                            technique: technique.name,
                            emotion: emotionAnalysis.dominantEmotion,
                            ariaLabel: 'Respuesta de apoyo emocional con validaci√≥n y reflexi√≥n'
                        }
                    };
                }

                // T√©cnicas de TCC - Pensamientos autom√°ticos mejorados
                const thoughtPatterns = ['siempre', 'nunca', 'todo', 'nada', 'deber√≠a', 'tengo que', 'soy un', 'soy una', 'nadie me', 'todo el mundo'];
                if (thoughtPatterns.some(pattern => lowerMessage.includes(pattern)) && emotionAnalysis.negativeScore > 0.3) {
                    return {
                        content: this.getMessage('thoughtChallenge'),
                        metadata: {
                            technique: 'cognitive_restructuring',
                            emotion: emotionAnalysis.dominantEmotion,
                            ariaLabel: 'T√©cnica de reestructuraci√≥n cognitiva para pensamientos autom√°ticos'
                        }
                    };
                }

                // Respuestas basadas en patrones mejoradas
                const responses = this.getResponsePatterns();
                
                for (const pattern of responses) {
                    if (pattern.keywords.some(keyword => lowerMessage.includes(keyword))) {
                        return {
                            content: this.getRandomResponse(pattern.responses),
                            metadata: {
                                category: pattern.category,
                                technique: pattern.technique,
                                emotion: emotionAnalysis.dominantEmotion,
                                ariaLabel: `Respuesta sobre ${pattern.category}`
                            }
                        };
                    }
                }

                // Respuesta por defecto con sugerencias mejoradas
                const defaultResponses = [
                    this.getMessage('notUnderstood'),
                    "No estoy seguro de entender. ¬øTe gustar√≠a hablar sobre c√≥mo te sientes o prefieres probar un ejercicio de relajaci√≥n?",
                    "Parece que no capt√© completamente tu mensaje. ¬øPodr√≠as reformularlo? Mientras tanto, ¬øquieres que hablemos de t√©cnicas para manejar el estr√©s?",
                    this.getMessage('journalSuggestion'),
                    this.getMessage('goalSetting')
                ];
                
                return {
                    content: this.getRandomResponse(defaultResponses),
                    metadata: { 
                        isDefault: true,
                        emotion: emotionAnalysis.dominantEmotion,
                        ariaLabel: 'Respuesta de aclaraci√≥n'
                    }
                };
            }

            getResponsePatterns() {
                return [
                    {
                        category: 'saludo',
                        technique: 'rapport_building',
                        keywords: ['hola', 'hello', 'hi', 'buenos d√≠as', 'buenas tardes', 'buenas noches'],
                        responses: [
                            this.getMessage('welcome'),
                            '¬°Hola! Me alegra que est√©s aqu√≠. ¬øC√≥mo te sientes hoy?',
                            'Bienvenido/a. Estoy aqu√≠ para acompa√±arte. ¬øEn qu√© puedo ayudarte?'
                        ]
                    },
                    {
                        category: 'respiracion',
                        technique: 'breathing_exercise',
                        keywords: ['respirar', 'respira', 'ansiedad', 'p√°nico', 'nervioso', 'respiraci√≥n', 'hiperventilar', 'calmar', 'relajar'],
                        responses: [
                            this.getMessage('breathingExercise'),
                            'La respiraci√≥n consciente puede ayudarte. ¬øTe gustar√≠a que practiquemos una t√©cnica de respiraci√≥n?',
                            'Cuando sientes ansiedad, respirar profundamente puede calmarte. ¬øQuieres que te ense√±e una t√©cnica?',
                            this.createBreathingExerciseHTML()
                        ]
                    },
                    {
                        category: 'mindfulness',
                        technique: 'mindfulness',
                        keywords: ['mindfulness', 'meditaci√≥n', 'presente', 'aqu√≠ y ahora', 'meditar', 'atenci√≥n plena', 'consciencia'],
                        responses: [
                            this.getMessage('mindfulness'),
                            'Estar presente es una habilidad poderosa. ¬øQuieres que hagamos un ejercicio de conexi√≥n con el momento actual?',
                            'La meditaci√≥n puede ser muy beneficiosa. ¬øTe gustar√≠a intentar una breve sesi√≥n guiada?',
                            this.createMindfulnessExerciseHTML()
                        ]
                    },
                    {
                        category: 'agradecimiento',
                        technique: 'positive_reinforcement',
                        keywords: ['gracias', 'thanks', 'thank you', 'te agradezco', 'agradecido', 'aprecio'],
                        responses: [
                            '¬°De nada! Estoy aqu√≠ para ayudarte siempre que lo necesites.',
                            'Es un placer poder acompa√±arte. ¬øHay algo m√°s en lo que pueda ayudarte?',
                            'Me alegra poder ser de ayuda. Recuerda que estoy aqu√≠ para ti cuando me necesites.',
                            'Agradezco tu confianza. Trabajar en tu bienestar emocional es un proceso valioso.'
                        ]
                    },
                    {
                        category: 'pensamientos',
                        technique: 'cognitive_restructuring',
                        keywords: ['pensamiento', 'pienso', 'creo', 'mente', 'pensar', 'idea', 'rumiar', 'pensamientos negativos'],
                        responses: [
                            this.getMessage('thoughtChallenge'),
                            'A veces nuestros pensamientos no reflejan la realidad completa. ¬øPodr√≠amos examinar ese pensamiento juntos?',
                            'Los pensamientos son solo eso, pensamientos. No necesariamente definen la realidad. ¬øQuieres explorar esto m√°s a fondo?',
                            this.createThoughtRecordHTML()
                        ]
                    },
                    {
                        category: 'aceptacion',
                        technique: 'act',
                        keywords: ['aceptar', 'luchar', 'pelear', 'resistir', 'evitar', 'no acepto', 'no quiero'],
                        responses: [
                            this.getMessage('act'),
                            'A veces, aceptar lo que sentimos puede ser m√°s efectivo que luchar contra ello. ¬øTe gustar√≠a hablar sobre esto?',
                            'La aceptaci√≥n no significa resignaci√≥n, sino reconocer la realidad para poder trabajar con ella.'
                        ]
                    },
                    {
                        category: 'equilibrio',
                        technique: 'dbt',
                        keywords: ['equilibrio', 'balance', 'extremoso', 'polarizado', 'blanco y negro', 'todo o nada'],
                        responses: [
                            this.getMessage('dbt'),
                            'Encontrar el punto medio entre aceptaci√≥n y cambio puede ser desafiante. ¬øC√≥mo podr√≠amos trabajar en esto?',
                            'La vida a menudo se trata de encontrar equilibrio. ¬øQuieres explorar c√≥mo aplicar esto a tu situaci√≥n?'
                        ]
                    },
                    {
                        category: 'metas',
                        technique: 'goal_setting',
                        keywords: ['meta', 'objetivo', 'prop√≥sito', 'lograr', 'conseguir', 'plan', 'progreso'],
                        responses: [
                            this.getMessage('goalSetting'),
                            'Establecer metas realistas puede ayudarte a sentirte m√°s motivado. ¬øQuieres que trabajemos en ello?',
                            '¬øTe gustar√≠a establecer algunas metas peque√±as para esta semana? Podemos hacerlo juntos.'
                        ]
                    }
                ];
            }

            createBreathingExerciseHTML() {
                return `
                <div class="breathing-exercise">
                    <h4>Ejercicio de Respiraci√≥n 4-4-6</h4>
                    <p>Inhala durante 4 segundos, mant√©n durante 4 segundos, exhala durante 6 segundos</p>
                    <div class="breathing-circle" id="breathing-circle">Inhala</div>
                    <div class="exercise-controls">
                        <button class="exercise-btn" onclick="startBreathingExercise()">Comenzar</button>
                        <button class="exercise-btn" onclick="stopBreathingExercise()">Detener</button>
                    </div>
                    <p>Repite este ciclo durante 5 minutos para reducir la ansiedad y mejorar la calma.</p>
                </div>
                `;
            }

            createMindfulnessExerciseHTML() {
                return `
                <div class="technique-container">
                    <div class="technique-title">Ejercicio de Mindfulness de 5 minutos</div>
                    <ol>
                        <li>Si√©ntate en una posici√≥n c√≥moda con la espalda recta</li>
                        <li>Cierra los ojos y lleva tu atenci√≥n a tu respiraci√≥n</li>
                        <li>Observa cada inhalaci√≥n y exhalaci√≥n sin juzgar</li>
                        <li>Si tu mente divaga, gently devu√©lvela a la respiraci√≥n</li>
                        <li>Expande tu awareness a los sonidos y sensaciones a tu alrededor</li>
                    </ol>
                    <p>¬øTe gustar√≠a que gu√≠e este ejercicio ahora?</p>
                </div>
                `;
            }

            createThoughtRecordHTML() {
                return `
                <div class="thought-record">
                    <h4>Registro de Pensamientos ABCDE</h4>
                    <p>Esta herramienta basada en TCC puede ayudarte a examinar tus pensamientos:</p>
                    <table>
                        <tr>
                            <th>A</th>
                            <th>B</th>
                            <th>C</th>
                            <th>D</th>
                            <th>E</th>
                        </tr>
                        <tr>
                            <td>Situaci√≥n activadora</td>
                            <td>Creencia/pensamiento</td>
                            <td>Consecuencia emocional</td>
                            <td>Debate de la creencia</td>
                            <td>Efecto nuevo</td>
                        </tr>
                    </table>
                    <p>¬øTe gustar√≠a que trabajemos en completar esta tabla juntos?</p>
                </div>
                `;
            }

            getEmergencyResources() {
                return `
                <div class="emergency-resources">
                    <p><strong>L√≠nea de Prevenci√≥n del Suicidio:</strong> 988 (EE.UU.)</p>
                    <p><strong>Crisis Text Line:</strong> Texto HOME al 741741</p>
                    <p><strong>L√≠nea de Ayuda para Crisis:</strong> 1-800-273-8255</p>
                </div>
                `;
            }

            // ... (resto de m√©todos de la clase SerenBot)
        }

        // Clase para an√°lisis de emociones mejorada
        class EmotionAnalysis {
            constructor() {
                this.positiveWords = ['feliz', 'contento', 'alegre', 'genial', 'maravilloso', 'excelente', 'fant√°stico', 'bien', 'optimista', 'agradecido', 'esperanzado', 'emocionado', 'entusiasmado', 'orgulloso', 'satisfecho', 'pleno'];
                this.negativeWords = ['triste', 'deprimido', 'ansioso', 'preocupado', 'asustado', 'enfadado', 'enojado', 'molesto', 'frustrado', 'desesperado', 'desanimado', 'culpable', 'avergonzado', 'asqueado', 'agobiado', 'abrumado'];
                this.emergencyWords = ['suicidio', 'morir', 'matar', 'acabar', 'despedida', 'sin sentido', 'sin esperanza', 'no quiero vivir', 'can\'t go on', 'mejor sin m√≠', 'quiero desaparecer'];
                this.intenseWords = ['terrible', 'horrible', 'devastado', 'catastr√≥fico', 'insoportable', 'horroroso', 'p√©simo', 'desastroso', 'aterrador', 'angustiado'];
            }

            analyzeText(text) {
                const words = text.toLowerCase().split(/\s+/);
                let positiveCount = 0;
                let negativeCount = 0;
                let emergencyCount = 0;
                let intenseCount = 0;
                
                words.forEach(word => {
                    if (this.positiveWords.includes(word)) positiveCount++;
                    if (this.negativeWords.includes(word)) negativeCount++;
                    if (this.emergencyWords.includes(word)) emergencyCount++;
                    if (this.intenseWords.includes(word)) intenseCount++;
                });
                
                const total = words.length;
                const positiveScore = total > 0 ? positiveCount / total : 0;
                const negativeScore = total > 0 ? negativeCount / total : 0;
                const emergencyScore = total > 0 ? emergencyCount / total : 0;
                const intensityScore = total > 0 ? intenseCount / total : 0;
                
                let dominantEmotion = 'neutral';
                if (emergencyScore > 0.1) dominantEmotion = 'crisis';
                else if (negativeScore > positiveScore && intensityScore > 0.1) dominantEmotion = 'intense_negative';
                else if (negativeScore > positiveScore) dominantEmotion = 'negative';
                else if (positiveScore > negativeScore) dominantEmotion = 'positive';
                
                return {
                    positiveScore,
                    negativeScore,
                    emergencyScore,
                    intensityScore,
                    dominantEmotion,
                    wordsAnalyzed: total
                };
            }
        }

        // Clase para enfoques terap√©uticos
        class TherapeuticApproaches {
            constructor() {
                this.techniques = [
                    {
                        name: 'cognitive_restructuring',
                        applicableEmotions: ['negative', 'intense_negative'],
                        response: 'Parece que est√°s experimentando algunos pensamientos negativos. ¬øTe gustar√≠a examinarlos juntos usando una t√©cnica de reestructuraci√≥n cognitiva?'
                    },
                    {
                        name: 'mindfulness',
                        applicableEmotions: ['negative', 'intense_negative', 'neutral'],
                        response: 'Noto que podr√≠as beneficiarte de practicar mindfulness para manejar estos sentimientos. ¬øTe gustar√≠a intentar un ejercicio breve?'
                    },
                    {
                        name: 'behavioral_activation',
                        applicableEmotions: ['negative', 'neutral'],
                        response: 'A veces, realizar actividades placenteras puede mejorar nuestro estado de √°nimo. ¬øHas considerado planificar alguna actividad que disfrutes?'
                    },
                    {
                        name: 'acceptance_commitment',
                        applicableEmotions: ['negative', 'intense_negative'],
                        response: 'En lugar de luchar contra estos sentimientos, ¬øqu√© tal si practicamos aceptarlos como parte de tu experiencia moment√°nea?'
                    },
                    {
                        name: 'gratitude_exercise',
                        applicableEmotions: ['negative', 'neutral'],
                        response: 'Practicar la gratitud puede ayudar a cambiar nuestra perspectiva. ¬øTe gustar√≠a intentar un ejercicio de gratitud?'
                    }
                ];
            }

            selectTechnique(emotionAnalysis, userProfile) {
                // Filtrar t√©cnicas aplicables a la emoci√≥n actual
                const applicableTechniques = this.techniques.filter(
                    t => t.applicableEmotions.includes(emotionAnalysis.dominantEmotion)
                );

                // Si no hay t√©cnicas aplicables, devolver una por defecto
                if (applicableTechniques.length === 0) {
                    return {
                        name: 'validation',
                        response: 'Entiendo que esto es dif√≠cil para ti. ¬øHay algo espec√≠fico en lo que pueda ayudarte?'
                    };
                }

                // Seleccionar una t√©cnica aleatoria de las aplicables
                const randomIndex = Math.floor(Math.random() * applicableTechniques.length);
                return applicableTechniques[randomIndex];
            }
        }

        // Clase para perfil de usuario mejorada
        class UserProfile {
            constructor() {
                this.moodHistory = [];
                this.interactionCount = 0;
                this.preferences = {};
                this.lastSession = new Date();
                this.commonTopics = new Set();
                this.therapeuticGoals = [];
                this.achievements = [];
            }
            
            updateWithAnalysis(analysis) {
                this.moodHistory.push({
                    timestamp: new Date(),
                    mood: analysis.dominantEmotion,
                    intensity: Math.max(analysis.positiveScore, analysis.negativeScore, analysis.emergencyScore, analysis.intensityScore)
                });
                
                this.interactionCount++;
                
                // Mantener un historial limitado
                if (this.moodHistory.length > 100) {
                    this.moodHistory = this.moodHistory.slice(-100);
                }
            }
            
            getMoodTrend() {
                if (this.moodHistory.length < 2) return 'stable';
                
                const recentMoods = this.moodHistory.slice(-10);
                const positiveCount = recentMoods.filter(m => m.mood === 'positive').length;
                const negativeCount = recentMoods.filter(m => m.mood === 'negative' || m.mood === 'intense_negative' || m.mood === 'crisis').length;
                
                if (positiveCount > negativeCount * 2) return 'improving';
                if (negativeCount > positiveCount * 2) return 'declining';
                return 'stable';
            }
            
            getInteractionFrequency() {
                return this.interactionCount;
            }
            
            addTopic(topic) {
                this.commonTopics.add(topic);
            }
            
            getCommonTopics() {
                return Array.from(this.commonTopics);
            }
            
            addGoal(goal) {
                this.therapeuticGoals.push({
                    goal,
                    createdAt: new Date(),
                    completed: false
                });
            }
            
            completeGoal(goalIndex) {
                if (goalIndex >= 0 && goalIndex < this.therapeuticGoals.length) {
                    this.therapeuticGoals[goalIndex].completed = true;
                    this.therapeuticGoals[goalIndex].completedAt = new Date();
                    
                    // A√±adir logro
                    this.achievements.push({
                        name: `Meta completada: ${this.therapeuticGoals[goalIndex].goal}`,
                        date: new Date()
                    });
                }
            }
            
            getGoals() {
                return this.therapeuticGoals;
            }
            
            getAchievements() {
                return this.achievements;
            }
        }

        // Inicializaci√≥n de la interfaz
        document.addEventListener('DOMContentLoaded', function() {
            const chatMessages = document.getElementById('chat-messages');
            const userInput = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const sessionTime = document.getElementById('session-time');
            const currentTimeElement = document.getElementById('current-time');
            const quickReplies = document.getElementById('quick-replies');
            const emergencyModal = document.getElementById('emergency-modal');
            const closeModal = document.getElementById('close-modal');
            const moodIndicator = document.getElementById('mood-indicator');
            const moodText = document.getElementById('mood-text');
            
            // Establecer hora actual
            const now = new Date();
            currentTimeElement.textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Inicializar el bot
            const serenBot = new SerenBot({
                debugMode: true,
                enableEncryption: true
            });
            
            // Configurar manejadores de eventos
            sendBtn.addEventListener('click', sendMessage);
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Respuestas r√°pidas
            quickReplies.querySelectorAll('.quick-reply').forEach(reply => {
                reply.addEventListener('click', function() {
                    userInput.value = this.getAttribute('data-message');
                    sendMessage();
                });
            });
            
            // Herramientas
            document.getElementById('breathing-tool').addEventListener('click', function() {
                serenBot.processMessage("quiero hacer un ejercicio de respiraci√≥n");
            });
            
            document.getElementById('mindfulness-tool').addEventListener('click', function() {
                serenBot.processMessage("me gustar√≠a meditar");
            });
            
            document.getElementById('journal-tool').addEventListener('click', function() {
                serenBot.processMessage("quiero escribir en mi diario emocional");
            });
            
            document.getElementById('thought-record-tool').addEventListener('click', function() {
                serenBot.processMessage("necesito ayuda con mis pensamientos autom√°ticos");
            });
            
            document.getElementById('goals-tool').addEventListener('click', function() {
                serenBot.processMessage("quiero establecer metas terap√©uticas");
            });
            
            document.getElementById('emergency-tool').addEventListener('click', function() {
                emergencyModal.style.display = 'flex';
            });
            
            closeModal.addEventListener('click', function() {
                emergencyModal.style.display = 'none';
            });
            
            window.addEventListener('click', function(e) {
                if (e.target === emergencyModal) {
                    emergencyModal.style.display = 'none';
                }
            });
            
            // Botones de estado de √°nimo
            const moodButtons = document.querySelectorAll('.mood-btn');
            moodButtons.forEach(button => {
                button.addEventListener('click', function() {
                    moodButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    const mood = this.getAttribute('data-mood');
                    updateMoodIndicator(mood);
                    serenBot.processMessage("Me siento " + mood);
                });
            });
            
            // Escuchar nuevos mensajes
            serenBot.on('messageAdded', function(message) {
                addMessageToChat(message);
                
                // Actualizar indicador de estado de √°nimo basado en el mensaje
                if (message.metadata && message.metadata.emotion) {
                    updateMoodIndicator(message.metadata.emotion);
                }
            });
            
            // Funci√≥n para actualizar el indicador de estado de √°nimo
            function updateMoodIndicator(mood) {
                moodIndicator.className = 'mood-dot';
                
                switch(mood) {
                    case 'positive':
                    case 'excelente':
                    case 'bien':
                        moodIndicator.classList.add('positive');
                        moodText.textContent = 'Positivo';
                        break;
                    case 'negative':
                    case 'mal':
                        moodIndicator.classList.add('negative');
                        moodText.textContent = 'Negativo';
                        break;
                    default:
                        moodIndicator.classList.add('neutral');
                        moodText.textContent = 'Neutral';
                }
            }
            
            // Funci√≥n para enviar mensajes
            function sendMessage() {
                const message = userInput.value.trim();
                if (message) {
                    addMessageToChat({
                        sender: 'user',
                        content: message,
                        timestamp: Date.now()
                    });
                    
                    userInput.value = '';
                    
                    // Mostrar indicador de typing
                    const typingIndicator = document.createElement('div');
                    typingIndicator.className = 'typing-indicator';
                    typingIndicator.innerHTML = `
                        <span>SerenBot est√° escribiendo</span>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    `;
                    chatMessages.appendChild(typingIndicator);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                    // Procesar mensaje despu√©s de un breve delay
                    setTimeout(() => {
                        chatMessages.removeChild(typingIndicator);
                        serenBot.processMessage(message);
                    }, 1500);
                }
            }
            
            // Funci√≥n para a√±adir mensajes al chat
            function addMessageToChat(message) {
                const messageElement = document.createElement('div');
                
                let messageClass = 'message';
                if (message.sender === 'user') {
                    messageClass += ' user-message';
                } else if (message.sender === 'bot') {
                    messageClass += ' bot-message';
                    
                    if (message.metadata && message.metadata.isCrisis) {
                        messageClass += ' crisis-message';
                    }
                } else {
                    messageClass += ' system-message';
                }
                
                const time = new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                messageElement.className = messageClass;
                
                // Si el mensaje contiene HTML, usamos innerHTML, sino textContent para seguridad
                if (message.content.includes('<') && message.content.includes('>')) {
                    messageElement.innerHTML = `
                        <div>${message.content}</div>
                        <div class="message-time">${time}</div>
                        <div class="message-actions">
                            <button class="message-action"><i class="fas fa-heart"></i></button>
                            <button class="message-action"><i class="fas fa-share"></i></button>
                            <button class="message-action"><i class="fas fa-ellipsis-h"></i></button>
                        </div>
                    `;
                } else {
                    messageElement.innerHTML = `
                        <p>${message.content}</p>
                        <div class="message-time">${time}</div>
                        <div class="message-actions">
                            <button class="message-action"><i class="fas fa-heart"></i></button>
                            <button class="message-action"><i class="fas fa-share"></i></button>
                            <button class="message-action"><i class="fas fa-ellipsis-h"></i></button>
                        </div>
                    `;
                }
                
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Si el mensaje contiene un ejercicio de respiraci√≥n, agregar los event listeners
                if (message.content.includes('breathing-exercise')) {
                    // Los listeners se agregar√°n cuando se haga clic en los botones
                    window.startBreathingExercise = function() {
                        const circle = document.getElementById('breathing-circle');
                        let cycle = 0;
                        const breathingInterval = setInterval(() => {
                            if (cycle % 3 === 0) {
                                circle.textContent = "Inhala";
                                circle.style.animation = "breathe 4s ease-in-out";
                            } else if (cycle % 3 === 1) {
                                circle.textContent = "Mant√©n";
                                circle.style.animation = "none";
                                setTimeout(() => {
                                    circle.textContent = "Exhala";
                                    circle.style.animation = "breathe 6s ease-in-out";
                                }, 4000);
                            }
                            cycle++;
                        }, 14000);
                        
                        window.stopBreathingExercise = function() {
                            clearInterval(breathingInterval);
                            circle.textContent = "Inhala";
                            circle.style.animation = "none";
                        };
                    };
                }
            }
            
            // Actualizar tiempo de sesi√≥n
            let sessionSeconds = 0;
            setInterval(() => {
                sessionSeconds++;
                const minutes = Math.floor(sessionSeconds / 60);
                const seconds = sessionSeconds % 60;
                sessionTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
            
            // Ejemplo de mensaje de bienvenida despu√©s de la inicializaci√≥n
            setTimeout(() => {
                serenBot.addMessage('bot', serenBot.getMessage('welcome'));
            }, 1000);
        });
    </script>
</body>
</html>
