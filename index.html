<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SerenBot - Asistente de Apoyo Emocional</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4e54c8;
            --primary-light: #8f94fb;
            --secondary: #ff6b6b;
            --accent: #4ecdc4;
            --dark: #1a1a2e;
            --light: #f8f9fa;
            --gray: #6c757d;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --border-radius: 12px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        header {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
        }

        header h1 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 2.5rem;
        }

        header p {
            color: var(--gray);
            font-size: 1.1rem;
        }

        .main-content {
            display: flex;
            gap: 20px;
            flex-direction: column;
        }

        @media (min-width: 992px) {
            .main-content {
                flex-direction: row;
            }
        }

        .chat-container {
            flex: 2;
            background: rgba(255, 255, 255, 0.85);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .chat-header {
            padding: 15px 20px;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-header h2 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: 500px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            line-height: 1.5;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            align-self: flex-end;
            background: var(--primary-light);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .bot-message {
            align-self: flex-start;
            background: #e9ecef;
            color: var(--dark);
            border-bottom-left-radius: 4px;
        }

        .system-message {
            align-self: center;
            background: var(--accent);
            color: white;
            text-align: center;
            font-style: italic;
        }

        .crisis-message {
            background: var(--danger);
            color: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 5px;
            text-align: right;
        }

        .chat-input {
            padding: 15px;
            background: white;
            display: flex;
            gap: 10px;
            border-top: 1px solid #dee2e6;
        }

        .chat-input input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ced4da;
            border-radius: 30px;
            outline: none;
            font-size: 1rem;
            transition: var(--transition);
        }

        .chat-input input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(78, 84, 200, 0.2);
        }

        .chat-input button {
            padding: 12px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }

        .chat-input button:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
        }

        .sidebar {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .user-panel {
            background: rgba(255, 255, 255, 0.85);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .user-panel h3 {
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .user-mood {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }

        .mood-btn {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            transition: var(--transition);
        }

        .mood-btn:hover, .mood-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .tools-panel {
            background: rgba(255, 255, 255, 0.85);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .tools-panel h3 {
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tool-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            margin-bottom: 10px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .tool-btn:hover {
            background: var(--primary-light);
            color: white;
            transform: translateX(5px);
        }

        .stats-panel {
            background: rgba(255, 255, 255, 0.85);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .stats-panel h3 {
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--gray);
        }

        footer {
            text-align: center;
            padding: 20px;
            color: white;
            font-size: 0.9rem;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--gray);
            font-style: italic;
            margin-top: 10px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--gray);
            border-radius: 50%;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        .crisis-message {
            border-left: 4px solid var(--danger);
            background: rgba(220, 53, 69, 0.1);
        }

        .validation-message {
            border-left: 4px solid var(--accent);
            background: rgba(78, 205, 196, 0.1);
        }

        .dynamic-message {
            border-left: 4px solid var(--primary);
            background: rgba(78, 84, 200, 0.1);
        }

        .proactive-message {
            border-left: 4px solid var(--warning);
            background: rgba(255, 193, 7, 0.1);
            border-radius: 8px;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .voice-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-top: 5px;
            transition: var(--transition);
        }

        .voice-btn:hover {
            background: #3db3ac;
            transform: scale(1.05);
        }

        .action-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.75rem;
            margin: 5px 5px 0 0;
            transition: var(--transition);
        }

        .action-btn:hover {
            background: #1e7e34;
            transform: scale(1.05);
        }

        .message-actions {
            margin-top: 8px;
        }

        .tool-btn.active {
            background: var(--accent);
            color: white;
            transform: scale(1.05);
        }

        .high-contrast {
            --primary: #000000;
            --primary-light: #333333;
            --secondary: #ffffff;
            --light: #000000;
            --dark: #ffffff;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .message {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-robot"></i> SerenBot</h1>
            <p>Tu asistente inteligente de apoyo emocional</p>
        </header>

        <div class="main-content">
            <div class="chat-container">
                <div class="chat-header">
                    <h2><i class="fas fa-comments"></i> Chat con SerenBot</h2>
                    <div class="session-info">Sesi√≥n: <span id="session-time">00:00</span></div>
                </div>
                <div class="chat-messages" id="chat-messages">
                    <div class="message system-message">
                        <p>¬°Hola! Soy SerenBot, tu asistente de apoyo emocional. ¬øEn qu√© puedo ayudarte hoy?</p>
                        <div class="message-time">12:00 PM</div>
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="user-input" placeholder="Escribe tu mensaje aqu√≠...">
                    <button id="send-btn"><i class="fas fa-paper-plane"></i> Enviar</button>
                </div>
            </div>

            <div class="sidebar">
                <div class="user-panel">
                    <h3><i class="fas fa-user"></i> Tu Estado</h3>
                    <div class="user-info">
                        <p>¬øC√≥mo te sientes hoy?</p>
                        <div class="user-mood">
                            <button class="mood-btn">üòä Bien</button>
                            <button class="mood-btn">üòê Regular</button>
                            <button class="mood-btn">üòî Triste</button>
                            <button class="mood-btn">üò∞ Ansioso</button>
                        </div>
                        <p>Tu progreso: <span id="user-progress">75%</span></p>
                        <div class="progress-bar" style="height: 10px; background: #e9ecef; border-radius: 5px; margin-top: 5px;">
                            <div style="width: 75%; height: 100%; background: var(--success); border-radius: 5px;"></div>
                        </div>
                    </div>
                </div>

                <div class="tools-panel">
                    <h3><i class="fas fa-tools"></i> Herramientas</h3>
                    <div class="tool-btn" id="breathing-tool">
                        <i class="fas fa-wind"></i>
                        <span>Ejercicio de respiraci√≥n</span>
                    </div>
                    <div class="tool-btn" id="mindfulness-tool">
                        <i class="fas fa-spa"></i>
                        <span>Meditaci√≥n guiada</span>
                    </div>
                    <div class="tool-btn" id="voice-tool">
                        <i class="fas fa-microphone"></i>
                        <span>Modo de voz</span>
                    </div>
                    <div class="tool-btn" id="journal-tool">
                        <i class="fas fa-book"></i>
                        <span>Diario emocional</span>
                    </div>
                    <div class="tool-btn" id="emergency-tool">
                        <i class="fas fa-life-ring"></i>
                        <span>Recursos de emergencia</span>
                    </div>
                    <div class="tool-btn" id="progress-tool">
                        <i class="fas fa-chart-line"></i>
                        <span>Ver mi progreso</span>
                    </div>
                </div>

                <div class="stats-panel">
                    <h3><i class="fas fa-chart-line"></i> Tus Estad√≠sticas</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value">14</div>
                            <div class="stat-label">D√≠as consecutivos</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">87%</div>
                            <div class="stat-label">Estado de √°nimo</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">12</div>
                            <div class="stat-label">Sesiones este mes</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">5</div>
                            <div class="stat-label">Logros</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>SerenBot - Dise√±ado para tu bienestar emocional | <i class="fas fa-shield-alt"></i> Tus datos est√°n protegidos</p>
        </footer>
    </div>

    <script>
        // Clase SerenBot mejorada
        class SerenBot {
            constructor(config = {}) {
                this.config = {
                    maxHistorySize: config.maxHistorySize || 100,
                    sessionTimeout: config.sessionTimeout || 3600000,
                    language: config.language || 'es',
                    enableEncryption: config.enableEncryption || false,
                    cacheSize: config.cacheSize || 50,
                    debugMode: config.debugMode || false,
                    ...config
                };

                this.messageHistory = [];
                this.userPreferences = {};
                this.sessionData = {};
                this.cache = new Map();
                this.isInitialized = false;
                this.currentLanguage = this.config.language;
                this.emotionAnalysis = new EmotionAnalysis();
                this.userProfile = new UserProfile();
                
                this.init();
            }

            async init() {
                try {
                    console.log('Inicializando SerenBot...');
                    await this.loadLanguageConfig();
                    await this.loadPersistedData();
                    this.setupErrorHandlers();
                    this.cleanupMemory();
                    
                    this.isInitialized = true;
                    console.log('SerenBot inicializado correctamente');
                    
                } catch (error) {
                    this.handleError('Error durante la inicializaci√≥n', error);
                }
            }

            async loadLanguageConfig() {
                try {
                    this.i18n = {
                        es: {
                            welcome: '¬°Hola! Soy SerenBot, tu asistente de apoyo emocional. ¬øEn qu√© puedo ayudarte hoy?',
                            error: 'Lo siento, ha ocurrido un error. ¬øPodr√≠as intentar reformular tu mensaje?',
                            notUnderstood: 'No estoy seguro de entender tu mensaje. ¬øPodr√≠as ser m√°s espec√≠fico?',
                            sessionExpired: 'Tu sesi√≥n ha expirado por seguridad. Comencemos de nuevo.',
                            dataCleared: 'Los datos han sido limpiados por tu privacidad.',
                            crisis: 'Detect√© que podr√≠as estar pasando por un momento dif√≠cil. ¬øTe gustar√≠a que te ayude con algunas t√©cnicas de apoyo?',
                            emergency: 'Si est√°s en crisis, por favor contacta inmediatamente: 0800 345 1435 - Centro de Asistencia al Suicida. Tambi√©n puedes escribir "AYUDA" al 30363 para recibir apoyo inmediato.',
                            breathingExercise: 'Te gu√≠o en un ejercicio de respiraci√≥n: Inhala por 4 segundos, mant√©n por 4, exhala por 6. ¬øLo intentamos juntos?',
                            mindfulness: 'El mindfulness puede ayudarte a centrarte en el presente. ¬øTe gustar√≠a practicar un ejercicio de atenci√≥n plena?',
                            voiceOption: '¬øQuieres que lea esto en voz alta? Puedo ayudarte a trav√©s de audio si prefieres.',
                            proactiveCheck: 'He notado que no hemos hablado en un tiempo. ¬øC√≥mo has estado? ¬øHay algo en lo que pueda ayudarte hoy?',
                            progressCelebration: '¬°He notado un progreso positivo en tu estado de √°nimo! Es maravilloso ver c√≥mo est√°s cuidando tu bienestar emocional.',
                            reminderTechnique: 'Recuerda que la semana pasada mencionaste que las t√©cnicas de relajaci√≥n te ayudan. ¬øQuieres intentar una ahora?'
                        },
                        en: {
                            welcome: 'Hello! I\'m SerenBot, your emotional support assistant. How can I help you today?',
                            error: 'Sorry, an error occurred. Could you try rephrasing your message?',
                            notUnderstood: 'I\'m not sure I understand your message. Could you be more specific?',
                            sessionExpired: 'Your session has expired for security reasons. Let\'s start over.',
                            dataCleared: 'Data has been cleared for your privacy.',
                            crisis: 'I detected you might be going through a difficult time. Would you like me to help you with some support techniques?',
                            emergency: 'If you\'re in crisis, please contact immediately: National Suicide Prevention Lifeline 988',
                            breathingExercise: 'Let me guide you through a breathing exercise: Inhale for 4 seconds, hold for 4, exhale for 6. Shall we try together?',
                            mindfulness: 'Mindfulness can help you focus on the present. Would you like to practice a mindfulness exercise?',
                            voiceOption: 'Would you like me to read this aloud? I can help you through audio if you prefer.',
                            proactiveCheck: 'I noticed we haven\'t talked in a while. How have you been? Is there anything I can help you with today?',
                            progressCelebration: 'I\'ve noticed positive progress in your mood! It\'s wonderful to see how you\'re taking care of your emotional wellbeing.',
                            reminderTechnique: 'Remember last week you mentioned that relaxation techniques help you. Would you like to try one now?'
                        }
                    };
                    
                    console.log(`Configuraci√≥n de idioma cargada: ${this.currentLanguage}`);
                } catch (error) {
                    this.handleError('Error cargando configuraci√≥n de idioma', error);
                }
            }

            setupErrorHandlers() {
                window.addEventListener('unhandledrejection', (event) => {
                    this.handleError('Promise rechazada no manejada', event.reason);
                    event.preventDefault();
                });

                window.addEventListener('error', (event) => {
                    this.handleError('Error global capturado', event.error);
                });
            }

            handleError(context, error) {
                const errorInfo = {
                    timestamp: new Date().toISOString(),
                    context: context,
                    message: error?.message || 'Error desconocido',
                    stack: error?.stack || 'No disponible',
                    userAgent: navigator.userAgent,
                    sessionId: this.getSessionId()
                };

                console.error(`ERROR: ${context}`, errorInfo);
                
                const errorMessage = this.getMessage('error');
                this.addMessage('bot', errorMessage, { isError: true });
            }

            async loadPersistedData() {
                try {
                    const encryptedPreferences = localStorage.getItem('serenbot_preferences');
                    if (encryptedPreferences) {
                        this.userPreferences = this.config.enableEncryption 
                            ? this.decrypt(encryptedPreferences)
                            : JSON.parse(encryptedPreferences);
                    }

                    const encryptedHistory = localStorage.getItem('serenbot_history');
                    if (encryptedHistory) {
                        const history = this.config.enableEncryption 
                            ? this.decrypt(encryptedHistory)
                            : JSON.parse(encryptedHistory);
                        
                        this.messageHistory = history.slice(-this.config.maxHistorySize);
                    }

                    this.sessionData = {
                        sessionId: this.generateSessionId(),
                        startTime: Date.now(),
                        language: this.userPreferences.language || this.config.language
                    };

                    console.log('Datos persistentes cargados correctamente');
                } catch (error) {
                    this.handleError('Error cargando datos persistentes', error);
                }
            }

            async savePersistedData() {
                try {
                    const anonymizedPreferences = this.anonymizeData(this.userPreferences);
                    const preferencesData = this.config.enableEncryption 
                        ? this.encrypt(anonymizedPreferences)
                        : JSON.stringify(anonymizedPreferences);
                    
                    localStorage.setItem('serenbot_preferences', preferencesData);

                    const recentHistory = this.messageHistory.slice(-this.config.maxHistorySize);
                    const anonymizedHistory = recentHistory.map(msg => this.anonymizeMessage(msg));
                    const historyData = this.config.enableEncryption 
                        ? this.encrypt(anonymizedHistory)
                        : JSON.stringify(anonymizedHistory);
                    
                    localStorage.setItem('serenbot_history', historyData);

                    console.log('Datos persistentes guardados correctamente');
                } catch (error) {
                    this.handleError('Error guardando datos persistentes', error);
                }
            }

            anonymizeData(data) {
                const anonymized = { ...data };
                delete anonymized.name;
                delete anonymized.email;
                delete anonymized.phone;
                delete anonymized.address;
                
                if (anonymized.userId) {
                    anonymized.userId = this.hashString(anonymized.userId);
                }
                
                return anonymized;
            }

            anonymizeMessage(message) {
                return {
                    ...message,
                    content: message.content ? this.sanitizeContent(message.content) : '',
                    timestamp: message.timestamp,
                    type: message.type,
                    metadata: message.metadata ? { ...message.metadata, sensitive: undefined } : {}
                };
            }

            sanitizeContent(content) {
                return content
                    .replace(/\b\d{4,}\b/g, '[N√öMERO]')
                    .replace(/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g, '[EMAIL]')
                    .replace(/\b\d{3}-\d{3}-\d{4}\b/g, '[TEL√âFONO]');
            }

            encrypt(data) {
                if (!this.config.enableEncryption) return JSON.stringify(data);
                const jsonString = JSON.stringify(data);
                return btoa(jsonString);
            }

            decrypt(encryptedData) {
                if (!this.config.enableEncryption) return JSON.parse(encryptedData);
                try {
                    const jsonString = atob(encryptedData);
                    return JSON.parse(jsonString);
                } catch (error) {
                    this.handleError('Error descifrando datos', error);
                    return {};
                }
            }

            hashString(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return hash.toString(36);
            }

            cleanupMemory() {
                if (this.messageHistory.length > this.config.maxHistorySize) {
                    this.messageHistory = this.messageHistory.slice(-this.config.maxHistorySize);
                }

                if (this.cache.size > this.config.cacheSize) {
                    const entries = Array.from(this.cache.entries());
                    const oldEntries = entries.slice(0, entries.length - this.config.cacheSize);
                    oldEntries.forEach(([key]) => this.cache.delete(key));
                }

                if (Date.now() - this.sessionData.startTime > this.config.sessionTimeout) {
                    this.clearSession();
                }
            }

            clearSession() {
                this.messageHistory = [];
                this.sessionData = {
                    sessionId: this.generateSessionId(),
                    startTime: Date.now(),
                    language: this.currentLanguage
                };
                this.addMessage('bot', this.getMessage('sessionExpired'), { isSystem: true });
            }

            async processMessage(userMessage, options = {}) {
                try {
                    if (!this.isInitialized) {
                        await this.init();
                    }

                    const cacheKey = this.generateCacheKey(userMessage);
                    if (this.cache.has(cacheKey)) {
                        const cachedResponse = this.cache.get(cacheKey);
                        console.log('Respuesta desde cache');
                        return cachedResponse;
                    }

                    this.addMessage('user', userMessage, options);

                    // Analizar emociones en el mensaje
                    const emotionAnalysis = this.emotionAnalysis.analyzeText(userMessage);
                    this.userProfile.updateWithAnalysis(emotionAnalysis);

                    const response = await this.generateResponse(userMessage, options, emotionAnalysis);

                    this.addMessage('bot', response.content, response.metadata);

                    this.cache.set(cacheKey, response);

                    if (this.messageHistory.length % 10 === 0) {
                        this.cleanupMemory();
                    }

                    await this.savePersistedData();

                    return response;

                } catch (error) {
                    this.handleError('Error procesando mensaje', error);
                    return {
                        content: this.getMessage('error'),
                        metadata: { isError: true }
                    };
                }
            }

            async generateResponse(message, options = {}, emotionAnalysis = {}) {
                const lowerMessage = message.toLowerCase();
                
                // Verificar si debe mostrar mensaje proactivo
                if (this.userProfile.shouldShowProactiveMessage()) {
                    const proactiveMsg = this.userProfile.getProactiveMessage();
                    if (proactiveMsg) {
                        // Agregar mensaje proactivo despu√©s de la respuesta principal
                        setTimeout(() => {
                            this.addMessage('bot', proactiveMsg, { isProactive: true });
                        }, 2000);
                    }
                }

                // Obtener recomendaci√≥n personalizada
                const personalizedRec = this.userProfile.getPersonalizedRecommendation(emotionAnalysis);
                
                // Detecci√≥n de crisis mejorada
                if (emotionAnalysis.needsCrisisIntervention) {
                    return {
                        content: this.getMessage('emergency'),
                        metadata: { 
                            isCrisis: true, 
                            priority: 'high',
                            ariaLabel: 'Mensaje de emergencia - Informaci√≥n de contacto para crisis'
                        }
                    };
                }

                // Validaci√≥n emocional autom√°tica para estados negativos
                if (emotionAnalysis.needsValidation) {
                    const validationResponses = [
                        'Entiendo que esto puede ser muy dif√≠cil. Estoy aqu√≠ para ayudarte.',
                        'Reconozco lo que est√°s sintiendo. Tus emociones son v√°lidas.',
                        'Es completamente comprensible que te sientas as√≠. No est√°s solo/a en esto.'
                    ];
                    
                    return {
                        content: this.getRandomResponse(validationResponses),
                        metadata: { 
                            isValidation: true,
                            emotionDetected: emotionAnalysis.dominantEmotion,
                            ariaLabel: 'Mensaje de validaci√≥n emocional'
                        }
                    };
                }

                // Respuestas basadas en patrones mejoradas
                const responses = this.getResponsePatterns();
                
                for (const pattern of responses) {
                    if (pattern.keywords.some(keyword => lowerMessage.includes(keyword))) {
                        let selectedResponse = this.getRandomResponse(pattern.responses);
                        
                        // Agregar recomendaci√≥n personalizada si aplica
                        if (personalizedRec && Math.random() > 0.5) {
                            selectedResponse += " " + personalizedRec;
                        }
                        
                        return {
                            content: selectedResponse,
                            metadata: {
                                category: pattern.category,
                                ariaLabel: `Respuesta sobre ${pattern.category}`,
                                hasPersonalization: !!personalizedRec
                            }
                        };
                    }
                }

                // Generar contenido din√°mico basado en el estado emocional
                const dynamicContent = this.generateDynamicContent(emotionAnalysis);
                if (dynamicContent) {
                    return dynamicContent;
                }

                // Respuesta por defecto con pregunta socr√°tica
                const socraticQuestions = [
                    "¬øQu√© crees que te har√≠a sentir mejor ahora mismo?",
                    "¬øCu√°ndo fue la √∫ltima vez que te sentiste en paz? ¬øQu√© estaba pasando?",
                    "Si pudieras cambiar una cosa de tu situaci√≥n actual, ¬øcu√°l ser√≠a?",
                    "¬øQu√© le dir√≠as a un buen amigo que estuviera pasando por lo mismo?"
                ];
                
                const defaultResponses = [
                    this.getMessage('notUnderstood'),
                    "No estoy seguro de entender completamente. " + this.getRandomResponse(socraticQuestions),
                    "Me gustar√≠a entenderte mejor. " + this.getRandomResponse(socraticQuestions)
                ];
                
                return {
                    content: this.getRandomResponse(defaultResponses),
                    metadata: { 
                        isDefault: true,
                        hasSocraticQuestion: true,
                        ariaLabel: 'Respuesta de aclaraci√≥n con pregunta reflexiva'
                    }
                };
            }

            generateDynamicContent(emotionAnalysis) {
                switch (emotionAnalysis.suggestionType) {
                    case 'stress_management':
                        return {
                            content: "Noto que est√°s experimentando estr√©s. Te gu√≠o en una t√©cnica r√°pida: Cierra los ojos, respira profundamente por la nariz contando hasta 4, mant√©n el aire por 4 segundos, y exhala lentamente por la boca contando hasta 6. Repite 3 veces. ¬øQuieres que hagamos esto juntos?",
                            metadata: { 
                                isDynamic: true, 
                                technique: 'breathing_exercise',
                                ariaLabel: 'Ejercicio de respiraci√≥n para manejo del estr√©s'
                            }
                        };
                        
                    case 'social_support':
                        return {
                            content: "Percibo que podr√≠as estar sintiendo soledad o aislamiento. Recuerda que las conexiones humanas son fundamentales para nuestro bienestar. ¬øTe gustar√≠a hablar sobre estrategias para conectar con otros, o prefieres que exploremos t√©cnicas para sentirte m√°s c√≥modo/a contigo mismo/a?",
                            metadata: { 
                                isDynamic: true, 
                                technique: 'social_connection',
                                ariaLabel: 'Apoyo para conexi√≥n social'
                            }
                        };
                        
                    case 'emotional_regulation':
                        return {
                            content: "Entiendo que las emociones pueden sentirse abrumadoras a veces. Una t√©cnica √∫til es observar tus sentimientos sin juzgarlos, como si fueras un observador neutral. ¬øPuedes describir qu√© est√°s sintiendo ahora mismo sin etiquetarlo como 'bueno' o 'malo'?",
                            metadata: { 
                                isDynamic: true, 
                                technique: 'emotional_regulation',
                                ariaLabel: 'T√©cnica de regulaci√≥n emocional'
                            }
                        };
                        
                    case 'positive_reinforcement':
                        return {
                            content: "Me alegra saber que te sientes bien. Es importante celebrar estos momentos positivos. ¬øQu√© crees que ha contribuido a que te sientas as√≠? Identificar estos factores puede ayudarte a recrear estos estados de bienestar en el futuro.",
                            metadata: { 
                                isDynamic: true, 
                                technique: 'positive_reinforcement',
                                ariaLabel: 'Reforzamiento positivo'
                            }
                        };
                        
                    default:
                        return null;
                }
            }

            getResponsePatterns() {
                return [
                    {
                        category: 'saludo',
                        keywords: ['hola', 'hello', 'hi', 'buenos d√≠as', 'buenas tardes', 'buenas noches'],
                        responses: [
                            this.getMessage('welcome'),
                            '¬°Hola! Me alegra que est√©s aqu√≠. ¬øC√≥mo te sientes hoy?',
                            'Bienvenido/a. Estoy aqu√≠ para acompa√±arte. ¬øEn qu√© puedo ayudarte?'
                        ]
                    },
                    {
                        category: 'respiracion',
                        keywords: ['respirar', 'respira', 'ansiedad', 'p√°nico', 'nervioso', 'respiraci√≥n'],
                        responses: [
                            this.getMessage('breathingExercise'),
                            'La respiraci√≥n consciente puede ayudarte. ¬øTe gustar√≠a que practiquemos una t√©cnica de respiraci√≥n?',
                            'Cuando sientes ansiedad, respirar profundamente puede calmarte. ¬øQuieres que te ense√±e una t√©cnica?'
                        ]
                    },
                    {
                        category: 'mindfulness',
                        keywords: ['mindfulness', 'meditaci√≥n', 'presente', 'aqu√≠ y ahora', 'meditar'],
                        responses: [
                            this.getMessage('mindfulness'),
                            'Estar presente es una habilidad poderosa. ¬øQuieres que hagamos un ejercicio de conexi√≥n con el momento actual?',
                            'La meditaci√≥n puede ser muy beneficiosa. ¬øTe gustar√≠a intentar una breve sesi√≥n guiada?'
                        ]
                    },
                    {
                        category: 'validacion_emocional',
                        keywords: ['triste', 'deprimido', 'solo', 'asustado', 'preocupado', 'estresado', 'abrumado', 'perdido'],
                        responses: [
                            'Entiendo que eso puede ser muy dif√≠cil. Es completamente normal sentirse as√≠, y estoy aqu√≠ para ayudarte.',
                            'Reconozco lo que est√°s sintiendo. Tus emociones son v√°lidas y es valiente de tu parte compartirlas conmigo.',
                            'Me imagino que debe ser muy pesado llevar esto contigo. ¬øQu√© crees que te ayudar√≠a a sentirte un poco mejor ahora mismo?'
                        ]
                    },
                    {
                        category: 'preguntas_socraticas',
                        keywords: ['confundido', 'no s√©', 'qu√© hacer', 'perdido', 'indeciso', 'pensando'],
                        responses: [
                            '¬øQu√© crees que te har√≠a sentir mejor ahora mismo? A veces nuestro instinto tiene respuestas que no vemos inmediatamente.',
                            '¬øCu√°ndo fue la √∫ltima vez que te sentiste realmente en paz? ¬øQu√© estaba pasando en ese momento?',
                            '¬øQu√© le dir√≠as a un buen amigo que estuviera pasando por lo mismo que t√∫? A veces somos m√°s compasivos con otros.',
                            'Si pudieras cambiar una cosa de tu situaci√≥n actual, ¬øcu√°l ser√≠a? ¬øHay alg√∫n peque√±o paso que podr√≠as dar hacia ese cambio?'
                        ]
                    },
                    {
                        category: 'act_therapy',
                        keywords: ['pensamientos', 'mente', 'obsesivo', 'rumiando', 'no puedo parar'],
                        responses: [
                            '¬øQu√© tal si observamos tus pensamientos como algo pasajero en lugar de luchar contra ellos? Como nubes que pasan por el cielo.',
                            'Los pensamientos son solo palabras en tu mente. ¬øPuedes notar que t√∫ eres quien los observa, no quien est√° atrapado en ellos?',
                            '¬øQu√© valores son importantes para ti? A veces podemos encontrar direcci√≥n enfoc√°ndonos en lo que realmente nos importa.'
                        ]
                    },
                    {
                        category: 'dbt_therapy',
                        keywords: ['intenso', 'abrumador', 'no aguanto', 'dolor emocional', 'sufrimiento'],
                        responses: [
                            'Este momento es dif√≠cil, pero los momentos cambian. ¬øPuedes recordar alguna vez anterior cuando superaste algo dif√≠cil?',
                            'Entiendo que el dolor es intenso ahora. ¬øHay alguna actividad que te ayude a regularte cuando te sientes as√≠?',
                            'Practiquemos la tolerancia al malestar. Este sentimiento es temporal. ¬øQu√© estrategias has usado antes para atravesar momentos dif√≠ciles?'
                        ]
                    },
                    {
                        category: 'agradecimiento',
                        keywords: ['gracias', 'thanks', 'thank you', 'te agradezco', 'agradecido'],
                        responses: [
                            '¬°De nada! Estoy aqu√≠ para ayudarte siempre que lo necesites.',
                            'Es un placer poder acompa√±arte. ¬øHay algo m√°s en lo que pueda ayudarte?',
                            'Me alegra poder ser de ayuda. Recuerda que estoy aqu√≠ para ti cuando me necesites.'
                        ]
                    }
                ];
            }

            addMessage(sender, content, metadata = {}) {
                const message = {
                    id: this.generateMessageId(),
                    sender,
                    content,
                    timestamp: Date.now(),
                    metadata: {
                        sessionId: this.sessionData.sessionId,
                        ...metadata
                    }
                };

                this.messageHistory.push(message);
                this.emit('messageAdded', message);
                
                return message;
            }

            getMessage(key) {
                return this.i18n[this.currentLanguage]?.[key] || this.i18n.es[key] || key;
            }

            getRandomResponse(responses) {
                return responses[Math.floor(Math.random() * responses.length)];
            }

            generateCacheKey(message) {
                return this.hashString(message.toLowerCase().trim());
            }

            generateMessageId() {
                return `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            }

            generateSessionId() {
                return `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            }

            getSessionId() {
                return this.sessionData.sessionId;
            }

            emit(eventName, data) {
                if (this.listeners && this.listeners[eventName]) {
                    this.listeners[eventName].forEach(callback => callback(data));
                }
            }

            on(eventName, callback) {
                if (!this.listeners) this.listeners = {};
                if (!this.listeners[eventName]) this.listeners[eventName] = [];
                this.listeners[eventName].push(callback);
            }

            setLanguage(language) {
                if (this.i18n[language]) {
                    this.currentLanguage = language;
                    this.userPreferences.language = language;
                    this.savePersistedData();
                    console.log(`Idioma cambiado a: ${language}`);
                }
            }

            clearAllData() {
                this.messageHistory = [];
                this.userPreferences = {};
                this.cache.clear();
                localStorage.removeItem('serenbot_preferences');
                localStorage.removeItem('serenbot_history');
                this.addMessage('bot', this.getMessage('dataCleared'), { isSystem: true });
            }

            log(message, data = null) {
                if (this.config.debugMode) {
                    console.log(`[SerenBot] ${message}`, data);
                }
            }

            getMessageHistory() {
                return [...this.messageHistory];
            }

            getUserPreferences() {
                return { ...this.userPreferences };
            }

            getSessionInfo() {
                return {
                    sessionId: this.sessionData.sessionId,
                    startTime: this.sessionData.startTime,
                    language: this.currentLanguage,
                    messageCount: this.messageHistory.length
                };
            }
        }

        // Clase para an√°lisis de emociones mejorada
        class EmotionAnalysis {
            constructor() {
                this.positiveWords = ['feliz', 'contento', 'alegre', 'genial', 'maravilloso', 'excelente', 'fant√°stico', 'bien', 'optimista', 'agradecido', 'emocionado', 'motivado', 'esperanzado', 'tranquilo', 'relajado'];
                this.negativeWords = ['triste', 'deprimido', 'ansioso', 'preocupado', 'asustado', 'enfadado', 'enojado', 'molesto', 'frustrado', 'desesperado', 'abrumado', 'estresado', 'perdido', 'solo', 'vac√≠o', 'cansado'];
                this.emergencyWords = ['suicidio', 'morir', 'matar', 'acabar', 'despedida', 'sin sentido', 'sin esperanza', 'no aguanto m√°s', 'quiero desaparecer'];
                this.intensityWords = ['muy', 'mucho', 'extremadamente', 'completamente', 'totalmente', 's√∫per', 'incre√≠blemente', 'absolutamente'];
                this.socialWords = ['solo', 'aislado', 'abandonado', 'incomprendido', 'rechazado', 'excluido'];
                this.stressWords = ['trabajo', 'estudios', 'ex√°menes', 'presi√≥n', 'deadline', 'responsabilidades', 'obligaciones'];
            }

            analyzeText(text) {
                const words = text.toLowerCase().split(/\s+/);
                let positiveCount = 0;
                let negativeCount = 0;
                let emergencyCount = 0;
                let intensityMultiplier = 1;
                let socialIssues = 0;
                let stressIndicators = 0;
                
                words.forEach(word => {
                    if (this.positiveWords.includes(word)) positiveCount++;
                    if (this.negativeWords.includes(word)) negativeCount++;
                    if (this.emergencyWords.includes(word)) emergencyCount++;
                    if (this.intensityWords.includes(word)) intensityMultiplier = 1.5;
                    if (this.socialWords.includes(word)) socialIssues++;
                    if (this.stressWords.includes(word)) stressIndicators++;
                });
                
                const total = words.length;
                const positiveScore = total > 0 ? (positiveCount / total) * intensityMultiplier : 0;
                const negativeScore = total > 0 ? (negativeCount / total) * intensityMultiplier : 0;
                const emergencyScore = total > 0 ? (emergencyCount / total) * intensityMultiplier : 0;
                const socialDistressScore = total > 0 ? socialIssues / total : 0;
                const stressScore = total > 0 ? stressIndicators / total : 0;
                
                let dominantEmotion = 'neutral';
                let emotionIntensity = 'low';
                
                if (emergencyScore > 0.05) {
                    dominantEmotion = 'crisis';
                    emotionIntensity = 'high';
                } else if (negativeScore > positiveScore) {
                    dominantEmotion = 'negative';
                    emotionIntensity = negativeScore > 0.2 ? 'high' : 'medium';
                } else if (positiveScore > negativeScore) {
                    dominantEmotion = 'positive';
                    emotionIntensity = positiveScore > 0.2 ? 'high' : 'medium';
                }

                // Determinar subtipo emocional
                let emotionSubtype = null;
                if (socialDistressScore > 0.1) emotionSubtype = 'social_distress';
                if (stressScore > 0.1) emotionSubtype = 'stress_related';
                
                return {
                    positiveScore,
                    negativeScore,
                    emergencyScore,
                    socialDistressScore,
                    stressScore,
                    dominantEmotion,
                    emotionIntensity,
                    emotionSubtype,
                    wordsAnalyzed: total,
                    needsValidation: negativeScore > 0.1 || emergencyScore > 0,
                    needsCrisisIntervention: emergencyScore > 0.05,
                    suggestionType: this.getSuggestionType(dominantEmotion, emotionSubtype, stressScore, socialDistressScore)
                };
            }

            getSuggestionType(emotion, subtype, stressScore, socialScore) {
                if (emotion === 'crisis') return 'crisis_support';
                if (subtype === 'stress_related') return 'stress_management';
                if (subtype === 'social_distress') return 'social_support';
                if (emotion === 'negative') return 'emotional_regulation';
                if (emotion === 'positive') return 'positive_reinforcement';
                return 'general_wellness';
            }
        }

        // Clase para perfil de usuario mejorada
        class UserProfile {
            constructor() {
                this.moodHistory = [];
                this.interactionCount = 0;
                this.preferences = {
                    preferredTechniques: [],
                    language: 'es',
                    communicationStyle: 'empathetic', // empathetic, direct, supportive
                    crisisContactShown: false
                };
                this.lastSession = new Date();
                this.patterns = {
                    commonEmotions: [],
                    triggerWords: [],
                    preferredSupport: [],
                    progressIndicators: []
                };
                this.goals = [];
                this.achievements = [];
            }
            
            updateWithAnalysis(analysis) {
                this.moodHistory.push({
                    timestamp: new Date(),
                    mood: analysis.dominantEmotion,
                    intensity: analysis.emotionIntensity,
                    subtype: analysis.emotionSubtype,
                    needsValidation: analysis.needsValidation,
                    suggestionType: analysis.suggestionType
                });
                
                this.interactionCount++;
                
                // Analizar patrones
                this.updatePatterns(analysis);
                
                // Mantener un historial limitado
                if (this.moodHistory.length > 100) {
                    this.moodHistory = this.moodHistory.slice(-100);
                }
            }

            updatePatterns(analysis) {
                // Actualizar emociones comunes
                if (!this.patterns.commonEmotions.includes(analysis.dominantEmotion)) {
                    this.patterns.commonEmotions.push(analysis.dominantEmotion);
                }

                // Rastrear tipos de sugerencias efectivas
                if (analysis.suggestionType && !this.patterns.preferredSupport.includes(analysis.suggestionType)) {
                    this.patterns.preferredSupport.push(analysis.suggestionType);
                }
            }

            getMoodTrend() {
                if (this.moodHistory.length < 2) return 'stable';
                
                const recentMoods = this.moodHistory.slice(-10);
                const positiveCount = recentMoods.filter(m => m.mood === 'positive').length;
                const negativeCount = recentMoods.filter(m => m.mood === 'negative' || m.mood === 'crisis').length;
                
                if (positiveCount > negativeCount * 2) return 'improving';
                if (negativeCount > positiveCount * 2) return 'declining';
                return 'stable';
            }

            getProactiveMessage() {
                const now = new Date();
                const daysSinceLastSession = Math.floor((now - this.lastSession) / (1000 * 60 * 60 * 24));
                
                if (daysSinceLastSession > 3) {
                    return "Not√© que han pasado algunos d√≠as desde nuestra √∫ltima conversaci√≥n. ¬øC√≥mo has estado? ¬øTe gustar√≠a practicar alguna t√©cnica de bienestar?";
                }

                const recentMoods = this.moodHistory.slice(-5);
                const hasStressPattern = recentMoods.filter(m => m.subtype === 'stress_related').length >= 2;
                
                if (hasStressPattern) {
                    return "He notado que has mencionado estr√©s recientemente. ¬øTe gustar√≠a que exploremos algunas t√©cnicas de manejo del estr√©s que podr√≠an ayudarte?";
                }

                const hasSocialDistressPattern = recentMoods.filter(m => m.subtype === 'social_distress').length >= 2;
                
                if (hasSocialDistressPattern) {
                    return "Parece que has estado lidiando con algunos desaf√≠os sociales. ¬øQuieres hablar sobre estrategias para conectar mejor con otros?";
                }

                return null;
            }

            getPersonalizedRecommendation(currentAnalysis) {
                const trend = this.getMoodTrend();
                const preferredTechniques = this.preferences.preferredTechniques;

                if (currentAnalysis.dominantEmotion === 'negative' && trend === 'declining') {
                    if (preferredTechniques.includes('breathing')) {
                        return "Record√© que las t√©cnicas de respiraci√≥n te han ayudado antes. ¬øQuieres que practiquemos una ahora?";
                    }
                    if (preferredTechniques.includes('mindfulness')) {
                        return "La √∫ltima vez que hicimos mindfulness notaste una mejora. ¬øTe gustar√≠a intentarlo de nuevo?";
                    }
                }

                if (currentAnalysis.suggestionType === 'stress_management') {
                    return "¬øRecuerdas la t√©cnica de respiraci√≥n que practicamos? Podr√≠a ser √∫til ahora que sientes estr√©s.";
                }

                return null;
            }

            addPreferredTechnique(technique) {
                if (!this.preferences.preferredTechniques.includes(technique)) {
                    this.preferences.preferredTechniques.push(technique);
                }
            }

            addGoal(goal) {
                this.goals.push({
                    id: Date.now(),
                    description: goal,
                    createdAt: new Date(),
                    completed: false
                });
            }

            completeGoal(goalId) {
                const goal = this.goals.find(g => g.id === goalId);
                if (goal) {
                    goal.completed = true;
                    goal.completedAt = new Date();
                    this.achievements.push({
                        type: 'goal_completed',
                        description: goal.description,
                        date: new Date()
                    });
                }
            }
            
            getInteractionFrequency() {
                return this.interactionCount;
            }

            shouldShowProactiveMessage() {
                // Mostrar mensaje proactivo cada 5-7 interacciones
                return this.interactionCount % 6 === 0 && this.interactionCount > 0;
            }
        }

        // Inicializaci√≥n de la interfaz
        document.addEventListener('DOMContentLoaded', function() {
            const chatMessages = document.getElementById('chat-messages');
            const userInput = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const sessionTime = document.getElementById('session-time');
            
            // Inicializar el bot
            const serenBot = new SerenBot({
                debugMode: true,
                enableEncryption: false
            });
            
            // Configurar manejadores de eventos
            sendBtn.addEventListener('click', sendMessage);
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Herramientas
            document.getElementById('breathing-tool').addEventListener('click', function() {
                serenBot.processMessage("quiero hacer un ejercicio de respiraci√≥n");
                serenBot.userProfile.addPreferredTechnique('breathing');
            });
            
            document.getElementById('mindfulness-tool').addEventListener('click', function() {
                serenBot.processMessage("me gustar√≠a meditar");
                serenBot.userProfile.addPreferredTechnique('mindfulness');
            });

            document.getElementById('voice-tool').addEventListener('click', function() {
                toggleVoiceMode();
            });

            document.getElementById('progress-tool').addEventListener('click', function() {
                showProgressSummary();
            });

            document.getElementById('emergency-tool').addEventListener('click', function() {
                serenBot.processMessage("necesito ayuda de emergencia");
            });

            document.getElementById('journal-tool').addEventListener('click', function() {
                serenBot.processMessage("quiero escribir en mi diario emocional");
            });

            // Funcionalidad de voz
            let isVoiceMode = false;
            let recognition = null;
            let synthesis = window.speechSynthesis;

            function toggleVoiceMode() {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    serenBot.addMessage('bot', 'Lo siento, tu navegador no soporta reconocimiento de voz. Intenta con Chrome o Firefox.', { isSystem: true });
                    return;
                }

                isVoiceMode = !isVoiceMode;
                const voiceBtn = document.getElementById('voice-tool');
                
                if (isVoiceMode) {
                    voiceBtn.style.backgroundColor = '#4ecdc4';
                    voiceBtn.style.color = 'white';
                    serenBot.addMessage('bot', 'üé§ Modo de voz activado. Puedes hablar ahora. Haz clic de nuevo para desactivar.', { isSystem: true });
                    startListening();
                } else {
                    voiceBtn.style.backgroundColor = '';
                    voiceBtn.style.color = '';
                    serenBot.addMessage('bot', 'üîá Modo de voz desactivado.', { isSystem: true });
                    stopListening();
                }
            }

            function startListening() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = false;
                recognition.lang = 'es-ES';

                recognition.onresult = function(event) {
                    const transcript = event.results[event.results.length - 1][0].transcript;
                    document.getElementById('user-input').value = transcript;
                    sendMessage();
                };

                recognition.onerror = function(event) {
                    console.error('Error de reconocimiento de voz:', event.error);
                    if (event.error === 'no-speech') {
                        serenBot.addMessage('bot', 'No pude escuchar nada. Intenta hablar m√°s claro.', { isSystem: true });
                    }
                };

                recognition.start();
            }

            function stopListening() {
                if (recognition) {
                    recognition.stop();
                    recognition = null;
                }
            }

            function speakText(text) {
                if (synthesis.speaking) {
                    synthesis.cancel();
                }

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-ES';
                utterance.rate = 0.8;
                utterance.pitch = 1;
                
                // Buscar una voz en espa√±ol
                const voices = synthesis.getVoices();
                const spanishVoice = voices.find(voice => voice.lang.startsWith('es'));
                if (spanishVoice) {
                    utterance.voice = spanishVoice;
                }

                synthesis.speak(utterance);
            }

            function showProgressSummary() {
                const trend = serenBot.userProfile.getMoodTrend();
                const interactionCount = serenBot.userProfile.getInteractionFrequency();
                const recentMoods = serenBot.userProfile.moodHistory.slice(-10);
                
                let progressMessage = `üìä Resumen de tu progreso:\n\n`;
                progressMessage += `‚Ä¢ Interacciones totales: ${interactionCount}\n`;
                progressMessage += `‚Ä¢ Tendencia emocional: ${trend === 'improving' ? 'üìà Mejorando' : trend === 'declining' ? 'üìâ Necesita atenci√≥n' : '‚û°Ô∏è Estable'}\n`;
                progressMessage += `‚Ä¢ T√©cnicas preferidas: ${serenBot.userProfile.preferences.preferredTechniques.join(', ') || 'A√∫n explorando'}\n`;
                
                if (recentMoods.length > 0) {
                    const positiveCount = recentMoods.filter(m => m.mood === 'positive').length;
                    progressMessage += `‚Ä¢ Emociones positivas recientes: ${Math.round((positiveCount / recentMoods.length) * 100)}%`;
                }

                serenBot.addMessage('bot', progressMessage, { isProgress: true });
            }
            
            document.getElementById('journal-tool').addEventListener('click', function() {
                serenBot.processMessage("quiero escribir en mi diario emocional");
            });
            
            document.getElementById('emergency-tool').addEventListener('click', function() {
                serenBot.processMessage("necesito recursos de emergencia");
            });
            
            // Botones de estado de √°nimo
            const moodButtons = document.querySelectorAll('.mood-btn');
            moodButtons.forEach(button => {
                button.addEventListener('click', function() {
                    moodButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    serenBot.processMessage("Me siento " + this.textContent);
                });
            });
            
            // Escuchar nuevos mensajes
            serenBot.on('messageAdded', function(message) {
                addMessageToChat(message);
            });
            
            // Funci√≥n para enviar mensajes
            function sendMessage() {
                const message = userInput.value.trim();
                if (message) {
                    addMessageToChat({
                        sender: 'user',
                        content: message,
                        timestamp: Date.now()
                    });
                    
                    userInput.value = '';
                    
                    // Mostrar indicador de typing
                    const typingIndicator = document.createElement('div');
                    typingIndicator.className = 'typing-indicator';
                    typingIndicator.innerHTML = `
                        <span>SerenBot est√° escribiendo</span>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    `;
                    chatMessages.appendChild(typingIndicator);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                    // Procesar mensaje despu√©s de un breve delay
                    setTimeout(() => {
                        chatMessages.removeChild(typingIndicator);
                        serenBot.processMessage(message);
                    }, 1500);
                }
            }
            
            // Funci√≥n para a√±adir mensajes al chat
            function addMessageToChat(message) {
                const messageElement = document.createElement('div');
                
                let messageClass = 'message';
                if (message.sender === 'user') {
                    messageClass += ' user-message';
                } else if (message.sender === 'bot') {
                    messageClass += ' bot-message';
                    
                    if (message.metadata && message.metadata.isCrisis) {
                        messageClass += ' crisis-message';
                    }
                    if (message.metadata && message.metadata.isValidation) {
                        messageClass += ' validation-message';
                    }
                    if (message.metadata && message.metadata.isDynamic) {
                        messageClass += ' dynamic-message';
                    }
                    if (message.metadata && message.metadata.isProactive) {
                        messageClass += ' proactive-message';
                    }
                } else {
                    messageClass += ' system-message';
                }
                
                const time = new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // Crear contenido del mensaje con opciones adicionales
                let messageContent = `<p>${message.content}</p>`;
                
                // Agregar bot√≥n de voz para mensajes del bot
                if (message.sender === 'bot' && 'speechSynthesis' in window) {
                    messageContent += `<button class="voice-btn" onclick="speakText('${message.content.replace(/'/g, "\\'")}')">
                        <i class="fas fa-volume-up"></i> Escuchar
                    </button>`;
                }
                
                // Agregar botones de acci√≥n para ciertos tipos de mensajes
                if (message.metadata && message.metadata.technique) {
                    messageContent += `<div class="message-actions">
                        <button class="action-btn" onclick="serenBot.userProfile.addPreferredTechnique('${message.metadata.technique}')">
                            <i class="fas fa-heart"></i> Me gust√≥ esta t√©cnica
                        </button>
                    </div>`;
                }
                
                messageElement.className = messageClass;
                messageElement.innerHTML = `
                    ${messageContent}
                    <div class="message-time">${time}</div>
                `;
                
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // Auto-reproducir voz para mensajes importantes si el modo voz est√° activo
                if (isVoiceMode && message.sender === 'bot' && 
                    (message.metadata?.isCrisis || message.metadata?.isValidation)) {
                    setTimeout(() => speakText(message.content), 500);
                }
            }
            
            // Actualizar tiempo de sesi√≥n
            let sessionSeconds = 0;
            setInterval(() => {
                sessionSeconds++;
                const minutes = Math.floor(sessionSeconds / 60);
                const seconds = sessionSeconds % 60;
                sessionTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
            
            // Ejemplo de mensaje de bienvenida despu√©s de la inicializaci√≥n
            setTimeout(() => {
                serenBot.addMessage('bot', serenBot.getMessage('welcome'));
            }, 1000);
        });
    </script>
</body>
</html>
